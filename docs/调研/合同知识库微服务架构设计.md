# 合同知识库微服务架构设计

> **创建日期**: 2025-10-23
> **版本**: v1.0
> **决策依据**: 多平台部署需求 + 合同智能体产品化战略

---

## 🎯 架构决策 (ADR)

### 为什么选择微服务而非集成方案？

**战略背景**:
1. **多平台部署需求**: 合同智能体需要在教育平台、小程序、独立应用等多个平台运行
2. **产品化潜力**: 合同分析能力做好后可作为独立产品对外销售
3. **技术栈差异**: 向量库最佳技术栈（Python + ML生态）与主平台（Next.js）不同
4. **独立演进**: 知识库功能迭代速度可能与主平台不同步

**主要矛盾识别**:
- **主要矛盾**: 单平台绑定 vs 多平台复用能力
- **次要矛盾**: 初期开发成本 vs 长期维护成本

**决策**: **创建独立微服务项目 `contract-knowledge-service`**

---

## 🏗️ 整体架构

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Client Applications                   │
├─────────────────────────────────────────────────────────┤
│  law-education-platform  │  wechat-mini  │  mobile-app │
└──────────────┬──────────────────┬──────────────┬────────┘
               │                  │              │
               └──────────────────┼──────────────┘
                                  ▼
                   ┌──────────────────────────┐
                   │   API Gateway (可选)     │
                   │   - 鉴权                 │
                   │   - 限流                 │
                   │   - 日志                 │
                   └──────────┬───────────────┘
                              ▼
            ┌─────────────────────────────────────┐
            │  Contract Knowledge Service         │
            │  (合同知识库服务)                    │
            ├─────────────────────────────────────┤
            │  Port: 8001                         │
            │  Framework: FastAPI (Python)        │
            │                                     │
            │  核心模块:                           │
            │  ├── Embedding Service              │
            │  ├── Vector Search Engine           │
            │  ├── Contract Repository            │
            │  ├── Clause Analyzer                │
            │  ├── Risk Detector                  │
            │  └── Term Dictionary                │
            └──────────┬─────────────────────────┘
                       │
         ┌─────────────┼─────────────┐
         ▼             ▼             ▼
    ┌────────┐   ┌──────────┐   ┌──────────┐
    │ChromaDB│   │PostgreSQL│   │  Redis   │
    │向量库  │   │元数据库  │   │  缓存    │
    └────────┘   └──────────┘   └──────────┘
```

---

## 📁 新项目结构

### 项目位置
建议在 `law-education-platform/` 同级创建新项目:

```
workspace/
├── law-education-platform/          # 主平台（Next.js）
└── contract-knowledge-service/      # 新微服务（Python）⭐
    ├── app/
    │   ├── api/                     # API路由层
    │   │   ├── v1/
    │   │   │   ├── contracts.py     # 合同相关API
    │   │   │   ├── clauses.py       # 条款API
    │   │   │   ├── terms.py         # 术语API
    │   │   │   └── risks.py         # 风险分析API
    │   │   └── dependencies.py      # 依赖注入
    │   │
    │   ├── core/                    # 核心业务逻辑
    │   │   ├── embedding.py         # Embedding生成
    │   │   ├── vector_search.py     # 向量检索
    │   │   └── similarity.py        # 相似度计算
    │   │
    │   ├── services/                # 领域服务
    │   │   ├── contract_service.py  # 合同服务
    │   │   ├── clause_service.py    # 条款服务
    │   │   ├── term_service.py      # 术语服务
    │   │   └── risk_service.py      # 风险服务
    │   │
    │   ├── repositories/            # 数据访问层
    │   │   ├── contract_repo.py     # 合同仓库
    │   │   ├── chroma_repo.py       # ChromaDB仓库
    │   │   └── pg_repo.py           # PostgreSQL仓库
    │   │
    │   ├── models/                  # 数据模型
    │   │   ├── contract.py          # 合同模型
    │   │   ├── clause.py            # 条款模型
    │   │   └── schemas.py           # Pydantic schemas
    │   │
    │   └── config/                  # 配置
    │       ├── settings.py          # 环境配置
    │       └── logging.py           # 日志配置
    │
    ├── scripts/                     # 脚本
    │   ├── import_contracts.py      # 数据导入
    │   ├── build_embeddings.py      # Embedding构建
    │   └── migrate_data.py          # 数据迁移
    │
    ├── tests/                       # 测试
    │   ├── unit/                    # 单元测试
    │   ├── integration/             # 集成测试
    │   └── e2e/                     # E2E测试
    │
    ├── docker/                      # Docker配置
    │   ├── Dockerfile               # 服务镜像
    │   ├── Dockerfile.chromadb      # ChromaDB镜像
    │   └── docker-compose.yml       # 本地开发环境
    │
    ├── docs/                        # 文档
    │   ├── API.md                   # API文档
    │   ├── DEPLOYMENT.md            # 部署文档
    │   └── DEVELOPMENT.md           # 开发指南
    │
    ├── pyproject.toml               # Python依赖
    ├── poetry.lock                  # 依赖锁定
    ├── .env.example                 # 环境变量示例
    └── README.md                    # 项目说明
```

---

## 🔌 API接口设计

### RESTful API规范

**Base URL**: `http://localhost:8001/api/v1`

#### 1. 合同检索 (Contracts)

```http
POST /api/v1/contracts/search
Content-Type: application/json
Authorization: Bearer {token}

{
  "query": "房屋租赁合同纠纷案例",
  "contractType": "租赁",        // 可选：合同类型过滤
  "topK": 5,                     // 返回前K个结果
  "minSimilarity": 0.7,          // 最小相似度阈值
  "filters": {                   // 元数据过滤
    "industry": "房地产",
    "source": "official",
    "quality.score": { "gte": 0.8 }
  }
}

Response 200:
{
  "success": true,
  "data": {
    "results": [
      {
        "contractId": "kb-contract-001",
        "similarity": 0.92,
        "contractType": "租赁",
        "summary": "住宅房屋租赁合同示范文本",
        "metadata": {
          "source": "国家市场监管总局",
          "industry": "房地产",
          "wordCount": 3500,
          "clauseCount": 18
        },
        "highlightedClauses": [
          {
            "clauseId": "clause-001-05",
            "category": "租赁期限",
            "content": "租赁期限自2023年1月1日起...",
            "relevance": 0.95
          }
        ]
      }
    ],
    "totalResults": 12,
    "queryTime": 0.15  // 秒
  },
  "requestId": "req-abc123"
}
```

#### 2. 条款智能分析 (Clauses)

```http
POST /api/v1/clauses/analyze
Content-Type: application/json

{
  "clauseText": "甲方应在合同签订后3日内支付全部款项...",
  "contractType": "买卖",
  "analysisType": ["classification", "risk", "improvement"]
}

Response 200:
{
  "success": true,
  "data": {
    "classification": {
      "category": "付款条款",
      "confidence": 0.95,
      "isEssential": true
    },
    "riskAnalysis": {
      "hasRisk": true,
      "riskLevel": "high",
      "risks": [
        {
          "type": "时效性风险",
          "description": "3日期限过短，实际履行困难",
          "suggestion": "建议调整为7-15个工作日"
        }
      ],
      "similarCases": [
        {
          "caseId": "risk-case-042",
          "summary": "买卖合同付款期限纠纷",
          "judgment": "原告胜诉，合同被认定为不合理"
        }
      ]
    },
    "improvement": {
      "currentQuality": 0.6,
      "improvedVersion": "甲方应在合同签订后十个工作日内支付全部款项，逾期按日利率0.05%支付违约金。",
      "improvements": [
        "明确工作日而非自然日",
        "增加违约责任条款",
        "数字改为大写增强法律效力"
      ]
    },
    "similarClauses": [
      {
        "clauseId": "kb-clause-158",
        "similarity": 0.88,
        "content": "...",
        "source": "国家市场监管总局示范文本"
      }
    ]
  }
}
```

#### 3. 法律术语查询 (Terms)

```http
GET /api/v1/terms/{term_name}

Response 200:
{
  "success": true,
  "data": {
    "term": "不可抗力",
    "aliases": ["force majeure", "不能抗力"],
    "definition": "指不能预见、不能避免且不能克服的客观情况。",
    "laypersonDefinition": "就是突发的、无法控制的意外事件，如地震、战争等。",
    "legalBasis": [
      {
        "law": "民法典",
        "article": "第180条",
        "content": "因不可抗力不能履行民事义务的，不承担民事责任..."
      }
    ],
    "typicalWording": [
      "因不可抗力导致合同无法履行的，双方互不承担责任",
      "遇到不可抗力事件，应在24小时内通知对方"
    ],
    "risks": [
      {
        "type": "举证责任",
        "description": "主张不可抗力的一方需承担举证责任",
        "avoidance": "保留相关证据（如气象证明、政府公告等）"
      }
    ],
    "relatedClauses": ["违约责任", "合同解除"],
    "frequency": 356,  // 在知识库中出现次数
    "importance": "high"
  }
}
```

#### 4. 批量Embedding生成

```http
POST /api/v1/embeddings/batch
Content-Type: application/json

{
  "texts": [
    "甲方应在合同签订后3日内支付全部款项",
    "乙方收到款项后应开具发票"
  ],
  "model": "text-embedding-3-small"  // 可选
}

Response 200:
{
  "success": true,
  "data": {
    "embeddings": [
      [0.123, -0.456, 0.789, ...],  // 1536维向量
      [0.234, -0.567, 0.890, ...]
    ],
    "model": "text-embedding-3-small",
    "dimensions": 1536,
    "usage": {
      "totalTokens": 42
    }
  }
}
```

#### 5. 健康检查

```http
GET /api/v1/health

Response 200:
{
  "status": "healthy",
  "services": {
    "chromadb": "up",
    "postgresql": "up",
    "redis": "up"
  },
  "version": "1.0.0",
  "uptime": 86400
}
```

---

## 🔐 认证和授权

### API Key认证

**请求头格式**:
```http
Authorization: Bearer kb_prod_a1b2c3d4e5f6g7h8
```

**生成方式**:
```python
# 在主平台生成API Key
import secrets

api_key = f"kb_{env}_{secrets.token_urlsafe(32)}"
# 存储在PostgreSQL，关联到用户/组织
```

**权限级别**:
- `read`: 只读查询（搜索、分析）
- `write`: 可写入数据（管理员）
- `admin`: 完全控制（数据导入、配置修改）

---

## 🐳 部署方案

### Docker Compose本地开发

```yaml
# docker-compose.yml
version: '3.8'

services:
  # 主服务
  kb-service:
    build:
      context: .
      dockerfile: docker/Dockerfile
    ports:
      - "8001:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=postgresql://kb_user:kb_pass@postgres:5432/kb_db
      - CHROMADB_HOST=chromadb
      - REDIS_URL=redis://redis:6379/0
      - LOG_LEVEL=INFO
    depends_on:
      - postgres
      - chromadb
      - redis
    volumes:
      - ./app:/app
      - ./data:/data
    networks:
      - kb-network

  # 向量数据库
  chromadb:
    image: chromadb/chroma:0.4.15
    ports:
      - "8000:8000"
    volumes:
      - chromadb-data:/chroma/chroma
    environment:
      - ANONYMIZED_TELEMETRY=False
      - ALLOW_RESET=True
    networks:
      - kb-network

  # 元数据库
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=kb_user
      - POSTGRES_PASSWORD=kb_pass
      - POSTGRES_DB=kb_db
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - kb-network

  # 缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - kb-network

volumes:
  chromadb-data:
  postgres-data:
  redis-data:

networks:
  kb-network:
    driver: bridge
```

### 生产部署（云服务）

**推荐方案**:
1. **计算**: 阿里云ECS / AWS EC2（2核4G起步）
2. **ChromaDB**: 独立部署（可使用托管服务 Chroma Cloud）
3. **PostgreSQL**: 阿里云RDS / AWS RDS
4. **Redis**: 阿里云Redis / AWS ElastiCache
5. **负载均衡**: Nginx / 云服务LB

**成本估算（月）**:
- ECS 2核4G: ¥200
- RDS PostgreSQL: ¥150
- Redis 2G: ¥100
- ChromaDB托管（可选）: $49 (~¥350)
- **总计**: ¥450-800/月

---

## 🔄 主平台集成方案

### Next.js集成客户端

在主平台创建客户端SDK:

```typescript
// lib/services/kb-client/index.ts
export class ContractKnowledgeClient {
  private baseURL: string;
  private apiKey: string;

  constructor(config: { baseURL: string; apiKey: string }) {
    this.baseURL = config.baseURL;
    this.apiKey = config.apiKey;
  }

  /**
   * 搜索相似合同
   */
  async searchContracts(params: {
    query: string;
    contractType?: string;
    topK?: number;
    filters?: Record<string, any>;
  }): Promise<SearchResult> {
    const response = await fetch(`${this.baseURL}/api/v1/contracts/search`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.apiKey}`,
      },
      body: JSON.stringify(params),
    });

    if (!response.ok) {
      throw new Error(`KB Service Error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.data;
  }

  /**
   * 分析条款
   */
  async analyzeClauses(params: {
    clauseText: string;
    contractType: string;
    analysisType: string[];
  }): Promise<ClauseAnalysisResult> {
    // ...类似实现
  }

  /**
   * 查询法律术语
   */
  async getTerm(termName: string): Promise<LegalTerm> {
    const response = await fetch(
      `${this.baseURL}/api/v1/terms/${encodeURIComponent(termName)}`,
      {
        headers: {
          'Authorization': `Bearer ${this.apiKey}`,
        },
      }
    );

    if (!response.ok) {
      throw new Error(`Term not found: ${termName}`);
    }

    const data = await response.json();
    return data.data;
  }
}

// 使用示例
const kbClient = new ContractKnowledgeClient({
  baseURL: process.env.KB_SERVICE_URL!,
  apiKey: process.env.KB_API_KEY!,
});

export default kbClient;
```

### 在现有服务中使用

```typescript
// src/domains/contract-analysis/services/KnowledgeEnhancedParsingService.ts
import kbClient from '@/lib/services/kb-client';

export class KnowledgeEnhancedParsingService {
  private baseService: ContractParsingService;

  async parseContract(contractText: string, useKnowledge = true): Promise<ParsedContract> {
    // 1. 基础解析（保持向后兼容）
    const baseResult = await this.baseService.parseContract(contractText);

    // 2. 如果不使用知识增强，直接返回
    if (!useKnowledge) return baseResult;

    try {
      // 3. 调用知识库服务获取相似合同
      const similarContracts = await kbClient.searchContracts({
        query: contractText.substring(0, 1000),
        contractType: baseResult.metadata.contractType,
        topK: 3,
        filters: {
          'quality.score': { gte: 0.8 }
        }
      });

      // 4. 使用知识库结果改进条款分类
      const enhancedClauses = await this.improveClauseClassification(
        baseResult.clauses,
        similarContracts.results
      );

      // 5. 返回增强结果
      return {
        ...baseResult,
        clauses: enhancedClauses,
        metadata: {
          ...baseResult.metadata,
          knowledgeEnhanced: true,
          similarContractsCount: similarContracts.totalResults,
        }
      };
    } catch (error) {
      // 6. 降级处理：知识库服务不可用时返回基础结果
      console.error('Knowledge enhancement failed:', error);
      return baseResult;
    }
  }
}
```

---

## 📊 技术栈选择

### 后端框架：FastAPI (Python)

**为什么选Python**:
- ✅ ML生态成熟（LangChain、ChromaDB、Sentence Transformers）
- ✅ Embedding库丰富（OpenAI SDK、Hugging Face）
- ✅ 科学计算性能强（NumPy、Pandas）
- ✅ 团队可能已熟悉（数据处理、NLP）

**为什么选FastAPI**:
- ✅ 性能优异（基于Starlette，接近Node.js）
- ✅ 自动生成OpenAPI文档（Swagger UI）
- ✅ 类型安全（Pydantic数据验证）
- ✅ 异步支持（async/await）

**依赖清单** (pyproject.toml):
```toml
[tool.poetry.dependencies]
python = "^3.11"
fastapi = "^0.104.0"
uvicorn = "^0.24.0"
pydantic = "^2.5.0"
chromadb = "^0.4.15"
openai = "^1.3.0"
sqlalchemy = "^2.0.0"
psycopg2-binary = "^2.9.0"
redis = "^5.0.0"
numpy = "^1.26.0"
pandas = "^2.1.0"
python-dotenv = "^1.0.0"

[tool.poetry.dev-dependencies]
pytest = "^7.4.0"
pytest-asyncio = "^0.21.0"
httpx = "^0.25.0"  # 用于测试API
black = "^23.11.0"  # 代码格式化
mypy = "^1.7.0"     # 类型检查
```

---

## 🚀 开发流程

### 第一阶段：搭建基础框架（1-2周）

**任务清单**:
- [ ] 创建项目骨架（FastAPI + Docker）
- [ ] 配置ChromaDB本地环境
- [ ] 实现基础API（health check + contracts search）
- [ ] 编写客户端SDK（TypeScript）
- [ ] 主平台集成测试

**验收标准**:
- 主平台能通过客户端SDK调用知识库服务
- Docker Compose一键启动完整环境
- 基础API有单元测试覆盖

### 第二阶段：数据导入和Embedding构建（2-3周）

**任务清单**:
- [ ] 从国家市场监管总局下载350份合同
- [ ] 编写数据清洗脚本
- [ ] 使用OpenAI API生成Embeddings
- [ ] 导入ChromaDB（Layer 1: 合同文档）
- [ ] 导入PostgreSQL（元数据）

**验收标准**:
- 350份合同完整导入
- 向量检索性能测试通过（<200ms）
- 相似度搜索准确率验证（人工抽检50个query）

### 第三阶段：条款和术语层（3-4周）

**任务清单**:
- [ ] 提取2100个条款片段（Layer 2）
- [ ] 构建500个法律术语词典（Layer 3）
- [ ] 实现条款智能分析API
- [ ] 实现术语查询API
- [ ] 风险案例导入（Layer 4，50个案例）

**验收标准**:
- 条款分类准确率 >85%
- 术语查询响应时间 <50ms（有缓存）
- 风险检测召回率 >80%

### 第四阶段：生产优化和部署（2周）

**任务清单**:
- [ ] 性能优化（缓存策略、批量查询）
- [ ] 安全加固（API Key管理、限流）
- [ ] 监控和日志（Prometheus + Grafana）
- [ ] 生产环境部署（Docker Swarm / Kubernetes）
- [ ] 负载测试（1000 QPS目标）

**验收标准**:
- 99.9%可用性（uptime）
- P95延迟 <500ms
- 成本控制在预算内（¥800/月）

---

## 📈 成本和性能预估

### Embedding生成成本

**OpenAI text-embedding-3-small定价**: $0.02 / 1M tokens

**数据规模**:
- Layer 1: 350份合同 × 3000字 = 105万字 ≈ 150万tokens
- Layer 2: 2100个条款 × 200字 = 42万字 ≈ 60万tokens
- Layer 4: 50个案例 × 1000字 = 5万字 ≈ 7万tokens
- **总计**: 217万tokens

**一次性成本**: 217万 / 100万 × $0.02 = **$0.043** (~¥0.31)

**持续成本**（用户查询）:
- 假设每天1000次查询，平均每次100 tokens
- 月tokens: 1000 × 100 × 30 = 300万tokens
- 月成本: 300万 / 100万 × $0.02 = **$0.06** (~¥0.43/月)

**总成本**: 非常低，可忽略不计 ✅

### 向量检索性能

**ChromaDB性能基准**（官方数据）:
- 索引大小: 100万向量（1536维）
- 查询延迟: 10-50ms (topK=10)
- 吞吐量: 1000+ QPS（单机）

**我们的规模**:
- Layer 1 + Layer 2 + Layer 4 = 350 + 2100 + 50 = **2500个向量**
- 预计查询延迟: **<10ms** ✅
- 单机即可支撑 1000+ QPS

---

## 🔍 监控和可观测性

### 关键指标

**业务指标**:
- 查询QPS（每秒查询数）
- 平均响应时间（P50, P95, P99）
- 相似度分布（了解查询质量）
- 缓存命中率

**技术指标**:
- ChromaDB连接池状态
- PostgreSQL查询慢日志
- Redis内存使用率
- API错误率（4xx, 5xx）

**成本指标**:
- OpenAI API调用次数
- Token消耗量
- 服务器资源使用率

### 日志规范

```python
import logging
import json

logger = logging.getLogger(__name__)

# 结构化日志示例
logger.info(json.dumps({
    "event": "contract_search",
    "query": "房屋租赁合同",
    "results_count": 5,
    "query_time_ms": 45,
    "user_id": "user_123",
    "request_id": "req_abc123"
}))
```

---

## 🧪 测试策略

### 测试金字塔

```
         ┌─────────────┐
         │  E2E Tests  │  ← 10%（关键业务流程）
         └─────────────┘
       ┌─────────────────┐
       │Integration Tests│  ← 30%（API + DB交互）
       └─────────────────┘
    ┌───────────────────────┐
    │    Unit Tests         │  ← 60%（业务逻辑）
    └───────────────────────┘
```

### 核心测试用例

**Unit Tests**:
```python
def test_embedding_service():
    """测试Embedding生成"""
    service = EmbeddingService()
    result = service.generate("测试文本")
    assert len(result) == 1536
    assert all(isinstance(x, float) for x in result)

def test_similarity_calculation():
    """测试相似度计算"""
    vec1 = [0.1, 0.2, 0.3]
    vec2 = [0.1, 0.2, 0.3]
    similarity = cosine_similarity(vec1, vec2)
    assert similarity == 1.0
```

**Integration Tests**:
```python
@pytest.mark.asyncio
async def test_contract_search_api(client):
    """测试合同搜索API"""
    response = await client.post("/api/v1/contracts/search", json={
        "query": "房屋租赁合同",
        "topK": 5
    })
    assert response.status_code == 200
    data = response.json()
    assert data["success"] is True
    assert len(data["data"]["results"]) <= 5
```

**E2E Tests**:
```python
def test_full_contract_analysis_flow():
    """端到端测试：从上传合同到风险分析"""
    # 1. 上传合同
    # 2. 调用知识库搜索相似合同
    # 3. 分析条款风险
    # 4. 验证结果完整性
    pass
```

---

## 🎓 团队协作

### 技能要求

**后端开发**（Python）:
- FastAPI框架经验
- 向量数据库使用（ChromaDB/Milvus）
- PostgreSQL熟悉
- Docker部署经验

**前端集成**（TypeScript）:
- 客户端SDK开发
- API调用和错误处理
- TypeScript类型定义

**数据处理**:
- 合同文本清洗
- Embedding生成
- 数据质量控制

### 任务分工建议

- **Person A**: 后端API开发（FastAPI + ChromaDB）
- **Person B**: 数据处理和导入（Python脚本）
- **Person C**: 前端集成和测试（TypeScript SDK）
- **Person D**: 运维和部署（Docker + 监控）

---

## 📚 参考资料

### 官方文档
- [FastAPI文档](https://fastapi.tiangolo.com/)
- [ChromaDB文档](https://docs.trychroma.com/)
- [OpenAI Embeddings Guide](https://platform.openai.com/docs/guides/embeddings)

### 开源项目参考
- [Chroma官方示例](https://github.com/chroma-core/chroma)
- [FastAPI最佳实践](https://github.com/zhanymkanov/fastapi-best-practices)
- [LangChain合同分析案例](https://github.com/langchain-ai/langchain)

---

## 📝 下一步行动

1. **立即行动** (本周):
   - [ ] 创建 `contract-knowledge-service` 项目骨架
   - [ ] 配置Docker开发环境
   - [ ] 实现第一个API（health check）

2. **短期目标** (2周内):
   - [ ] 完成基础API（搜索 + 分析）
   - [ ] 主平台集成测试通过
   - [ ] 导入第一批50份合同

3. **中期目标** (1个月内):
   - [ ] 350份合同全部导入
   - [ ] 条款和术语层完成
   - [ ] 性能优化到生产标准

4. **长期目标** (3个月内):
   - [ ] 生产环境稳定运行
   - [ ] 多平台集成（小程序、App）
   - [ ] 探索商业化可能性

---

**文档版本**: v1.0
**最后更新**: 2025-10-23
**维护者**: 项目团队 + Sean
