# åˆåŒçŸ¥è¯†åº“å¾®æœåŠ¡æ¶æ„è®¾è®¡

> **åˆ›å»ºæ—¥æœŸ**: 2025-10-23
> **ç‰ˆæœ¬**: v1.0
> **å†³ç­–ä¾æ®**: å¤šå¹³å°éƒ¨ç½²éœ€æ±‚ + åˆåŒæ™ºèƒ½ä½“äº§å“åŒ–æˆ˜ç•¥

---

## ğŸ¯ æ¶æ„å†³ç­– (ADR)

### ä¸ºä»€ä¹ˆé€‰æ‹©å¾®æœåŠ¡è€Œéé›†æˆæ–¹æ¡ˆï¼Ÿ

**æˆ˜ç•¥èƒŒæ™¯**:
1. **å¤šå¹³å°éƒ¨ç½²éœ€æ±‚**: åˆåŒæ™ºèƒ½ä½“éœ€è¦åœ¨æ•™è‚²å¹³å°ã€å°ç¨‹åºã€ç‹¬ç«‹åº”ç”¨ç­‰å¤šä¸ªå¹³å°è¿è¡Œ
2. **äº§å“åŒ–æ½œåŠ›**: åˆåŒåˆ†æèƒ½åŠ›åšå¥½åå¯ä½œä¸ºç‹¬ç«‹äº§å“å¯¹å¤–é”€å”®
3. **æŠ€æœ¯æ ˆå·®å¼‚**: å‘é‡åº“æœ€ä½³æŠ€æœ¯æ ˆï¼ˆPython + MLç”Ÿæ€ï¼‰ä¸ä¸»å¹³å°ï¼ˆNext.jsï¼‰ä¸åŒ
4. **ç‹¬ç«‹æ¼”è¿›**: çŸ¥è¯†åº“åŠŸèƒ½è¿­ä»£é€Ÿåº¦å¯èƒ½ä¸ä¸»å¹³å°ä¸åŒæ­¥

**ä¸»è¦çŸ›ç›¾è¯†åˆ«**:
- **ä¸»è¦çŸ›ç›¾**: å•å¹³å°ç»‘å®š vs å¤šå¹³å°å¤ç”¨èƒ½åŠ›
- **æ¬¡è¦çŸ›ç›¾**: åˆæœŸå¼€å‘æˆæœ¬ vs é•¿æœŸç»´æŠ¤æˆæœ¬

**å†³ç­–**: **åˆ›å»ºç‹¬ç«‹å¾®æœåŠ¡é¡¹ç›® `contract-knowledge-service`**

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Applications                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  law-education-platform  â”‚  wechat-mini  â”‚  mobile-app â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                  â”‚              â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   API Gateway (å¯é€‰)     â”‚
                   â”‚   - é‰´æƒ                 â”‚
                   â”‚   - é™æµ                 â”‚
                   â”‚   - æ—¥å¿—                 â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Contract Knowledge Service         â”‚
            â”‚  (åˆåŒçŸ¥è¯†åº“æœåŠ¡)                    â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  Port: 8001                         â”‚
            â”‚  Framework: FastAPI (Python)        â”‚
            â”‚                                     â”‚
            â”‚  æ ¸å¿ƒæ¨¡å—:                           â”‚
            â”‚  â”œâ”€â”€ Embedding Service              â”‚
            â”‚  â”œâ”€â”€ Vector Search Engine           â”‚
            â”‚  â”œâ”€â”€ Contract Repository            â”‚
            â”‚  â”œâ”€â”€ Clause Analyzer                â”‚
            â”‚  â”œâ”€â”€ Risk Detector                  â”‚
            â”‚  â””â”€â”€ Term Dictionary                â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼             â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ChromaDBâ”‚   â”‚PostgreSQLâ”‚   â”‚  Redis   â”‚
    â”‚å‘é‡åº“  â”‚   â”‚å…ƒæ•°æ®åº“  â”‚   â”‚  ç¼“å­˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–°é¡¹ç›®ç»“æ„

### é¡¹ç›®ä½ç½®
å»ºè®®åœ¨ `law-education-platform/` åŒçº§åˆ›å»ºæ–°é¡¹ç›®:

```
workspace/
â”œâ”€â”€ law-education-platform/          # ä¸»å¹³å°ï¼ˆNext.jsï¼‰
â””â”€â”€ contract-knowledge-service/      # æ–°å¾®æœåŠ¡ï¼ˆPythonï¼‰â­
    â”œâ”€â”€ app/
    â”‚   â”œâ”€â”€ api/                     # APIè·¯ç”±å±‚
    â”‚   â”‚   â”œâ”€â”€ v1/
    â”‚   â”‚   â”‚   â”œâ”€â”€ contracts.py     # åˆåŒç›¸å…³API
    â”‚   â”‚   â”‚   â”œâ”€â”€ clauses.py       # æ¡æ¬¾API
    â”‚   â”‚   â”‚   â”œâ”€â”€ terms.py         # æœ¯è¯­API
    â”‚   â”‚   â”‚   â””â”€â”€ risks.py         # é£é™©åˆ†æAPI
    â”‚   â”‚   â””â”€â”€ dependencies.py      # ä¾èµ–æ³¨å…¥
    â”‚   â”‚
    â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    â”‚   â”‚   â”œâ”€â”€ embedding.py         # Embeddingç”Ÿæˆ
    â”‚   â”‚   â”œâ”€â”€ vector_search.py     # å‘é‡æ£€ç´¢
    â”‚   â”‚   â””â”€â”€ similarity.py        # ç›¸ä¼¼åº¦è®¡ç®—
    â”‚   â”‚
    â”‚   â”œâ”€â”€ services/                # é¢†åŸŸæœåŠ¡
    â”‚   â”‚   â”œâ”€â”€ contract_service.py  # åˆåŒæœåŠ¡
    â”‚   â”‚   â”œâ”€â”€ clause_service.py    # æ¡æ¬¾æœåŠ¡
    â”‚   â”‚   â”œâ”€â”€ term_service.py      # æœ¯è¯­æœåŠ¡
    â”‚   â”‚   â””â”€â”€ risk_service.py      # é£é™©æœåŠ¡
    â”‚   â”‚
    â”‚   â”œâ”€â”€ repositories/            # æ•°æ®è®¿é—®å±‚
    â”‚   â”‚   â”œâ”€â”€ contract_repo.py     # åˆåŒä»“åº“
    â”‚   â”‚   â”œâ”€â”€ chroma_repo.py       # ChromaDBä»“åº“
    â”‚   â”‚   â””â”€â”€ pg_repo.py           # PostgreSQLä»“åº“
    â”‚   â”‚
    â”‚   â”œâ”€â”€ models/                  # æ•°æ®æ¨¡å‹
    â”‚   â”‚   â”œâ”€â”€ contract.py          # åˆåŒæ¨¡å‹
    â”‚   â”‚   â”œâ”€â”€ clause.py            # æ¡æ¬¾æ¨¡å‹
    â”‚   â”‚   â””â”€â”€ schemas.py           # Pydantic schemas
    â”‚   â”‚
    â”‚   â””â”€â”€ config/                  # é…ç½®
    â”‚       â”œâ”€â”€ settings.py          # ç¯å¢ƒé…ç½®
    â”‚       â””â”€â”€ logging.py           # æ—¥å¿—é…ç½®
    â”‚
    â”œâ”€â”€ scripts/                     # è„šæœ¬
    â”‚   â”œâ”€â”€ import_contracts.py      # æ•°æ®å¯¼å…¥
    â”‚   â”œâ”€â”€ build_embeddings.py      # Embeddingæ„å»º
    â”‚   â””â”€â”€ migrate_data.py          # æ•°æ®è¿ç§»
    â”‚
    â”œâ”€â”€ tests/                       # æµ‹è¯•
    â”‚   â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
    â”‚   â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
    â”‚   â””â”€â”€ e2e/                     # E2Eæµ‹è¯•
    â”‚
    â”œâ”€â”€ docker/                      # Dockeré…ç½®
    â”‚   â”œâ”€â”€ Dockerfile               # æœåŠ¡é•œåƒ
    â”‚   â”œâ”€â”€ Dockerfile.chromadb      # ChromaDBé•œåƒ
    â”‚   â””â”€â”€ docker-compose.yml       # æœ¬åœ°å¼€å‘ç¯å¢ƒ
    â”‚
    â”œâ”€â”€ docs/                        # æ–‡æ¡£
    â”‚   â”œâ”€â”€ API.md                   # APIæ–‡æ¡£
    â”‚   â”œâ”€â”€ DEPLOYMENT.md            # éƒ¨ç½²æ–‡æ¡£
    â”‚   â””â”€â”€ DEVELOPMENT.md           # å¼€å‘æŒ‡å—
    â”‚
    â”œâ”€â”€ pyproject.toml               # Pythonä¾èµ–
    â”œâ”€â”€ poetry.lock                  # ä¾èµ–é”å®š
    â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹
    â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### RESTful APIè§„èŒƒ

**Base URL**: `http://localhost:8001/api/v1`

#### 1. åˆåŒæ£€ç´¢ (Contracts)

```http
POST /api/v1/contracts/search
Content-Type: application/json
Authorization: Bearer {token}

{
  "query": "æˆ¿å±‹ç§ŸèµåˆåŒçº çº·æ¡ˆä¾‹",
  "contractType": "ç§Ÿèµ",        // å¯é€‰ï¼šåˆåŒç±»å‹è¿‡æ»¤
  "topK": 5,                     // è¿”å›å‰Kä¸ªç»“æœ
  "minSimilarity": 0.7,          // æœ€å°ç›¸ä¼¼åº¦é˜ˆå€¼
  "filters": {                   // å…ƒæ•°æ®è¿‡æ»¤
    "industry": "æˆ¿åœ°äº§",
    "source": "official",
    "quality.score": { "gte": 0.8 }
  }
}

Response 200:
{
  "success": true,
  "data": {
    "results": [
      {
        "contractId": "kb-contract-001",
        "similarity": 0.92,
        "contractType": "ç§Ÿèµ",
        "summary": "ä½å®…æˆ¿å±‹ç§ŸèµåˆåŒç¤ºèŒƒæ–‡æœ¬",
        "metadata": {
          "source": "å›½å®¶å¸‚åœºç›‘ç®¡æ€»å±€",
          "industry": "æˆ¿åœ°äº§",
          "wordCount": 3500,
          "clauseCount": 18
        },
        "highlightedClauses": [
          {
            "clauseId": "clause-001-05",
            "category": "ç§ŸèµæœŸé™",
            "content": "ç§ŸèµæœŸé™è‡ª2023å¹´1æœˆ1æ—¥èµ·...",
            "relevance": 0.95
          }
        ]
      }
    ],
    "totalResults": 12,
    "queryTime": 0.15  // ç§’
  },
  "requestId": "req-abc123"
}
```

#### 2. æ¡æ¬¾æ™ºèƒ½åˆ†æ (Clauses)

```http
POST /api/v1/clauses/analyze
Content-Type: application/json

{
  "clauseText": "ç”²æ–¹åº”åœ¨åˆåŒç­¾è®¢å3æ—¥å†…æ”¯ä»˜å…¨éƒ¨æ¬¾é¡¹...",
  "contractType": "ä¹°å–",
  "analysisType": ["classification", "risk", "improvement"]
}

Response 200:
{
  "success": true,
  "data": {
    "classification": {
      "category": "ä»˜æ¬¾æ¡æ¬¾",
      "confidence": 0.95,
      "isEssential": true
    },
    "riskAnalysis": {
      "hasRisk": true,
      "riskLevel": "high",
      "risks": [
        {
          "type": "æ—¶æ•ˆæ€§é£é™©",
          "description": "3æ—¥æœŸé™è¿‡çŸ­ï¼Œå®é™…å±¥è¡Œå›°éš¾",
          "suggestion": "å»ºè®®è°ƒæ•´ä¸º7-15ä¸ªå·¥ä½œæ—¥"
        }
      ],
      "similarCases": [
        {
          "caseId": "risk-case-042",
          "summary": "ä¹°å–åˆåŒä»˜æ¬¾æœŸé™çº çº·",
          "judgment": "åŸå‘Šèƒœè¯‰ï¼ŒåˆåŒè¢«è®¤å®šä¸ºä¸åˆç†"
        }
      ]
    },
    "improvement": {
      "currentQuality": 0.6,
      "improvedVersion": "ç”²æ–¹åº”åœ¨åˆåŒç­¾è®¢ååä¸ªå·¥ä½œæ—¥å†…æ”¯ä»˜å…¨éƒ¨æ¬¾é¡¹ï¼Œé€¾æœŸæŒ‰æ—¥åˆ©ç‡0.05%æ”¯ä»˜è¿çº¦é‡‘ã€‚",
      "improvements": [
        "æ˜ç¡®å·¥ä½œæ—¥è€Œéè‡ªç„¶æ—¥",
        "å¢åŠ è¿çº¦è´£ä»»æ¡æ¬¾",
        "æ•°å­—æ”¹ä¸ºå¤§å†™å¢å¼ºæ³•å¾‹æ•ˆåŠ›"
      ]
    },
    "similarClauses": [
      {
        "clauseId": "kb-clause-158",
        "similarity": 0.88,
        "content": "...",
        "source": "å›½å®¶å¸‚åœºç›‘ç®¡æ€»å±€ç¤ºèŒƒæ–‡æœ¬"
      }
    ]
  }
}
```

#### 3. æ³•å¾‹æœ¯è¯­æŸ¥è¯¢ (Terms)

```http
GET /api/v1/terms/{term_name}

Response 200:
{
  "success": true,
  "data": {
    "term": "ä¸å¯æŠ—åŠ›",
    "aliases": ["force majeure", "ä¸èƒ½æŠ—åŠ›"],
    "definition": "æŒ‡ä¸èƒ½é¢„è§ã€ä¸èƒ½é¿å…ä¸”ä¸èƒ½å…‹æœçš„å®¢è§‚æƒ…å†µã€‚",
    "laypersonDefinition": "å°±æ˜¯çªå‘çš„ã€æ— æ³•æ§åˆ¶çš„æ„å¤–äº‹ä»¶ï¼Œå¦‚åœ°éœ‡ã€æˆ˜äº‰ç­‰ã€‚",
    "legalBasis": [
      {
        "law": "æ°‘æ³•å…¸",
        "article": "ç¬¬180æ¡",
        "content": "å› ä¸å¯æŠ—åŠ›ä¸èƒ½å±¥è¡Œæ°‘äº‹ä¹‰åŠ¡çš„ï¼Œä¸æ‰¿æ‹…æ°‘äº‹è´£ä»»..."
      }
    ],
    "typicalWording": [
      "å› ä¸å¯æŠ—åŠ›å¯¼è‡´åˆåŒæ— æ³•å±¥è¡Œçš„ï¼ŒåŒæ–¹äº’ä¸æ‰¿æ‹…è´£ä»»",
      "é‡åˆ°ä¸å¯æŠ—åŠ›äº‹ä»¶ï¼Œåº”åœ¨24å°æ—¶å†…é€šçŸ¥å¯¹æ–¹"
    ],
    "risks": [
      {
        "type": "ä¸¾è¯è´£ä»»",
        "description": "ä¸»å¼ ä¸å¯æŠ—åŠ›çš„ä¸€æ–¹éœ€æ‰¿æ‹…ä¸¾è¯è´£ä»»",
        "avoidance": "ä¿ç•™ç›¸å…³è¯æ®ï¼ˆå¦‚æ°”è±¡è¯æ˜ã€æ”¿åºœå…¬å‘Šç­‰ï¼‰"
      }
    ],
    "relatedClauses": ["è¿çº¦è´£ä»»", "åˆåŒè§£é™¤"],
    "frequency": 356,  // åœ¨çŸ¥è¯†åº“ä¸­å‡ºç°æ¬¡æ•°
    "importance": "high"
  }
}
```

#### 4. æ‰¹é‡Embeddingç”Ÿæˆ

```http
POST /api/v1/embeddings/batch
Content-Type: application/json

{
  "texts": [
    "ç”²æ–¹åº”åœ¨åˆåŒç­¾è®¢å3æ—¥å†…æ”¯ä»˜å…¨éƒ¨æ¬¾é¡¹",
    "ä¹™æ–¹æ”¶åˆ°æ¬¾é¡¹ååº”å¼€å…·å‘ç¥¨"
  ],
  "model": "text-embedding-3-small"  // å¯é€‰
}

Response 200:
{
  "success": true,
  "data": {
    "embeddings": [
      [0.123, -0.456, 0.789, ...],  // 1536ç»´å‘é‡
      [0.234, -0.567, 0.890, ...]
    ],
    "model": "text-embedding-3-small",
    "dimensions": 1536,
    "usage": {
      "totalTokens": 42
    }
  }
}
```

#### 5. å¥åº·æ£€æŸ¥

```http
GET /api/v1/health

Response 200:
{
  "status": "healthy",
  "services": {
    "chromadb": "up",
    "postgresql": "up",
    "redis": "up"
  },
  "version": "1.0.0",
  "uptime": 86400
}
```

---

## ğŸ” è®¤è¯å’Œæˆæƒ

### API Keyè®¤è¯

**è¯·æ±‚å¤´æ ¼å¼**:
```http
Authorization: Bearer kb_prod_a1b2c3d4e5f6g7h8
```

**ç”Ÿæˆæ–¹å¼**:
```python
# åœ¨ä¸»å¹³å°ç”ŸæˆAPI Key
import secrets

api_key = f"kb_{env}_{secrets.token_urlsafe(32)}"
# å­˜å‚¨åœ¨PostgreSQLï¼Œå…³è”åˆ°ç”¨æˆ·/ç»„ç»‡
```

**æƒé™çº§åˆ«**:
- `read`: åªè¯»æŸ¥è¯¢ï¼ˆæœç´¢ã€åˆ†æï¼‰
- `write`: å¯å†™å…¥æ•°æ®ï¼ˆç®¡ç†å‘˜ï¼‰
- `admin`: å®Œå…¨æ§åˆ¶ï¼ˆæ•°æ®å¯¼å…¥ã€é…ç½®ä¿®æ”¹ï¼‰

---

## ğŸ³ éƒ¨ç½²æ–¹æ¡ˆ

### Docker Composeæœ¬åœ°å¼€å‘

```yaml
# docker-compose.yml
version: '3.8'

services:
  # ä¸»æœåŠ¡
  kb-service:
    build:
      context: .
      dockerfile: docker/Dockerfile
    ports:
      - "8001:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=postgresql://kb_user:kb_pass@postgres:5432/kb_db
      - CHROMADB_HOST=chromadb
      - REDIS_URL=redis://redis:6379/0
      - LOG_LEVEL=INFO
    depends_on:
      - postgres
      - chromadb
      - redis
    volumes:
      - ./app:/app
      - ./data:/data
    networks:
      - kb-network

  # å‘é‡æ•°æ®åº“
  chromadb:
    image: chromadb/chroma:0.4.15
    ports:
      - "8000:8000"
    volumes:
      - chromadb-data:/chroma/chroma
    environment:
      - ANONYMIZED_TELEMETRY=False
      - ALLOW_RESET=True
    networks:
      - kb-network

  # å…ƒæ•°æ®åº“
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=kb_user
      - POSTGRES_PASSWORD=kb_pass
      - POSTGRES_DB=kb_db
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - kb-network

  # ç¼“å­˜
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - kb-network

volumes:
  chromadb-data:
  postgres-data:
  redis-data:

networks:
  kb-network:
    driver: bridge
```

### ç”Ÿäº§éƒ¨ç½²ï¼ˆäº‘æœåŠ¡ï¼‰

**æ¨èæ–¹æ¡ˆ**:
1. **è®¡ç®—**: é˜¿é‡Œäº‘ECS / AWS EC2ï¼ˆ2æ ¸4Gèµ·æ­¥ï¼‰
2. **ChromaDB**: ç‹¬ç«‹éƒ¨ç½²ï¼ˆå¯ä½¿ç”¨æ‰˜ç®¡æœåŠ¡ Chroma Cloudï¼‰
3. **PostgreSQL**: é˜¿é‡Œäº‘RDS / AWS RDS
4. **Redis**: é˜¿é‡Œäº‘Redis / AWS ElastiCache
5. **è´Ÿè½½å‡è¡¡**: Nginx / äº‘æœåŠ¡LB

**æˆæœ¬ä¼°ç®—ï¼ˆæœˆï¼‰**:
- ECS 2æ ¸4G: Â¥200
- RDS PostgreSQL: Â¥150
- Redis 2G: Â¥100
- ChromaDBæ‰˜ç®¡ï¼ˆå¯é€‰ï¼‰: $49 (~Â¥350)
- **æ€»è®¡**: Â¥450-800/æœˆ

---

## ğŸ”„ ä¸»å¹³å°é›†æˆæ–¹æ¡ˆ

### Next.jsé›†æˆå®¢æˆ·ç«¯

åœ¨ä¸»å¹³å°åˆ›å»ºå®¢æˆ·ç«¯SDK:

```typescript
// lib/services/kb-client/index.ts
export class ContractKnowledgeClient {
  private baseURL: string;
  private apiKey: string;

  constructor(config: { baseURL: string; apiKey: string }) {
    this.baseURL = config.baseURL;
    this.apiKey = config.apiKey;
  }

  /**
   * æœç´¢ç›¸ä¼¼åˆåŒ
   */
  async searchContracts(params: {
    query: string;
    contractType?: string;
    topK?: number;
    filters?: Record<string, any>;
  }): Promise<SearchResult> {
    const response = await fetch(`${this.baseURL}/api/v1/contracts/search`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.apiKey}`,
      },
      body: JSON.stringify(params),
    });

    if (!response.ok) {
      throw new Error(`KB Service Error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.data;
  }

  /**
   * åˆ†ææ¡æ¬¾
   */
  async analyzeClauses(params: {
    clauseText: string;
    contractType: string;
    analysisType: string[];
  }): Promise<ClauseAnalysisResult> {
    // ...ç±»ä¼¼å®ç°
  }

  /**
   * æŸ¥è¯¢æ³•å¾‹æœ¯è¯­
   */
  async getTerm(termName: string): Promise<LegalTerm> {
    const response = await fetch(
      `${this.baseURL}/api/v1/terms/${encodeURIComponent(termName)}`,
      {
        headers: {
          'Authorization': `Bearer ${this.apiKey}`,
        },
      }
    );

    if (!response.ok) {
      throw new Error(`Term not found: ${termName}`);
    }

    const data = await response.json();
    return data.data;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const kbClient = new ContractKnowledgeClient({
  baseURL: process.env.KB_SERVICE_URL!,
  apiKey: process.env.KB_API_KEY!,
});

export default kbClient;
```

### åœ¨ç°æœ‰æœåŠ¡ä¸­ä½¿ç”¨

```typescript
// src/domains/contract-analysis/services/KnowledgeEnhancedParsingService.ts
import kbClient from '@/lib/services/kb-client';

export class KnowledgeEnhancedParsingService {
  private baseService: ContractParsingService;

  async parseContract(contractText: string, useKnowledge = true): Promise<ParsedContract> {
    // 1. åŸºç¡€è§£æï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
    const baseResult = await this.baseService.parseContract(contractText);

    // 2. å¦‚æœä¸ä½¿ç”¨çŸ¥è¯†å¢å¼ºï¼Œç›´æ¥è¿”å›
    if (!useKnowledge) return baseResult;

    try {
      // 3. è°ƒç”¨çŸ¥è¯†åº“æœåŠ¡è·å–ç›¸ä¼¼åˆåŒ
      const similarContracts = await kbClient.searchContracts({
        query: contractText.substring(0, 1000),
        contractType: baseResult.metadata.contractType,
        topK: 3,
        filters: {
          'quality.score': { gte: 0.8 }
        }
      });

      // 4. ä½¿ç”¨çŸ¥è¯†åº“ç»“æœæ”¹è¿›æ¡æ¬¾åˆ†ç±»
      const enhancedClauses = await this.improveClauseClassification(
        baseResult.clauses,
        similarContracts.results
      );

      // 5. è¿”å›å¢å¼ºç»“æœ
      return {
        ...baseResult,
        clauses: enhancedClauses,
        metadata: {
          ...baseResult.metadata,
          knowledgeEnhanced: true,
          similarContractsCount: similarContracts.totalResults,
        }
      };
    } catch (error) {
      // 6. é™çº§å¤„ç†ï¼šçŸ¥è¯†åº“æœåŠ¡ä¸å¯ç”¨æ—¶è¿”å›åŸºç¡€ç»“æœ
      console.error('Knowledge enhancement failed:', error);
      return baseResult;
    }
  }
}
```

---

## ğŸ“Š æŠ€æœ¯æ ˆé€‰æ‹©

### åç«¯æ¡†æ¶ï¼šFastAPI (Python)

**ä¸ºä»€ä¹ˆé€‰Python**:
- âœ… MLç”Ÿæ€æˆç†Ÿï¼ˆLangChainã€ChromaDBã€Sentence Transformersï¼‰
- âœ… Embeddingåº“ä¸°å¯Œï¼ˆOpenAI SDKã€Hugging Faceï¼‰
- âœ… ç§‘å­¦è®¡ç®—æ€§èƒ½å¼ºï¼ˆNumPyã€Pandasï¼‰
- âœ… å›¢é˜Ÿå¯èƒ½å·²ç†Ÿæ‚‰ï¼ˆæ•°æ®å¤„ç†ã€NLPï¼‰

**ä¸ºä»€ä¹ˆé€‰FastAPI**:
- âœ… æ€§èƒ½ä¼˜å¼‚ï¼ˆåŸºäºStarletteï¼Œæ¥è¿‘Node.jsï¼‰
- âœ… è‡ªåŠ¨ç”ŸæˆOpenAPIæ–‡æ¡£ï¼ˆSwagger UIï¼‰
- âœ… ç±»å‹å®‰å…¨ï¼ˆPydanticæ•°æ®éªŒè¯ï¼‰
- âœ… å¼‚æ­¥æ”¯æŒï¼ˆasync/awaitï¼‰

**ä¾èµ–æ¸…å•** (pyproject.toml):
```toml
[tool.poetry.dependencies]
python = "^3.11"
fastapi = "^0.104.0"
uvicorn = "^0.24.0"
pydantic = "^2.5.0"
chromadb = "^0.4.15"
openai = "^1.3.0"
sqlalchemy = "^2.0.0"
psycopg2-binary = "^2.9.0"
redis = "^5.0.0"
numpy = "^1.26.0"
pandas = "^2.1.0"
python-dotenv = "^1.0.0"

[tool.poetry.dev-dependencies]
pytest = "^7.4.0"
pytest-asyncio = "^0.21.0"
httpx = "^0.25.0"  # ç”¨äºæµ‹è¯•API
black = "^23.11.0"  # ä»£ç æ ¼å¼åŒ–
mypy = "^1.7.0"     # ç±»å‹æ£€æŸ¥
```

---

## ğŸš€ å¼€å‘æµç¨‹

### ç¬¬ä¸€é˜¶æ®µï¼šæ­å»ºåŸºç¡€æ¡†æ¶ï¼ˆ1-2å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»ºé¡¹ç›®éª¨æ¶ï¼ˆFastAPI + Dockerï¼‰
- [ ] é…ç½®ChromaDBæœ¬åœ°ç¯å¢ƒ
- [ ] å®ç°åŸºç¡€APIï¼ˆhealth check + contracts searchï¼‰
- [ ] ç¼–å†™å®¢æˆ·ç«¯SDKï¼ˆTypeScriptï¼‰
- [ ] ä¸»å¹³å°é›†æˆæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
- ä¸»å¹³å°èƒ½é€šè¿‡å®¢æˆ·ç«¯SDKè°ƒç”¨çŸ¥è¯†åº“æœåŠ¡
- Docker Composeä¸€é”®å¯åŠ¨å®Œæ•´ç¯å¢ƒ
- åŸºç¡€APIæœ‰å•å…ƒæµ‹è¯•è¦†ç›–

### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®å¯¼å…¥å’ŒEmbeddingæ„å»ºï¼ˆ2-3å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] ä»å›½å®¶å¸‚åœºç›‘ç®¡æ€»å±€ä¸‹è½½350ä»½åˆåŒ
- [ ] ç¼–å†™æ•°æ®æ¸…æ´—è„šæœ¬
- [ ] ä½¿ç”¨OpenAI APIç”ŸæˆEmbeddings
- [ ] å¯¼å…¥ChromaDBï¼ˆLayer 1: åˆåŒæ–‡æ¡£ï¼‰
- [ ] å¯¼å…¥PostgreSQLï¼ˆå…ƒæ•°æ®ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- 350ä»½åˆåŒå®Œæ•´å¯¼å…¥
- å‘é‡æ£€ç´¢æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼ˆ<200msï¼‰
- ç›¸ä¼¼åº¦æœç´¢å‡†ç¡®ç‡éªŒè¯ï¼ˆäººå·¥æŠ½æ£€50ä¸ªqueryï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼šæ¡æ¬¾å’Œæœ¯è¯­å±‚ï¼ˆ3-4å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] æå–2100ä¸ªæ¡æ¬¾ç‰‡æ®µï¼ˆLayer 2ï¼‰
- [ ] æ„å»º500ä¸ªæ³•å¾‹æœ¯è¯­è¯å…¸ï¼ˆLayer 3ï¼‰
- [ ] å®ç°æ¡æ¬¾æ™ºèƒ½åˆ†æAPI
- [ ] å®ç°æœ¯è¯­æŸ¥è¯¢API
- [ ] é£é™©æ¡ˆä¾‹å¯¼å…¥ï¼ˆLayer 4ï¼Œ50ä¸ªæ¡ˆä¾‹ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- æ¡æ¬¾åˆ†ç±»å‡†ç¡®ç‡ >85%
- æœ¯è¯­æŸ¥è¯¢å“åº”æ—¶é—´ <50msï¼ˆæœ‰ç¼“å­˜ï¼‰
- é£é™©æ£€æµ‹å¬å›ç‡ >80%

### ç¬¬å››é˜¶æ®µï¼šç”Ÿäº§ä¼˜åŒ–å’Œéƒ¨ç½²ï¼ˆ2å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ç­–ç•¥ã€æ‰¹é‡æŸ¥è¯¢ï¼‰
- [ ] å®‰å…¨åŠ å›ºï¼ˆAPI Keyç®¡ç†ã€é™æµï¼‰
- [ ] ç›‘æ§å’Œæ—¥å¿—ï¼ˆPrometheus + Grafanaï¼‰
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆDocker Swarm / Kubernetesï¼‰
- [ ] è´Ÿè½½æµ‹è¯•ï¼ˆ1000 QPSç›®æ ‡ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- 99.9%å¯ç”¨æ€§ï¼ˆuptimeï¼‰
- P95å»¶è¿Ÿ <500ms
- æˆæœ¬æ§åˆ¶åœ¨é¢„ç®—å†…ï¼ˆÂ¥800/æœˆï¼‰

---

## ğŸ“ˆ æˆæœ¬å’Œæ€§èƒ½é¢„ä¼°

### Embeddingç”Ÿæˆæˆæœ¬

**OpenAI text-embedding-3-smallå®šä»·**: $0.02 / 1M tokens

**æ•°æ®è§„æ¨¡**:
- Layer 1: 350ä»½åˆåŒ Ã— 3000å­— = 105ä¸‡å­— â‰ˆ 150ä¸‡tokens
- Layer 2: 2100ä¸ªæ¡æ¬¾ Ã— 200å­— = 42ä¸‡å­— â‰ˆ 60ä¸‡tokens
- Layer 4: 50ä¸ªæ¡ˆä¾‹ Ã— 1000å­— = 5ä¸‡å­— â‰ˆ 7ä¸‡tokens
- **æ€»è®¡**: 217ä¸‡tokens

**ä¸€æ¬¡æ€§æˆæœ¬**: 217ä¸‡ / 100ä¸‡ Ã— $0.02 = **$0.043** (~Â¥0.31)

**æŒç»­æˆæœ¬**ï¼ˆç”¨æˆ·æŸ¥è¯¢ï¼‰:
- å‡è®¾æ¯å¤©1000æ¬¡æŸ¥è¯¢ï¼Œå¹³å‡æ¯æ¬¡100 tokens
- æœˆtokens: 1000 Ã— 100 Ã— 30 = 300ä¸‡tokens
- æœˆæˆæœ¬: 300ä¸‡ / 100ä¸‡ Ã— $0.02 = **$0.06** (~Â¥0.43/æœˆ)

**æ€»æˆæœ¬**: éå¸¸ä½ï¼Œå¯å¿½ç•¥ä¸è®¡ âœ…

### å‘é‡æ£€ç´¢æ€§èƒ½

**ChromaDBæ€§èƒ½åŸºå‡†**ï¼ˆå®˜æ–¹æ•°æ®ï¼‰:
- ç´¢å¼•å¤§å°: 100ä¸‡å‘é‡ï¼ˆ1536ç»´ï¼‰
- æŸ¥è¯¢å»¶è¿Ÿ: 10-50ms (topK=10)
- ååé‡: 1000+ QPSï¼ˆå•æœºï¼‰

**æˆ‘ä»¬çš„è§„æ¨¡**:
- Layer 1 + Layer 2 + Layer 4 = 350 + 2100 + 50 = **2500ä¸ªå‘é‡**
- é¢„è®¡æŸ¥è¯¢å»¶è¿Ÿ: **<10ms** âœ…
- å•æœºå³å¯æ”¯æ’‘ 1000+ QPS

---

## ğŸ” ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### å…³é”®æŒ‡æ ‡

**ä¸šåŠ¡æŒ‡æ ‡**:
- æŸ¥è¯¢QPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰
- å¹³å‡å“åº”æ—¶é—´ï¼ˆP50, P95, P99ï¼‰
- ç›¸ä¼¼åº¦åˆ†å¸ƒï¼ˆäº†è§£æŸ¥è¯¢è´¨é‡ï¼‰
- ç¼“å­˜å‘½ä¸­ç‡

**æŠ€æœ¯æŒ‡æ ‡**:
- ChromaDBè¿æ¥æ± çŠ¶æ€
- PostgreSQLæŸ¥è¯¢æ…¢æ—¥å¿—
- Rediså†…å­˜ä½¿ç”¨ç‡
- APIé”™è¯¯ç‡ï¼ˆ4xx, 5xxï¼‰

**æˆæœ¬æŒ‡æ ‡**:
- OpenAI APIè°ƒç”¨æ¬¡æ•°
- Tokenæ¶ˆè€—é‡
- æœåŠ¡å™¨èµ„æºä½¿ç”¨ç‡

### æ—¥å¿—è§„èŒƒ

```python
import logging
import json

logger = logging.getLogger(__name__)

# ç»“æ„åŒ–æ—¥å¿—ç¤ºä¾‹
logger.info(json.dumps({
    "event": "contract_search",
    "query": "æˆ¿å±‹ç§ŸèµåˆåŒ",
    "results_count": 5,
    "query_time_ms": 45,
    "user_id": "user_123",
    "request_id": "req_abc123"
}))
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  E2E Tests  â”‚  â† 10%ï¼ˆå…³é”®ä¸šåŠ¡æµç¨‹ï¼‰
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚Integration Testsâ”‚  â† 30%ï¼ˆAPI + DBäº¤äº’ï¼‰
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Unit Tests         â”‚  â† 60%ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹

**Unit Tests**:
```python
def test_embedding_service():
    """æµ‹è¯•Embeddingç”Ÿæˆ"""
    service = EmbeddingService()
    result = service.generate("æµ‹è¯•æ–‡æœ¬")
    assert len(result) == 1536
    assert all(isinstance(x, float) for x in result)

def test_similarity_calculation():
    """æµ‹è¯•ç›¸ä¼¼åº¦è®¡ç®—"""
    vec1 = [0.1, 0.2, 0.3]
    vec2 = [0.1, 0.2, 0.3]
    similarity = cosine_similarity(vec1, vec2)
    assert similarity == 1.0
```

**Integration Tests**:
```python
@pytest.mark.asyncio
async def test_contract_search_api(client):
    """æµ‹è¯•åˆåŒæœç´¢API"""
    response = await client.post("/api/v1/contracts/search", json={
        "query": "æˆ¿å±‹ç§ŸèµåˆåŒ",
        "topK": 5
    })
    assert response.status_code == 200
    data = response.json()
    assert data["success"] is True
    assert len(data["data"]["results"]) <= 5
```

**E2E Tests**:
```python
def test_full_contract_analysis_flow():
    """ç«¯åˆ°ç«¯æµ‹è¯•ï¼šä»ä¸Šä¼ åˆåŒåˆ°é£é™©åˆ†æ"""
    # 1. ä¸Šä¼ åˆåŒ
    # 2. è°ƒç”¨çŸ¥è¯†åº“æœç´¢ç›¸ä¼¼åˆåŒ
    # 3. åˆ†ææ¡æ¬¾é£é™©
    # 4. éªŒè¯ç»“æœå®Œæ•´æ€§
    pass
```

---

## ğŸ“ å›¢é˜Ÿåä½œ

### æŠ€èƒ½è¦æ±‚

**åç«¯å¼€å‘**ï¼ˆPythonï¼‰:
- FastAPIæ¡†æ¶ç»éªŒ
- å‘é‡æ•°æ®åº“ä½¿ç”¨ï¼ˆChromaDB/Milvusï¼‰
- PostgreSQLç†Ÿæ‚‰
- Dockeréƒ¨ç½²ç»éªŒ

**å‰ç«¯é›†æˆ**ï¼ˆTypeScriptï¼‰:
- å®¢æˆ·ç«¯SDKå¼€å‘
- APIè°ƒç”¨å’Œé”™è¯¯å¤„ç†
- TypeScriptç±»å‹å®šä¹‰

**æ•°æ®å¤„ç†**:
- åˆåŒæ–‡æœ¬æ¸…æ´—
- Embeddingç”Ÿæˆ
- æ•°æ®è´¨é‡æ§åˆ¶

### ä»»åŠ¡åˆ†å·¥å»ºè®®

- **Person A**: åç«¯APIå¼€å‘ï¼ˆFastAPI + ChromaDBï¼‰
- **Person B**: æ•°æ®å¤„ç†å’Œå¯¼å…¥ï¼ˆPythonè„šæœ¬ï¼‰
- **Person C**: å‰ç«¯é›†æˆå’Œæµ‹è¯•ï¼ˆTypeScript SDKï¼‰
- **Person D**: è¿ç»´å’Œéƒ¨ç½²ï¼ˆDocker + ç›‘æ§ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)
- [ChromaDBæ–‡æ¡£](https://docs.trychroma.com/)
- [OpenAI Embeddings Guide](https://platform.openai.com/docs/guides/embeddings)

### å¼€æºé¡¹ç›®å‚è€ƒ
- [Chromaå®˜æ–¹ç¤ºä¾‹](https://github.com/chroma-core/chroma)
- [FastAPIæœ€ä½³å®è·µ](https://github.com/zhanymkanov/fastapi-best-practices)
- [LangChainåˆåŒåˆ†ææ¡ˆä¾‹](https://github.com/langchain-ai/langchain)

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³è¡ŒåŠ¨** (æœ¬å‘¨):
   - [ ] åˆ›å»º `contract-knowledge-service` é¡¹ç›®éª¨æ¶
   - [ ] é…ç½®Dockerå¼€å‘ç¯å¢ƒ
   - [ ] å®ç°ç¬¬ä¸€ä¸ªAPIï¼ˆhealth checkï¼‰

2. **çŸ­æœŸç›®æ ‡** (2å‘¨å†…):
   - [ ] å®ŒæˆåŸºç¡€APIï¼ˆæœç´¢ + åˆ†æï¼‰
   - [ ] ä¸»å¹³å°é›†æˆæµ‹è¯•é€šè¿‡
   - [ ] å¯¼å…¥ç¬¬ä¸€æ‰¹50ä»½åˆåŒ

3. **ä¸­æœŸç›®æ ‡** (1ä¸ªæœˆå†…):
   - [ ] 350ä»½åˆåŒå…¨éƒ¨å¯¼å…¥
   - [ ] æ¡æ¬¾å’Œæœ¯è¯­å±‚å®Œæˆ
   - [ ] æ€§èƒ½ä¼˜åŒ–åˆ°ç”Ÿäº§æ ‡å‡†

4. **é•¿æœŸç›®æ ‡** (3ä¸ªæœˆå†…):
   - [ ] ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œ
   - [ ] å¤šå¹³å°é›†æˆï¼ˆå°ç¨‹åºã€Appï¼‰
   - [ ] æ¢ç´¢å•†ä¸šåŒ–å¯èƒ½æ€§

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-23
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ + Sean
