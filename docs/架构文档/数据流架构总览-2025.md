# 法学教育平台 - 数据流架构总览（2025版）

> **文档版本**: v3.0
> **更新日期**: 2025-10-21
> **状态**: ✅ 架构稳定期 - 生产环境运行中

---

## 📋 快速导航

- [核心架构概览](#核心架构概览)
- [数据库Schema V2](#数据库schema-v2)
- [四幕数据流详解](#四幕数据流详解)
- [状态管理架构](#状态管理架构)
- [数据持久化机制](#数据持久化机制)
- [关键代码位置](#关键代码位置)

---

## 核心架构概览

### 🏗️ 三层架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                     用户界面层 (UI Layer)                      │
│  React 19 + Next.js 15 + Tailwind CSS                        │
│  四幕教学组件 + 苏格拉底对话界面                               │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                  状态管理层 (State Layer)                      │
│  Zustand + immer + persist                                   │
│  ├─ useTeachingStore (四幕状态)                               │
│  ├─ useCaseManagementStore (案例管理)                         │
│  └─ useSocraticDialogueStore (对话历史)                       │
│                                                               │
│  持久化: localStorage (85KB平均大小)                          │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Domain Layer)                    │
│  DDD架构 - domains/                                           │
│  ├─ teaching-acts (四幕教学)                                  │
│  ├─ legal-analysis (法律分析)                                 │
│  ├─ socratic-dialogue (苏格拉底对话)                          │
│  └─ document-processing (文档处理)                            │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                  数据持久化层 (Data Layer)                     │
│  PostgreSQL + JSONB                                          │
│  teaching_sessions_v2 表 (30列结构化存储)                     │
│                                                               │
│  Repository模式:                                              │
│  PostgreSQLTeachingSessionRepository                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 数据库Schema V2

### 📊 teaching_sessions_v2 表结构

**设计理念**：
- ✅ 结构化JSONB存储（每幕细分多个字段）
- ✅ 版本控制（schema_version + data_version）
- ✅ 状态机管理（session_state字段）
- ✅ 性能优化（常用字段提升到顶层）

**核心字段分组**：

```sql
-- ========== 元数据层 (6字段) ==========
id                    UUID PRIMARY KEY
user_id               INTEGER NOT NULL
schema_version        INTEGER DEFAULT 1
data_version          VARCHAR(20) DEFAULT '1.0.0'
session_state         VARCHAR(20) -- 'act1'|'act2'|'act3'|'act4'|'completed'

-- 案例元数据（常用查询字段）
case_title            VARCHAR(500) NOT NULL
case_number           VARCHAR(200)
court_name            VARCHAR(200)

-- ========== 第一幕：案例导入 (7字段) ==========
act1_basic_info       JSONB  -- 基础信息：案号、法院、当事人
act1_facts            JSONB  -- 事实认定：摘要、时间轴、关键事实
act1_evidence         JSONB  -- 证据质证：证据清单、证据链分析
act1_reasoning        JSONB  -- 法官说理：法律依据、逻辑链条
act1_metadata         JSONB  -- 提取元数据：extractedAt、confidence、aiModel
act1_confidence       DECIMAL(3,2)  -- 提取置信度（0.00-1.00）
act1_completed_at     TIMESTAMP

-- ========== 第二幕：深度分析 (5字段) ==========
act2_narrative              JSONB  -- AI叙事章节
act2_timeline_analysis      JSONB  -- 时间轴分析（turningPoints、timeline）⭐核心
act2_evidence_questions     JSONB  -- 证据质证题目
act2_claim_analysis         JSONB  -- 请求权分析
act2_completed_at           TIMESTAMP

-- ========== 第三幕：苏格拉底对话 (2字段) ==========
act3_socratic         JSONB  -- 对话数据：level、completedNodes、dialogueHistory
act3_completed_at     TIMESTAMP

-- ========== 第四幕：总结提升 (4字段) ==========
act4_learning_report  JSONB  -- 学习报告：摘要、关键学习点、推荐
act4_ppt_url          TEXT   -- PPT下载链接
act4_ppt_metadata     JSONB  -- PPT元数据
act4_completed_at     TIMESTAMP

-- ========== 时间戳 (6字段) ==========
created_at            TIMESTAMP DEFAULT NOW()
updated_at            TIMESTAMP DEFAULT NOW()
last_saved_at         TIMESTAMP
completed_at          TIMESTAMP  -- 全部完成时间
last_viewed_at        TIMESTAMP
deleted_at            TIMESTAMP  -- 软删除

-- ========== 其他 (1字段) ==========
save_type             VARCHAR(20)  -- 'manual' | 'auto'
```

**总计：30列**（元数据6 + 第一幕7 + 第二幕5 + 第三幕2 + 第四幕4 + 时间戳6）

---

## 四幕数据流详解

### 🎬 第一幕：案例导入

```
用户上传判决书文档（PDF/Word）
    ↓
JudgmentExtractionService (三要素提取)
    ├─ basicInfo（案号、法院、日期、当事人）
    ├─ facts（事实认定）
    ├─ evidence（证据质证）
    └─ reasoning（法官说理）
    ↓
useTeachingStore.uploadData.extractedElements
    ↓ [完成学习时]
PostgreSQL act1_* 字段
```

**数据结构示例**：
```typescript
{
  uploadData: {
    extractedElements: {
      data: {
        basicInfo: { caseNumber, court, judgeDate, parties },
        threeElements: {
          facts: { summary, keyFacts[], disputedFacts[] },
          evidence: { items[], chainAnalysis },
          reasoning: { legalBasis[], logicChain[] }
        }
      },
      confidence: 0.90
    }
  }
}
```

---

### 🔍 第二幕：深度分析

```
第一幕数据 + AI分析
    ↓
LegalAnalysisFacade（统一门面）
    ├─ CaseNarrativeService → act2_narrative
    ├─ TimelineAnalysisService → act2_timeline_analysis ⭐
    ├─ EvidenceIntelligenceService → act2_evidence_questions
    └─ ClaimAnalysisService → act2_claim_analysis
    ↓
DeepAnalysis组件（数据桥接点1）
    useTeachingStore.setAnalysisResult(analysisData)
    ↓ [完成学习时]
PostgreSQL act2_* 字段
```

**关键：act2_timeline_analysis结构**：
```typescript
{
  turningPoints: [
    {
      date: "2024-01-15",
      description: "双方签订合同",
      legalSignificance: "合同成立的时间点",
      evidenceRef: ["证据1", "证据2"]
    }
  ],
  timeline: [
    { date, event, category, impact }
  ],
  metadata: {
    generatedAt: "2025-10-21T10:30:00Z",
    aiModel: "deepseek-chat"
  }
}
```

---

### 💬 第三幕：苏格拉底对话

```
用户进入对话界面
    ↓
useSocraticDialogueStore（专用Store）
    messages[], currentLevel, currentMode
    ↓
SocraticDialogueService（ISSUE协作范式）
    ├─ FullPromptBuilder（提示词构建）
    └─ DeeChatAIClient（AI调用）
    ↓
数据桥接点2（level同步机制）
    useSocraticDialogueStore → useTeachingStore
    while (level < targetLevel) { progressSocraticLevel() }
    ↓ [完成学习时]
PostgreSQL act3_socratic
```

**数据结构**：
```typescript
{
  socraticData: {
    level: 1 | 2 | 3,  // 讨论深度
    completedNodes: Set<string>,  // 完成的对话节点
    isActive: boolean,
    teachingModeEnabled: boolean
  }
}
```

**存储到数据库**：
```json
{
  "level": 2,
  "completedNodes": ["node-basic-facts", "node-evidence-chain"],
  "totalRounds": 15
}
```

---

### 📝 第四幕：总结提升

```
用户点击"生成学习报告"
    ↓
ActFour组件（数据汇总点）
    const store = useTeachingStore.getState()
    requestData = {
      uploadData: store.uploadData,      // 第一幕
      analysisData: store.analysisData,  // 第二幕
      socraticData: {                    // 第三幕
        level: store.socraticData.level,
        completedNodes: Array.from(store.socraticData.completedNodes)
      }
    }
    ↓
POST /api/teaching-acts/summary
    ↓
CaseSummaryService
    ├─ 提取第一幕数据（extractedElements.data）
    ├─ 提取第二幕数据（analysisData.result）
    ├─ 提取第三幕数据（socraticData.level）
    ├─ 构建AI Prompt
    └─ callUnifiedAI（生成报告）
    ↓
useTeachingStore.setCaseLearningReport(report)
    ↓ [完成学习时]
PostgreSQL act4_learning_report
```

**学习报告结构**：
```typescript
{
  caseOverview: {
    title: string,
    oneLineSummary: string,
    keyDispute: string,
    judgmentResult: string
  },
  learningPoints: {
    factualInsights: string[],      // 来自第一幕+第二幕
    legalPrinciples: string[],      // 来自第二幕分析
    evidenceHandling: string[],     // 来自第二幕证据分析
    proceduralAspects: string[]
  },
  socraticHighlights: {
    keyQuestions: string[],         // 来自第三幕对话
    studentInsights: string[],      // 来自第三幕讨论
    deepeningUnderstanding: string[]
  },
  metadata: {
    studyDuration: number,          // 基于三幕时长
    difficultyLevel: string,        // AI评估
    generatedAt: string
  }
}
```

---

## 状态管理架构

### 🏪 Zustand Store生态

```typescript
// ========== 核心Store：useTeachingStore ==========
src/domains/teaching-acts/stores/useTeachingStore.ts

export const useTeachingStore = create<TeachingStore>()(
  persist(
    immer((set, get) => ({
      // 状态定义
      currentAct: 'upload',
      uploadData: { extractedElements: null, confidence: 0 },
      analysisData: { result: null, isAnalyzing: false },
      socraticData: {
        level: 1,
        completedNodes: new Set(),
        isActive: false,
        teachingModeEnabled: false
      },
      summaryData: {
        report: null,
        caseLearningReport: null,
        isGenerating: false
      },
      storyChapters: [],

      // 操作方法
      setExtractedElements: (elements, confidence) => { ... },
      setAnalysisResult: (result) => { ... },
      progressSocraticLevel: () => { ... },
      setCaseLearningReport: (report) => { ... },
      // ...
    })),
    {
      name: 'teaching-store',  // localStorage key

      // 选择性持久化
      partialize: (state) => ({
        currentAct: state.currentAct,
        uploadData: state.uploadData,
        analysisData: {
          result: state.analysisData.result,
          isAnalyzing: false  // ❌ 不持久化loading状态
        },
        socraticData: {
          ...state.socraticData,
          completedNodes: Array.from(state.socraticData.completedNodes)  // Set → Array
        },
        summaryData: {
          caseLearningReport: state.summaryData.caseLearningReport,
          isGenerating: false  // ❌ 不持久化loading状态
        },
        storyChapters: state.storyChapters
      }),

      // 恢复机制
      onRehydrateStorage: () => (state) => {
        if (state?.socraticData?.completedNodes) {
          state.socraticData.completedNodes = new Set(
            state.socraticData.completedNodes as string[]  // Array → Set
          );
        }
      }
    }
  )
);
```

---

## 数据持久化机制

### 💾 双层持久化策略

```
┌─────────────────────────────────────────────────────────┐
│              前端持久化层 (localStorage)                  │
├─────────────────────────────────────────────────────────┤
│  用途：用户学习过程中的临时数据存储                         │
│  触发：Zustand persist自动持久化（每次状态变更）             │
│  大小：约85KB（典型案例）                                   │
│  生命周期：浏览器会话期间                                   │
│  优点：无网络请求、响应快                                   │
│  缺点：5MB限制、清理缓存会丢失                              │
└─────────────────────────────────────────────────────────┘
                              ↕
                    [用户点击"完成学习"]
                              ↕
┌─────────────────────────────────────────────────────────┐
│            后端持久化层 (PostgreSQL)                      │
├─────────────────────────────────────────────────────────┤
│  用途：永久保存教学会话，支持跨设备访问                      │
│  触发：用户主动保存 or 自动保存                             │
│  表：teaching_sessions_v2（30列）                         │
│  生命周期：永久（支持软删除）                               │
│  优点：可靠、支持搜索、跨设备                               │
│  缺点：需要网络请求                                        │
└─────────────────────────────────────────────────────────┘
```

### 📤 保存流程（Store → Database）

```typescript
// 1. 用户点击"完成学习"或"保存当前进度"
const saveSession = async () => {
  const store = useTeachingStore.getState();

  // 2. 构建快照（Snapshot）
  const snapshot: TeachingSessionSnapshot = {
    schemaVersion: 1,
    version: '1.0.0',
    sessionState: store.currentAct === 'summary' ? 'completed' : store.currentAct,
    caseTitle: extractCaseTitle(store),
    caseNumber: extractCaseNumber(store),
    courtName: extractCourtName(store),

    // 第一幕数据
    act1: {
      basicInfo: store.uploadData.extractedElements?.data?.basicInfo,
      facts: store.uploadData.extractedElements?.data?.threeElements?.facts,
      evidence: store.uploadData.extractedElements?.data?.threeElements?.evidence,
      reasoning: store.uploadData.extractedElements?.data?.threeElements?.reasoning,
      metadata: { confidence: store.uploadData.confidence },
      uploadedAt: new Date().toISOString()
    },

    // 第二幕数据
    act2: {
      narrative: store.storyChapters,
      timelineAnalysis: store.analysisData.result?.timeline,
      evidenceQuestions: store.analysisData.result?.evidenceQuestions,
      claimAnalysis: store.analysisData.result?.claimAnalysis,
      completedAt: new Date().toISOString()
    },

    // 第三幕数据
    act3: {
      level: store.socraticData.level,
      completedNodes: Array.from(store.socraticData.completedNodes),
      completedAt: new Date().toISOString()
    },

    // 第四幕数据
    act4: {
      learningReport: store.summaryData.caseLearningReport,
      completedAt: new Date().toISOString()
    },

    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  // 3. 调用Repository保存
  const repository = new PostgreSQLTeachingSessionRepository();
  const savedSession = await repository.saveSnapshot(userId, snapshot);

  console.log('✅ 教学会话已保存:', savedSession.id);
};
```

### 📥 恢复流程（Database → Store）

```typescript
// 1. 用户访问历史记录页面
// app/dashboard/my-courseware/[id]/page.tsx

const loadSession = async (sessionId: string) => {
  // 2. 从数据库读取
  const repository = new PostgreSQLTeachingSessionRepository();
  const session = await repository.findById(sessionId, userId);

  if (!session) {
    throw new Error('教学会话不存在');
  }

  // 3. 恢复到Store
  const store = useTeachingStore.getState();

  // 恢复第一幕
  if (session.act1) {
    store.setExtractedElements(
      {
        data: {
          basicInfo: session.act1.basicInfo,
          threeElements: {
            facts: session.act1.facts,
            evidence: session.act1.evidence,
            reasoning: session.act1.reasoning
          }
        }
      },
      session.act1.metadata?.confidence || 0
    );
  }

  // 恢复第二幕
  if (session.act2) {
    store.setStoryChapters(session.act2.narrative || []);
    store.setAnalysisResult({
      timeline: session.act2.timelineAnalysis,
      evidenceQuestions: session.act2.evidenceQuestions,
      claimAnalysis: session.act2.claimAnalysis
    });
  }

  // 恢复第三幕
  if (session.act3) {
    const targetLevel = session.act3.level;
    while (store.socraticData.level < targetLevel) {
      store.progressSocraticLevel();
    }
    session.act3.completedNodes.forEach(nodeId => {
      store.markNodeComplete(nodeId);
    });
  }

  // 恢复第四幕
  if (session.act4) {
    store.setCaseLearningReport(session.act4.learningReport);
  }

  console.log('✅ 教学会话已恢复');
};
```

---

## 关键代码位置

### 📂 核心文件清单

| 文件路径 | 职责 | 关键函数/类 |
|---------|------|----------|
| **Repository层** | | |
| `src/domains/teaching-acts/repositories/`<br/>`PostgreSQLTeachingSessionRepository.ts` | 数据库CRUD操作 | `saveSnapshot()`<br/>`findById()`<br/>`buildColumnPayload()` |
| **Store层** | | |
| `src/domains/teaching-acts/stores/`<br/>`useTeachingStore.ts` | 四幕状态管理 | `setExtractedElements()`<br/>`setAnalysisResult()`<br/>`progressSocraticLevel()`<br/>`setCaseLearningReport()` |
| `src/domains/socratic-dialogue/stores/`<br/>`useSocraticDialogueStore.ts` | 对话状态管理 | `addMessage()`<br/>`setLevel()` |
| **Schema层** | | |
| `database/schema-v2.sql` | 数据库表结构 | `teaching_sessions_v2`表定义 |
| **UI组件层** | | |
| `components/acts/ActOne.tsx` | 第一幕UI | 案例上传界面 |
| `components/acts/DeepAnalysis.tsx` | 第二幕UI | 深度分析界面<br/>**数据桥接点1**（行438-454） |
| `components/acts/SocraticDialogue.tsx` | 第三幕UI | 苏格拉底对话界面 |
| `components/acts/ActFour.tsx` | 第四幕UI | 学习报告界面<br/>**数据汇总点**（行42-78） |
| **Service层** | | |
| `src/domains/legal-analysis/services/`<br/>`LegalAnalysisFacade.ts` | 法律分析门面 | `analyzeCase()` |
| `src/domains/legal-analysis/services/`<br/>`TimelineAnalysisApplicationService.ts` | 时间轴分析 | `analyze()` |
| `src/domains/socratic-dialogue/services/`<br/>`SocraticDialogueService.ts` | 苏格拉底对话 | `generateQuestion()` |
| `src/domains/teaching-acts/services/`<br/>`CaseSummaryService.ts` | 学习报告生成 | `generateCaseSummary()` |
| **API路由** | | |
| `app/api/teaching-sessions/route.ts` | 会话保存API | `POST /api/teaching-sessions` |
| `app/api/teaching-sessions/[id]/route.ts` | 会话读取API | `GET /api/teaching-sessions/:id` |
| `app/api/teaching-acts/summary/route.ts` | 报告生成API | `POST /api/teaching-acts/summary` |

---

## 数据流关键节点

### 🔗 数据桥接点1：深度分析结果同步

**位置**: `components/acts/DeepAnalysis.tsx:438-454`

**作用**: 将第二幕的AI分析结果同步到useTeachingStore，供第四幕使用

```typescript
// DeepAnalysis组件完成分析后
const analysisData = await analyzeCase(caseData);

// 🔗 数据桥接：同步到 useTeachingStore（第四幕需要）
const { useTeachingStore } = await import('@/src/domains/teaching-acts/stores/useTeachingStore');
useTeachingStore.getState().setAnalysisResult(analysisData);

// 验证写入
const stored = useTeachingStore.getState().analysisData;
console.log('✅ [DeepAnalysis] 验证Store写入:', {
  result存在: !!stored.result,
  转折点数量: stored.result?.turningPoints?.length || 0
});
```

---

### 🔗 数据桥接点2：苏格拉底对话level同步

**位置**: `src/domains/socratic-dialogue/stores/useSocraticDialogueStore.ts:92-108`

**作用**: 将对话难度等级实时同步到useTeachingStore

```typescript
// useSocraticDialogueStore的addMessage方法中
addMessage: (message) => {
  set(state => {
    state.messages.push(message);

    // 🔗 数据桥接：同步level到 useTeachingStore
    import('@/src/domains/teaching-acts/stores/useTeachingStore').then(({ useTeachingStore }) => {
      const levelMap = { beginner: 1, intermediate: 2, advanced: 3 };
      const numericLevel = levelMap[state.currentLevel] || 1;

      const teachingStore = useTeachingStore.getState();
      while (teachingStore.socraticData.level < numericLevel) {
        teachingStore.progressSocraticLevel();
      }
    });
  });
}
```

---

### 🔗 数据汇总点：第四幕数据收集

**位置**: `components/acts/ActFour.tsx:42-78`

**作用**: 汇总前三幕的所有数据，传递给报告生成API

```typescript
const generateReport = async () => {
  // 🔧 从客户端Store读取数据
  const store = useTeachingStore.getState();
  const requestData = {
    uploadData: store.uploadData,           // ✅ 第一幕数据
    analysisData: store.analysisData,       // ✅ 第二幕数据
    socraticData: {                         // ✅ 第三幕数据
      level: store.socraticData.level,
      completedNodes: Array.from(store.socraticData.completedNodes),
    }
  };

  console.log('📤 [ActFour] 发送Store数据到API:', {
    uploadData存在: !!requestData.uploadData.extractedElements,
    analysisData存在: !!requestData.analysisData.result,
    socraticLevel: requestData.socraticData.level
  });

  // 发送到后端生成报告
  const response = await fetch('/api/teaching-acts/summary', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestData)
  });

  const { data: report } = await response.json();
  setCaseLearningReport(report);
  markActComplete('summary');
};
```

---

## 架构优势与特点

### ✅ 核心优势

1. **清晰的数据流向**
   - 单向数据流：UI → Store → Repository → Database
   - 每个环节职责明确，易于追踪和调试

2. **结构化JSONB存储**
   - 每幕数据细分为多个字段（30列）
   - 既保持了灵活性，又便于查询和索引

3. **双层持久化策略**
   - localStorage：用户体验优先（快速、无网络）
   - PostgreSQL：数据安全优先（永久、跨设备）

4. **版本控制机制**
   - schema_version：支持数据库结构升级
   - data_version：支持数据格式向后兼容

5. **状态机管理**
   - session_state字段明确会话状态
   - 支持状态转换验证和进度追踪

6. **软删除设计**
   - deleted_at字段实现逻辑删除
   - 数据可恢复，符合教育场景需求

---

## 性能指标

### 📊 当前性能数据

| 指标 | 数值 | 说明 |
|------|------|------|
| **localStorage使用** | 40-160KB | 典型案例 |
| **数据库单行大小** | 50-200KB | JSONB压缩后 |
| **第一幕提取耗时** | 2-5秒 | AI提取 + 规则匹配 |
| **第二幕分析耗时** | 5-10秒 | 多个AI分析器并行 |
| **第三幕对话响应** | 1-3秒 | 单次AI调用 |
| **第四幕报告生成** | 5-8秒 | AI综合生成 |
| **会话保存耗时** | 100-300ms | 数据库INSERT |
| **会话恢复耗时** | 50-150ms | 数据库SELECT |

---

## 未来优化方向

### 🚀 短期优化（1-2月）

1. **IndexedDB迁移**
   - 解决localStorage 5MB限制
   - 支持更大的案例文档
   - 提升数据查询性能

2. **增量保存机制**
   - 当前：仅"完成学习"时保存
   - 优化：每幕完成后自动保存
   - 减少数据丢失风险

3. **数据压缩**
   - 使用LZ-String压缩JSONB
   - 预期压缩率：60-80%
   - 降低存储和传输成本

### 🌟 长期优化（3-6月）

1. **分布式缓存**
   - 引入Redis缓存层
   - 缓存热点会话数据
   - 提升查询性能

2. **数据分析平台**
   - 学习行为分析
   - 教学质量评估
   - AI效果追踪

3. **离线支持**
   - PWA + Service Worker
   - 离线学习模式
   - 数据同步机制

---

## 常见问题排查

### 🔍 问题1：第四幕报告数据不完整

**现象**：生成的报告缺少前三幕的关键信息

**排查步骤**：
```typescript
// 1. 检查Store数据完整性
const store = useTeachingStore.getState();
console.log({
  uploadData: !!store.uploadData.extractedElements,
  analysisData: !!store.analysisData.result,
  socraticLevel: store.socraticData.level
});

// 2. 检查localStorage持久化
const persisted = localStorage.getItem('teaching-store');
console.log('Persisted data:', JSON.parse(persisted));

// 3. 检查API请求体
// 在ActFour.tsx的generateReport中添加日志
```

**常见原因**：
- localStorage被清理
- Store数据未正确写入
- API传递数据时丢失

---

### 🔍 问题2：会话恢复后数据丢失

**现象**：从数据库恢复会话后，部分数据缺失

**排查步骤**：
```sql
-- 1. 检查数据库数据完整性
SELECT
  id,
  case_title,
  act1_basic_info IS NOT NULL as has_act1,
  act2_timeline_analysis IS NOT NULL as has_act2,
  act3_socratic IS NOT NULL as has_act3,
  act4_learning_report IS NOT NULL as has_act4
FROM teaching_sessions_v2
WHERE id = 'session-uuid';
```

**常见原因**：
- buildColumnPayload映射错误
- mapRowToEntity恢复逻辑错误
- 数据格式版本不兼容

---

## 相关文档

- [CLAUDE.md](../CLAUDE.md) - 项目架构总览
- [四幕教学数据流详细分析](../功能文档/四幕教学/FOURTH_ACT_DATA_FLOW_ANALYSIS.md)
- [数据持久化分析](../功能文档/四幕教学/FOURTH_ACT_DATA_PERSISTENCE_ANALYSIS.md)
- [Snapshot系统优化指南](../功能文档/四幕教学/snapshot-system-optimization-guide.md)

---

## 维护日志

| 日期 | 版本 | 变更内容 | 维护者 |
|------|------|---------|--------|
| 2025-10-21 | v3.0 | 创建新版架构总览文档，基于当前生产环境 | Claude Code |
| 2025-01-21 | v1.0 | 初始版本（architecture-and-dataflow.md） | Team |

---

**文档状态**: ✅ 已验证 - 基于生产环境代码
**维护承诺**: 每次重大架构变更后更新
**反馈渠道**: GitHub Issues

