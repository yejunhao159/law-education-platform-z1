# æ³•å­¦æ•™è‚²å¹³å° - æ•°æ®æµæ¶æ„æ€»è§ˆï¼ˆ2025ç‰ˆï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v3.0
> **æ›´æ–°æ—¥æœŸ**: 2025-10-21
> **çŠ¶æ€**: âœ… æ¶æ„ç¨³å®šæœŸ - ç”Ÿäº§ç¯å¢ƒè¿è¡Œä¸­

---

## ğŸ“‹ å¿«é€Ÿå¯¼èˆª

- [æ ¸å¿ƒæ¶æ„æ¦‚è§ˆ](#æ ¸å¿ƒæ¶æ„æ¦‚è§ˆ)
- [æ•°æ®åº“Schema V2](#æ•°æ®åº“schema-v2)
- [å››å¹•æ•°æ®æµè¯¦è§£](#å››å¹•æ•°æ®æµè¯¦è§£)
- [çŠ¶æ€ç®¡ç†æ¶æ„](#çŠ¶æ€ç®¡ç†æ¶æ„)
- [æ•°æ®æŒä¹…åŒ–æœºåˆ¶](#æ•°æ®æŒä¹…åŒ–æœºåˆ¶)
- [å…³é”®ä»£ç ä½ç½®](#å…³é”®ä»£ç ä½ç½®)

---

## æ ¸å¿ƒæ¶æ„æ¦‚è§ˆ

### ğŸ—ï¸ ä¸‰å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)                      â”‚
â”‚  React 19 + Next.js 15 + Tailwind CSS                        â”‚
â”‚  å››å¹•æ•™å­¦ç»„ä»¶ + è‹æ ¼æ‹‰åº•å¯¹è¯ç•Œé¢                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  çŠ¶æ€ç®¡ç†å±‚ (State Layer)                      â”‚
â”‚  Zustand + immer + persist                                   â”‚
â”‚  â”œâ”€ useTeachingStore (å››å¹•çŠ¶æ€)                               â”‚
â”‚  â”œâ”€ useCaseManagementStore (æ¡ˆä¾‹ç®¡ç†)                         â”‚
â”‚  â””â”€ useSocraticDialogueStore (å¯¹è¯å†å²)                       â”‚
â”‚                                                               â”‚
â”‚  æŒä¹…åŒ–: localStorage (85KBå¹³å‡å¤§å°)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Domain Layer)                    â”‚
â”‚  DDDæ¶æ„ - domains/                                           â”‚
â”‚  â”œâ”€ teaching-acts (å››å¹•æ•™å­¦)                                  â”‚
â”‚  â”œâ”€ legal-analysis (æ³•å¾‹åˆ†æ)                                 â”‚
â”‚  â”œâ”€ socratic-dialogue (è‹æ ¼æ‹‰åº•å¯¹è¯)                          â”‚
â”‚  â””â”€ document-processing (æ–‡æ¡£å¤„ç†)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®æŒä¹…åŒ–å±‚ (Data Layer)                     â”‚
â”‚  PostgreSQL + JSONB                                          â”‚
â”‚  teaching_sessions_v2 è¡¨ (30åˆ—ç»“æ„åŒ–å­˜å‚¨)                     â”‚
â”‚                                                               â”‚
â”‚  Repositoryæ¨¡å¼:                                              â”‚
â”‚  PostgreSQLTeachingSessionRepository                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®åº“Schema V2

### ğŸ“Š teaching_sessions_v2 è¡¨ç»“æ„

**è®¾è®¡ç†å¿µ**ï¼š
- âœ… ç»“æ„åŒ–JSONBå­˜å‚¨ï¼ˆæ¯å¹•ç»†åˆ†å¤šä¸ªå­—æ®µï¼‰
- âœ… ç‰ˆæœ¬æ§åˆ¶ï¼ˆschema_version + data_versionï¼‰
- âœ… çŠ¶æ€æœºç®¡ç†ï¼ˆsession_stateå­—æ®µï¼‰
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆå¸¸ç”¨å­—æ®µæå‡åˆ°é¡¶å±‚ï¼‰

**æ ¸å¿ƒå­—æ®µåˆ†ç»„**ï¼š

```sql
-- ========== å…ƒæ•°æ®å±‚ (6å­—æ®µ) ==========
id                    UUID PRIMARY KEY
user_id               INTEGER NOT NULL
schema_version        INTEGER DEFAULT 1
data_version          VARCHAR(20) DEFAULT '1.0.0'
session_state         VARCHAR(20) -- 'act1'|'act2'|'act3'|'act4'|'completed'

-- æ¡ˆä¾‹å…ƒæ•°æ®ï¼ˆå¸¸ç”¨æŸ¥è¯¢å­—æ®µï¼‰
case_title            VARCHAR(500) NOT NULL
case_number           VARCHAR(200)
court_name            VARCHAR(200)

-- ========== ç¬¬ä¸€å¹•ï¼šæ¡ˆä¾‹å¯¼å…¥ (7å­—æ®µ) ==========
act1_basic_info       JSONB  -- åŸºç¡€ä¿¡æ¯ï¼šæ¡ˆå·ã€æ³•é™¢ã€å½“äº‹äºº
act1_facts            JSONB  -- äº‹å®è®¤å®šï¼šæ‘˜è¦ã€æ—¶é—´è½´ã€å…³é”®äº‹å®
act1_evidence         JSONB  -- è¯æ®è´¨è¯ï¼šè¯æ®æ¸…å•ã€è¯æ®é“¾åˆ†æ
act1_reasoning        JSONB  -- æ³•å®˜è¯´ç†ï¼šæ³•å¾‹ä¾æ®ã€é€»è¾‘é“¾æ¡
act1_metadata         JSONB  -- æå–å…ƒæ•°æ®ï¼šextractedAtã€confidenceã€aiModel
act1_confidence       DECIMAL(3,2)  -- æå–ç½®ä¿¡åº¦ï¼ˆ0.00-1.00ï¼‰
act1_completed_at     TIMESTAMP

-- ========== ç¬¬äºŒå¹•ï¼šæ·±åº¦åˆ†æ (5å­—æ®µ) ==========
act2_narrative              JSONB  -- AIå™äº‹ç« èŠ‚
act2_timeline_analysis      JSONB  -- æ—¶é—´è½´åˆ†æï¼ˆturningPointsã€timelineï¼‰â­æ ¸å¿ƒ
act2_evidence_questions     JSONB  -- è¯æ®è´¨è¯é¢˜ç›®
act2_claim_analysis         JSONB  -- è¯·æ±‚æƒåˆ†æ
act2_completed_at           TIMESTAMP

-- ========== ç¬¬ä¸‰å¹•ï¼šè‹æ ¼æ‹‰åº•å¯¹è¯ (2å­—æ®µ) ==========
act3_socratic         JSONB  -- å¯¹è¯æ•°æ®ï¼šlevelã€completedNodesã€dialogueHistory
act3_completed_at     TIMESTAMP

-- ========== ç¬¬å››å¹•ï¼šæ€»ç»“æå‡ (4å­—æ®µ) ==========
act4_learning_report  JSONB  -- å­¦ä¹ æŠ¥å‘Šï¼šæ‘˜è¦ã€å…³é”®å­¦ä¹ ç‚¹ã€æ¨è
act4_ppt_url          TEXT   -- PPTä¸‹è½½é“¾æ¥
act4_ppt_metadata     JSONB  -- PPTå…ƒæ•°æ®
act4_completed_at     TIMESTAMP

-- ========== æ—¶é—´æˆ³ (6å­—æ®µ) ==========
created_at            TIMESTAMP DEFAULT NOW()
updated_at            TIMESTAMP DEFAULT NOW()
last_saved_at         TIMESTAMP
completed_at          TIMESTAMP  -- å…¨éƒ¨å®Œæˆæ—¶é—´
last_viewed_at        TIMESTAMP
deleted_at            TIMESTAMP  -- è½¯åˆ é™¤

-- ========== å…¶ä»– (1å­—æ®µ) ==========
save_type             VARCHAR(20)  -- 'manual' | 'auto'
```

**æ€»è®¡ï¼š30åˆ—**ï¼ˆå…ƒæ•°æ®6 + ç¬¬ä¸€å¹•7 + ç¬¬äºŒå¹•5 + ç¬¬ä¸‰å¹•2 + ç¬¬å››å¹•4 + æ—¶é—´æˆ³6ï¼‰

---

## å››å¹•æ•°æ®æµè¯¦è§£

### ğŸ¬ ç¬¬ä¸€å¹•ï¼šæ¡ˆä¾‹å¯¼å…¥

```
ç”¨æˆ·ä¸Šä¼ åˆ¤å†³ä¹¦æ–‡æ¡£ï¼ˆPDF/Wordï¼‰
    â†“
JudgmentExtractionService (ä¸‰è¦ç´ æå–)
    â”œâ”€ basicInfoï¼ˆæ¡ˆå·ã€æ³•é™¢ã€æ—¥æœŸã€å½“äº‹äººï¼‰
    â”œâ”€ factsï¼ˆäº‹å®è®¤å®šï¼‰
    â”œâ”€ evidenceï¼ˆè¯æ®è´¨è¯ï¼‰
    â””â”€ reasoningï¼ˆæ³•å®˜è¯´ç†ï¼‰
    â†“
useTeachingStore.uploadData.extractedElements
    â†“ [å®Œæˆå­¦ä¹ æ—¶]
PostgreSQL act1_* å­—æ®µ
```

**æ•°æ®ç»“æ„ç¤ºä¾‹**ï¼š
```typescript
{
  uploadData: {
    extractedElements: {
      data: {
        basicInfo: { caseNumber, court, judgeDate, parties },
        threeElements: {
          facts: { summary, keyFacts[], disputedFacts[] },
          evidence: { items[], chainAnalysis },
          reasoning: { legalBasis[], logicChain[] }
        }
      },
      confidence: 0.90
    }
  }
}
```

---

### ğŸ” ç¬¬äºŒå¹•ï¼šæ·±åº¦åˆ†æ

```
ç¬¬ä¸€å¹•æ•°æ® + AIåˆ†æ
    â†“
LegalAnalysisFacadeï¼ˆç»Ÿä¸€é—¨é¢ï¼‰
    â”œâ”€ CaseNarrativeService â†’ act2_narrative
    â”œâ”€ TimelineAnalysisService â†’ act2_timeline_analysis â­
    â”œâ”€ EvidenceIntelligenceService â†’ act2_evidence_questions
    â””â”€ ClaimAnalysisService â†’ act2_claim_analysis
    â†“
DeepAnalysisç»„ä»¶ï¼ˆæ•°æ®æ¡¥æ¥ç‚¹1ï¼‰
    useTeachingStore.setAnalysisResult(analysisData)
    â†“ [å®Œæˆå­¦ä¹ æ—¶]
PostgreSQL act2_* å­—æ®µ
```

**å…³é”®ï¼šact2_timeline_analysisç»“æ„**ï¼š
```typescript
{
  turningPoints: [
    {
      date: "2024-01-15",
      description: "åŒæ–¹ç­¾è®¢åˆåŒ",
      legalSignificance: "åˆåŒæˆç«‹çš„æ—¶é—´ç‚¹",
      evidenceRef: ["è¯æ®1", "è¯æ®2"]
    }
  ],
  timeline: [
    { date, event, category, impact }
  ],
  metadata: {
    generatedAt: "2025-10-21T10:30:00Z",
    aiModel: "deepseek-chat"
  }
}
```

---

### ğŸ’¬ ç¬¬ä¸‰å¹•ï¼šè‹æ ¼æ‹‰åº•å¯¹è¯

```
ç”¨æˆ·è¿›å…¥å¯¹è¯ç•Œé¢
    â†“
useSocraticDialogueStoreï¼ˆä¸“ç”¨Storeï¼‰
    messages[], currentLevel, currentMode
    â†“
SocraticDialogueServiceï¼ˆISSUEåä½œèŒƒå¼ï¼‰
    â”œâ”€ FullPromptBuilderï¼ˆæç¤ºè¯æ„å»ºï¼‰
    â””â”€ DeeChatAIClientï¼ˆAIè°ƒç”¨ï¼‰
    â†“
æ•°æ®æ¡¥æ¥ç‚¹2ï¼ˆlevelåŒæ­¥æœºåˆ¶ï¼‰
    useSocraticDialogueStore â†’ useTeachingStore
    while (level < targetLevel) { progressSocraticLevel() }
    â†“ [å®Œæˆå­¦ä¹ æ—¶]
PostgreSQL act3_socratic
```

**æ•°æ®ç»“æ„**ï¼š
```typescript
{
  socraticData: {
    level: 1 | 2 | 3,  // è®¨è®ºæ·±åº¦
    completedNodes: Set<string>,  // å®Œæˆçš„å¯¹è¯èŠ‚ç‚¹
    isActive: boolean,
    teachingModeEnabled: boolean
  }
}
```

**å­˜å‚¨åˆ°æ•°æ®åº“**ï¼š
```json
{
  "level": 2,
  "completedNodes": ["node-basic-facts", "node-evidence-chain"],
  "totalRounds": 15
}
```

---

### ğŸ“ ç¬¬å››å¹•ï¼šæ€»ç»“æå‡

```
ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š"
    â†“
ActFourç»„ä»¶ï¼ˆæ•°æ®æ±‡æ€»ç‚¹ï¼‰
    const store = useTeachingStore.getState()
    requestData = {
      uploadData: store.uploadData,      // ç¬¬ä¸€å¹•
      analysisData: store.analysisData,  // ç¬¬äºŒå¹•
      socraticData: {                    // ç¬¬ä¸‰å¹•
        level: store.socraticData.level,
        completedNodes: Array.from(store.socraticData.completedNodes)
      }
    }
    â†“
POST /api/teaching-acts/summary
    â†“
CaseSummaryService
    â”œâ”€ æå–ç¬¬ä¸€å¹•æ•°æ®ï¼ˆextractedElements.dataï¼‰
    â”œâ”€ æå–ç¬¬äºŒå¹•æ•°æ®ï¼ˆanalysisData.resultï¼‰
    â”œâ”€ æå–ç¬¬ä¸‰å¹•æ•°æ®ï¼ˆsocraticData.levelï¼‰
    â”œâ”€ æ„å»ºAI Prompt
    â””â”€ callUnifiedAIï¼ˆç”ŸæˆæŠ¥å‘Šï¼‰
    â†“
useTeachingStore.setCaseLearningReport(report)
    â†“ [å®Œæˆå­¦ä¹ æ—¶]
PostgreSQL act4_learning_report
```

**å­¦ä¹ æŠ¥å‘Šç»“æ„**ï¼š
```typescript
{
  caseOverview: {
    title: string,
    oneLineSummary: string,
    keyDispute: string,
    judgmentResult: string
  },
  learningPoints: {
    factualInsights: string[],      // æ¥è‡ªç¬¬ä¸€å¹•+ç¬¬äºŒå¹•
    legalPrinciples: string[],      // æ¥è‡ªç¬¬äºŒå¹•åˆ†æ
    evidenceHandling: string[],     // æ¥è‡ªç¬¬äºŒå¹•è¯æ®åˆ†æ
    proceduralAspects: string[]
  },
  socraticHighlights: {
    keyQuestions: string[],         // æ¥è‡ªç¬¬ä¸‰å¹•å¯¹è¯
    studentInsights: string[],      // æ¥è‡ªç¬¬ä¸‰å¹•è®¨è®º
    deepeningUnderstanding: string[]
  },
  metadata: {
    studyDuration: number,          // åŸºäºä¸‰å¹•æ—¶é•¿
    difficultyLevel: string,        // AIè¯„ä¼°
    generatedAt: string
  }
}
```

---

## çŠ¶æ€ç®¡ç†æ¶æ„

### ğŸª Zustand Storeç”Ÿæ€

```typescript
// ========== æ ¸å¿ƒStoreï¼šuseTeachingStore ==========
src/domains/teaching-acts/stores/useTeachingStore.ts

export const useTeachingStore = create<TeachingStore>()(
  persist(
    immer((set, get) => ({
      // çŠ¶æ€å®šä¹‰
      currentAct: 'upload',
      uploadData: { extractedElements: null, confidence: 0 },
      analysisData: { result: null, isAnalyzing: false },
      socraticData: {
        level: 1,
        completedNodes: new Set(),
        isActive: false,
        teachingModeEnabled: false
      },
      summaryData: {
        report: null,
        caseLearningReport: null,
        isGenerating: false
      },
      storyChapters: [],

      // æ“ä½œæ–¹æ³•
      setExtractedElements: (elements, confidence) => { ... },
      setAnalysisResult: (result) => { ... },
      progressSocraticLevel: () => { ... },
      setCaseLearningReport: (report) => { ... },
      // ...
    })),
    {
      name: 'teaching-store',  // localStorage key

      // é€‰æ‹©æ€§æŒä¹…åŒ–
      partialize: (state) => ({
        currentAct: state.currentAct,
        uploadData: state.uploadData,
        analysisData: {
          result: state.analysisData.result,
          isAnalyzing: false  // âŒ ä¸æŒä¹…åŒ–loadingçŠ¶æ€
        },
        socraticData: {
          ...state.socraticData,
          completedNodes: Array.from(state.socraticData.completedNodes)  // Set â†’ Array
        },
        summaryData: {
          caseLearningReport: state.summaryData.caseLearningReport,
          isGenerating: false  // âŒ ä¸æŒä¹…åŒ–loadingçŠ¶æ€
        },
        storyChapters: state.storyChapters
      }),

      // æ¢å¤æœºåˆ¶
      onRehydrateStorage: () => (state) => {
        if (state?.socraticData?.completedNodes) {
          state.socraticData.completedNodes = new Set(
            state.socraticData.completedNodes as string[]  // Array â†’ Set
          );
        }
      }
    }
  )
);
```

---

## æ•°æ®æŒä¹…åŒ–æœºåˆ¶

### ğŸ’¾ åŒå±‚æŒä¹…åŒ–ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‰ç«¯æŒä¹…åŒ–å±‚ (localStorage)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨é€”ï¼šç”¨æˆ·å­¦ä¹ è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ•°æ®å­˜å‚¨                         â”‚
â”‚  è§¦å‘ï¼šZustand persistè‡ªåŠ¨æŒä¹…åŒ–ï¼ˆæ¯æ¬¡çŠ¶æ€å˜æ›´ï¼‰             â”‚
â”‚  å¤§å°ï¼šçº¦85KBï¼ˆå…¸å‹æ¡ˆä¾‹ï¼‰                                   â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸï¼šæµè§ˆå™¨ä¼šè¯æœŸé—´                                   â”‚
â”‚  ä¼˜ç‚¹ï¼šæ— ç½‘ç»œè¯·æ±‚ã€å“åº”å¿«                                   â”‚
â”‚  ç¼ºç‚¹ï¼š5MBé™åˆ¶ã€æ¸…ç†ç¼“å­˜ä¼šä¸¢å¤±                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
                    [ç”¨æˆ·ç‚¹å‡»"å®Œæˆå­¦ä¹ "]
                              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åç«¯æŒä¹…åŒ–å±‚ (PostgreSQL)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨é€”ï¼šæ°¸ä¹…ä¿å­˜æ•™å­¦ä¼šè¯ï¼Œæ”¯æŒè·¨è®¾å¤‡è®¿é—®                      â”‚
â”‚  è§¦å‘ï¼šç”¨æˆ·ä¸»åŠ¨ä¿å­˜ or è‡ªåŠ¨ä¿å­˜                             â”‚
â”‚  è¡¨ï¼šteaching_sessions_v2ï¼ˆ30åˆ—ï¼‰                         â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸï¼šæ°¸ä¹…ï¼ˆæ”¯æŒè½¯åˆ é™¤ï¼‰                               â”‚
â”‚  ä¼˜ç‚¹ï¼šå¯é ã€æ”¯æŒæœç´¢ã€è·¨è®¾å¤‡                               â”‚
â”‚  ç¼ºç‚¹ï¼šéœ€è¦ç½‘ç»œè¯·æ±‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¤ ä¿å­˜æµç¨‹ï¼ˆStore â†’ Databaseï¼‰

```typescript
// 1. ç”¨æˆ·ç‚¹å‡»"å®Œæˆå­¦ä¹ "æˆ–"ä¿å­˜å½“å‰è¿›åº¦"
const saveSession = async () => {
  const store = useTeachingStore.getState();

  // 2. æ„å»ºå¿«ç…§ï¼ˆSnapshotï¼‰
  const snapshot: TeachingSessionSnapshot = {
    schemaVersion: 1,
    version: '1.0.0',
    sessionState: store.currentAct === 'summary' ? 'completed' : store.currentAct,
    caseTitle: extractCaseTitle(store),
    caseNumber: extractCaseNumber(store),
    courtName: extractCourtName(store),

    // ç¬¬ä¸€å¹•æ•°æ®
    act1: {
      basicInfo: store.uploadData.extractedElements?.data?.basicInfo,
      facts: store.uploadData.extractedElements?.data?.threeElements?.facts,
      evidence: store.uploadData.extractedElements?.data?.threeElements?.evidence,
      reasoning: store.uploadData.extractedElements?.data?.threeElements?.reasoning,
      metadata: { confidence: store.uploadData.confidence },
      uploadedAt: new Date().toISOString()
    },

    // ç¬¬äºŒå¹•æ•°æ®
    act2: {
      narrative: store.storyChapters,
      timelineAnalysis: store.analysisData.result?.timeline,
      evidenceQuestions: store.analysisData.result?.evidenceQuestions,
      claimAnalysis: store.analysisData.result?.claimAnalysis,
      completedAt: new Date().toISOString()
    },

    // ç¬¬ä¸‰å¹•æ•°æ®
    act3: {
      level: store.socraticData.level,
      completedNodes: Array.from(store.socraticData.completedNodes),
      completedAt: new Date().toISOString()
    },

    // ç¬¬å››å¹•æ•°æ®
    act4: {
      learningReport: store.summaryData.caseLearningReport,
      completedAt: new Date().toISOString()
    },

    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  // 3. è°ƒç”¨Repositoryä¿å­˜
  const repository = new PostgreSQLTeachingSessionRepository();
  const savedSession = await repository.saveSnapshot(userId, snapshot);

  console.log('âœ… æ•™å­¦ä¼šè¯å·²ä¿å­˜:', savedSession.id);
};
```

### ğŸ“¥ æ¢å¤æµç¨‹ï¼ˆDatabase â†’ Storeï¼‰

```typescript
// 1. ç”¨æˆ·è®¿é—®å†å²è®°å½•é¡µé¢
// app/dashboard/my-courseware/[id]/page.tsx

const loadSession = async (sessionId: string) => {
  // 2. ä»æ•°æ®åº“è¯»å–
  const repository = new PostgreSQLTeachingSessionRepository();
  const session = await repository.findById(sessionId, userId);

  if (!session) {
    throw new Error('æ•™å­¦ä¼šè¯ä¸å­˜åœ¨');
  }

  // 3. æ¢å¤åˆ°Store
  const store = useTeachingStore.getState();

  // æ¢å¤ç¬¬ä¸€å¹•
  if (session.act1) {
    store.setExtractedElements(
      {
        data: {
          basicInfo: session.act1.basicInfo,
          threeElements: {
            facts: session.act1.facts,
            evidence: session.act1.evidence,
            reasoning: session.act1.reasoning
          }
        }
      },
      session.act1.metadata?.confidence || 0
    );
  }

  // æ¢å¤ç¬¬äºŒå¹•
  if (session.act2) {
    store.setStoryChapters(session.act2.narrative || []);
    store.setAnalysisResult({
      timeline: session.act2.timelineAnalysis,
      evidenceQuestions: session.act2.evidenceQuestions,
      claimAnalysis: session.act2.claimAnalysis
    });
  }

  // æ¢å¤ç¬¬ä¸‰å¹•
  if (session.act3) {
    const targetLevel = session.act3.level;
    while (store.socraticData.level < targetLevel) {
      store.progressSocraticLevel();
    }
    session.act3.completedNodes.forEach(nodeId => {
      store.markNodeComplete(nodeId);
    });
  }

  // æ¢å¤ç¬¬å››å¹•
  if (session.act4) {
    store.setCaseLearningReport(session.act4.learningReport);
  }

  console.log('âœ… æ•™å­¦ä¼šè¯å·²æ¢å¤');
};
```

---

## å…³é”®ä»£ç ä½ç½®

### ğŸ“‚ æ ¸å¿ƒæ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | èŒè´£ | å…³é”®å‡½æ•°/ç±» |
|---------|------|----------|
| **Repositoryå±‚** | | |
| `src/domains/teaching-acts/repositories/`<br/>`PostgreSQLTeachingSessionRepository.ts` | æ•°æ®åº“CRUDæ“ä½œ | `saveSnapshot()`<br/>`findById()`<br/>`buildColumnPayload()` |
| **Storeå±‚** | | |
| `src/domains/teaching-acts/stores/`<br/>`useTeachingStore.ts` | å››å¹•çŠ¶æ€ç®¡ç† | `setExtractedElements()`<br/>`setAnalysisResult()`<br/>`progressSocraticLevel()`<br/>`setCaseLearningReport()` |
| `src/domains/socratic-dialogue/stores/`<br/>`useSocraticDialogueStore.ts` | å¯¹è¯çŠ¶æ€ç®¡ç† | `addMessage()`<br/>`setLevel()` |
| **Schemaå±‚** | | |
| `database/schema-v2.sql` | æ•°æ®åº“è¡¨ç»“æ„ | `teaching_sessions_v2`è¡¨å®šä¹‰ |
| **UIç»„ä»¶å±‚** | | |
| `components/acts/ActOne.tsx` | ç¬¬ä¸€å¹•UI | æ¡ˆä¾‹ä¸Šä¼ ç•Œé¢ |
| `components/acts/DeepAnalysis.tsx` | ç¬¬äºŒå¹•UI | æ·±åº¦åˆ†æç•Œé¢<br/>**æ•°æ®æ¡¥æ¥ç‚¹1**ï¼ˆè¡Œ438-454ï¼‰ |
| `components/acts/SocraticDialogue.tsx` | ç¬¬ä¸‰å¹•UI | è‹æ ¼æ‹‰åº•å¯¹è¯ç•Œé¢ |
| `components/acts/ActFour.tsx` | ç¬¬å››å¹•UI | å­¦ä¹ æŠ¥å‘Šç•Œé¢<br/>**æ•°æ®æ±‡æ€»ç‚¹**ï¼ˆè¡Œ42-78ï¼‰ |
| **Serviceå±‚** | | |
| `src/domains/legal-analysis/services/`<br/>`LegalAnalysisFacade.ts` | æ³•å¾‹åˆ†æé—¨é¢ | `analyzeCase()` |
| `src/domains/legal-analysis/services/`<br/>`TimelineAnalysisApplicationService.ts` | æ—¶é—´è½´åˆ†æ | `analyze()` |
| `src/domains/socratic-dialogue/services/`<br/>`SocraticDialogueService.ts` | è‹æ ¼æ‹‰åº•å¯¹è¯ | `generateQuestion()` |
| `src/domains/teaching-acts/services/`<br/>`CaseSummaryService.ts` | å­¦ä¹ æŠ¥å‘Šç”Ÿæˆ | `generateCaseSummary()` |
| **APIè·¯ç”±** | | |
| `app/api/teaching-sessions/route.ts` | ä¼šè¯ä¿å­˜API | `POST /api/teaching-sessions` |
| `app/api/teaching-sessions/[id]/route.ts` | ä¼šè¯è¯»å–API | `GET /api/teaching-sessions/:id` |
| `app/api/teaching-acts/summary/route.ts` | æŠ¥å‘Šç”ŸæˆAPI | `POST /api/teaching-acts/summary` |

---

## æ•°æ®æµå…³é”®èŠ‚ç‚¹

### ğŸ”— æ•°æ®æ¡¥æ¥ç‚¹1ï¼šæ·±åº¦åˆ†æç»“æœåŒæ­¥

**ä½ç½®**: `components/acts/DeepAnalysis.tsx:438-454`

**ä½œç”¨**: å°†ç¬¬äºŒå¹•çš„AIåˆ†æç»“æœåŒæ­¥åˆ°useTeachingStoreï¼Œä¾›ç¬¬å››å¹•ä½¿ç”¨

```typescript
// DeepAnalysisç»„ä»¶å®Œæˆåˆ†æå
const analysisData = await analyzeCase(caseData);

// ğŸ”— æ•°æ®æ¡¥æ¥ï¼šåŒæ­¥åˆ° useTeachingStoreï¼ˆç¬¬å››å¹•éœ€è¦ï¼‰
const { useTeachingStore } = await import('@/src/domains/teaching-acts/stores/useTeachingStore');
useTeachingStore.getState().setAnalysisResult(analysisData);

// éªŒè¯å†™å…¥
const stored = useTeachingStore.getState().analysisData;
console.log('âœ… [DeepAnalysis] éªŒè¯Storeå†™å…¥:', {
  resultå­˜åœ¨: !!stored.result,
  è½¬æŠ˜ç‚¹æ•°é‡: stored.result?.turningPoints?.length || 0
});
```

---

### ğŸ”— æ•°æ®æ¡¥æ¥ç‚¹2ï¼šè‹æ ¼æ‹‰åº•å¯¹è¯levelåŒæ­¥

**ä½ç½®**: `src/domains/socratic-dialogue/stores/useSocraticDialogueStore.ts:92-108`

**ä½œç”¨**: å°†å¯¹è¯éš¾åº¦ç­‰çº§å®æ—¶åŒæ­¥åˆ°useTeachingStore

```typescript
// useSocraticDialogueStoreçš„addMessageæ–¹æ³•ä¸­
addMessage: (message) => {
  set(state => {
    state.messages.push(message);

    // ğŸ”— æ•°æ®æ¡¥æ¥ï¼šåŒæ­¥levelåˆ° useTeachingStore
    import('@/src/domains/teaching-acts/stores/useTeachingStore').then(({ useTeachingStore }) => {
      const levelMap = { beginner: 1, intermediate: 2, advanced: 3 };
      const numericLevel = levelMap[state.currentLevel] || 1;

      const teachingStore = useTeachingStore.getState();
      while (teachingStore.socraticData.level < numericLevel) {
        teachingStore.progressSocraticLevel();
      }
    });
  });
}
```

---

### ğŸ”— æ•°æ®æ±‡æ€»ç‚¹ï¼šç¬¬å››å¹•æ•°æ®æ”¶é›†

**ä½ç½®**: `components/acts/ActFour.tsx:42-78`

**ä½œç”¨**: æ±‡æ€»å‰ä¸‰å¹•çš„æ‰€æœ‰æ•°æ®ï¼Œä¼ é€’ç»™æŠ¥å‘Šç”ŸæˆAPI

```typescript
const generateReport = async () => {
  // ğŸ”§ ä»å®¢æˆ·ç«¯Storeè¯»å–æ•°æ®
  const store = useTeachingStore.getState();
  const requestData = {
    uploadData: store.uploadData,           // âœ… ç¬¬ä¸€å¹•æ•°æ®
    analysisData: store.analysisData,       // âœ… ç¬¬äºŒå¹•æ•°æ®
    socraticData: {                         // âœ… ç¬¬ä¸‰å¹•æ•°æ®
      level: store.socraticData.level,
      completedNodes: Array.from(store.socraticData.completedNodes),
    }
  };

  console.log('ğŸ“¤ [ActFour] å‘é€Storeæ•°æ®åˆ°API:', {
    uploadDataå­˜åœ¨: !!requestData.uploadData.extractedElements,
    analysisDataå­˜åœ¨: !!requestData.analysisData.result,
    socraticLevel: requestData.socraticData.level
  });

  // å‘é€åˆ°åç«¯ç”ŸæˆæŠ¥å‘Š
  const response = await fetch('/api/teaching-acts/summary', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestData)
  });

  const { data: report } = await response.json();
  setCaseLearningReport(report);
  markActComplete('summary');
};
```

---

## æ¶æ„ä¼˜åŠ¿ä¸ç‰¹ç‚¹

### âœ… æ ¸å¿ƒä¼˜åŠ¿

1. **æ¸…æ™°çš„æ•°æ®æµå‘**
   - å•å‘æ•°æ®æµï¼šUI â†’ Store â†’ Repository â†’ Database
   - æ¯ä¸ªç¯èŠ‚èŒè´£æ˜ç¡®ï¼Œæ˜“äºè¿½è¸ªå’Œè°ƒè¯•

2. **ç»“æ„åŒ–JSONBå­˜å‚¨**
   - æ¯å¹•æ•°æ®ç»†åˆ†ä¸ºå¤šä¸ªå­—æ®µï¼ˆ30åˆ—ï¼‰
   - æ—¢ä¿æŒäº†çµæ´»æ€§ï¼Œåˆä¾¿äºæŸ¥è¯¢å’Œç´¢å¼•

3. **åŒå±‚æŒä¹…åŒ–ç­–ç•¥**
   - localStorageï¼šç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼ˆå¿«é€Ÿã€æ— ç½‘ç»œï¼‰
   - PostgreSQLï¼šæ•°æ®å®‰å…¨ä¼˜å…ˆï¼ˆæ°¸ä¹…ã€è·¨è®¾å¤‡ï¼‰

4. **ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶**
   - schema_versionï¼šæ”¯æŒæ•°æ®åº“ç»“æ„å‡çº§
   - data_versionï¼šæ”¯æŒæ•°æ®æ ¼å¼å‘åå…¼å®¹

5. **çŠ¶æ€æœºç®¡ç†**
   - session_stateå­—æ®µæ˜ç¡®ä¼šè¯çŠ¶æ€
   - æ”¯æŒçŠ¶æ€è½¬æ¢éªŒè¯å’Œè¿›åº¦è¿½è¸ª

6. **è½¯åˆ é™¤è®¾è®¡**
   - deleted_atå­—æ®µå®ç°é€»è¾‘åˆ é™¤
   - æ•°æ®å¯æ¢å¤ï¼Œç¬¦åˆæ•™è‚²åœºæ™¯éœ€æ±‚

---

## æ€§èƒ½æŒ‡æ ‡

### ğŸ“Š å½“å‰æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **localStorageä½¿ç”¨** | 40-160KB | å…¸å‹æ¡ˆä¾‹ |
| **æ•°æ®åº“å•è¡Œå¤§å°** | 50-200KB | JSONBå‹ç¼©å |
| **ç¬¬ä¸€å¹•æå–è€—æ—¶** | 2-5ç§’ | AIæå– + è§„åˆ™åŒ¹é… |
| **ç¬¬äºŒå¹•åˆ†æè€—æ—¶** | 5-10ç§’ | å¤šä¸ªAIåˆ†æå™¨å¹¶è¡Œ |
| **ç¬¬ä¸‰å¹•å¯¹è¯å“åº”** | 1-3ç§’ | å•æ¬¡AIè°ƒç”¨ |
| **ç¬¬å››å¹•æŠ¥å‘Šç”Ÿæˆ** | 5-8ç§’ | AIç»¼åˆç”Ÿæˆ |
| **ä¼šè¯ä¿å­˜è€—æ—¶** | 100-300ms | æ•°æ®åº“INSERT |
| **ä¼šè¯æ¢å¤è€—æ—¶** | 50-150ms | æ•°æ®åº“SELECT |

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### ğŸš€ çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰

1. **IndexedDBè¿ç§»**
   - è§£å†³localStorage 5MBé™åˆ¶
   - æ”¯æŒæ›´å¤§çš„æ¡ˆä¾‹æ–‡æ¡£
   - æå‡æ•°æ®æŸ¥è¯¢æ€§èƒ½

2. **å¢é‡ä¿å­˜æœºåˆ¶**
   - å½“å‰ï¼šä»…"å®Œæˆå­¦ä¹ "æ—¶ä¿å­˜
   - ä¼˜åŒ–ï¼šæ¯å¹•å®Œæˆåè‡ªåŠ¨ä¿å­˜
   - å‡å°‘æ•°æ®ä¸¢å¤±é£é™©

3. **æ•°æ®å‹ç¼©**
   - ä½¿ç”¨LZ-Stringå‹ç¼©JSONB
   - é¢„æœŸå‹ç¼©ç‡ï¼š60-80%
   - é™ä½å­˜å‚¨å’Œä¼ è¾“æˆæœ¬

### ğŸŒŸ é•¿æœŸä¼˜åŒ–ï¼ˆ3-6æœˆï¼‰

1. **åˆ†å¸ƒå¼ç¼“å­˜**
   - å¼•å…¥Redisç¼“å­˜å±‚
   - ç¼“å­˜çƒ­ç‚¹ä¼šè¯æ•°æ®
   - æå‡æŸ¥è¯¢æ€§èƒ½

2. **æ•°æ®åˆ†æå¹³å°**
   - å­¦ä¹ è¡Œä¸ºåˆ†æ
   - æ•™å­¦è´¨é‡è¯„ä¼°
   - AIæ•ˆæœè¿½è¸ª

3. **ç¦»çº¿æ”¯æŒ**
   - PWA + Service Worker
   - ç¦»çº¿å­¦ä¹ æ¨¡å¼
   - æ•°æ®åŒæ­¥æœºåˆ¶

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### ğŸ” é—®é¢˜1ï¼šç¬¬å››å¹•æŠ¥å‘Šæ•°æ®ä¸å®Œæ•´

**ç°è±¡**ï¼šç”Ÿæˆçš„æŠ¥å‘Šç¼ºå°‘å‰ä¸‰å¹•çš„å…³é”®ä¿¡æ¯

**æ’æŸ¥æ­¥éª¤**ï¼š
```typescript
// 1. æ£€æŸ¥Storeæ•°æ®å®Œæ•´æ€§
const store = useTeachingStore.getState();
console.log({
  uploadData: !!store.uploadData.extractedElements,
  analysisData: !!store.analysisData.result,
  socraticLevel: store.socraticData.level
});

// 2. æ£€æŸ¥localStorageæŒä¹…åŒ–
const persisted = localStorage.getItem('teaching-store');
console.log('Persisted data:', JSON.parse(persisted));

// 3. æ£€æŸ¥APIè¯·æ±‚ä½“
// åœ¨ActFour.tsxçš„generateReportä¸­æ·»åŠ æ—¥å¿—
```

**å¸¸è§åŸå› **ï¼š
- localStorageè¢«æ¸…ç†
- Storeæ•°æ®æœªæ­£ç¡®å†™å…¥
- APIä¼ é€’æ•°æ®æ—¶ä¸¢å¤±

---

### ğŸ” é—®é¢˜2ï¼šä¼šè¯æ¢å¤åæ•°æ®ä¸¢å¤±

**ç°è±¡**ï¼šä»æ•°æ®åº“æ¢å¤ä¼šè¯åï¼Œéƒ¨åˆ†æ•°æ®ç¼ºå¤±

**æ’æŸ¥æ­¥éª¤**ï¼š
```sql
-- 1. æ£€æŸ¥æ•°æ®åº“æ•°æ®å®Œæ•´æ€§
SELECT
  id,
  case_title,
  act1_basic_info IS NOT NULL as has_act1,
  act2_timeline_analysis IS NOT NULL as has_act2,
  act3_socratic IS NOT NULL as has_act3,
  act4_learning_report IS NOT NULL as has_act4
FROM teaching_sessions_v2
WHERE id = 'session-uuid';
```

**å¸¸è§åŸå› **ï¼š
- buildColumnPayloadæ˜ å°„é”™è¯¯
- mapRowToEntityæ¢å¤é€»è¾‘é”™è¯¯
- æ•°æ®æ ¼å¼ç‰ˆæœ¬ä¸å…¼å®¹

---

## ç›¸å…³æ–‡æ¡£

- [CLAUDE.md](../CLAUDE.md) - é¡¹ç›®æ¶æ„æ€»è§ˆ
- [å››å¹•æ•™å­¦æ•°æ®æµè¯¦ç»†åˆ†æ](../åŠŸèƒ½æ–‡æ¡£/å››å¹•æ•™å­¦/FOURTH_ACT_DATA_FLOW_ANALYSIS.md)
- [æ•°æ®æŒä¹…åŒ–åˆ†æ](../åŠŸèƒ½æ–‡æ¡£/å››å¹•æ•™å­¦/FOURTH_ACT_DATA_PERSISTENCE_ANALYSIS.md)
- [Snapshotç³»ç»Ÿä¼˜åŒ–æŒ‡å—](../åŠŸèƒ½æ–‡æ¡£/å››å¹•æ•™å­¦/snapshot-system-optimization-guide.md)

---

## ç»´æŠ¤æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ç»´æŠ¤è€… |
|------|------|---------|--------|
| 2025-10-21 | v3.0 | åˆ›å»ºæ–°ç‰ˆæ¶æ„æ€»è§ˆæ–‡æ¡£ï¼ŒåŸºäºå½“å‰ç”Ÿäº§ç¯å¢ƒ | Claude Code |
| 2025-01-21 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼ˆarchitecture-and-dataflow.mdï¼‰ | Team |

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯ - åŸºäºç”Ÿäº§ç¯å¢ƒä»£ç 
**ç»´æŠ¤æ‰¿è¯º**: æ¯æ¬¡é‡å¤§æ¶æ„å˜æ›´åæ›´æ–°
**åé¦ˆæ¸ é“**: GitHub Issues

