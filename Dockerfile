# =============================================================================
# æ³•å­¦æ•™è‚²å¹³å° - Docker è½»é‡çº§é•œåƒï¼ˆä¼˜åŒ–ç‰ˆ v4.0ï¼‰
# =============================================================================
# ğŸš€ æ–°æ–¹æ¡ˆï¼šä½¿ç”¨æœ¬åœ°é¢„æ„å»ºäº§ç‰©
# - æœ¬åœ° .next/ å’Œ node_modules/ å·²å‡†å¤‡å¥½
# - Dockeråªè´Ÿè´£æ‰“åŒ…å’Œè¿è¡Œï¼Œä¸é‡æ–°æ„å»º
# - æ„å»ºæ—¶é—´ä»20åˆ†é’Ÿé™ä½åˆ°30ç§’ âš¡
# =============================================================================

FROM node:20

WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# =============================================================================
# åˆ›å»ºé root ç”¨æˆ·å’Œå®‰è£…åŸºç¡€å·¥å…·
# =============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && addgroup --system --gid 1001 nodejs \
    && adduser --system --uid 1001 nextjs

# å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨ï¼ˆç”¨äºåŒæ—¶è¿è¡ŒNext.jså’ŒSocket.IOï¼‰
RUN npm install -g pm2

# =============================================================================
# ğŸ“¦ å¤åˆ¶é¢„æ„å»ºçš„äº§ç‰©ï¼ˆæœ€å…³é”® - æå¿«ï¼‰
# =============================================================================

# 1. å¤åˆ¶packageæ–‡ä»¶
COPY --chown=nextjs:nodejs package.json package-lock.json ./

# 2. å¤åˆ¶é¢„å®‰è£…çš„ node_modulesï¼ˆ~600MBï¼Œå·²åŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
COPY --chown=nextjs:nodejs node_modules ./node_modules

# 3. å¤åˆ¶é¢„ç¼–è¯‘çš„ .next ç›®å½•ï¼ˆ~200MBï¼ŒNext.jsåº”ç”¨äº§ç‰©ï¼‰
COPY --chown=nextjs:nodejs .next ./.next

# 4. å¤åˆ¶å…¬å…±æ–‡ä»¶
COPY --chown=nextjs:nodejs public ./public

# 5. å¤åˆ¶Socket.IOæœåŠ¡å™¨å’ŒPM2é…ç½®
COPY --chown=nextjs:nodejs server ./server
COPY --chown=nextjs:nodejs ecosystem.config.js ./ecosystem.config.js

# =============================================================================
# ğŸ”§ ç¯å¢ƒå˜é‡è¿è¡Œæ—¶æ³¨å…¥è„šæœ¬
# =============================================================================
# å…³é”®ï¼šè¿™äº›è„šæœ¬ä¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œ
# ä½œç”¨ï¼šåŠ¨æ€ç”Ÿæˆ.env.productionï¼Œå°†docker run -eä¼ å…¥çš„ç¯å¢ƒå˜é‡æ³¨å…¥åˆ°åº”ç”¨ä¸­
# =============================================================================

# å¤åˆ¶ç¯å¢ƒå˜é‡è„šæœ¬ï¼ˆæ ¸å¿ƒï¼šè¿è¡Œæ—¶åŠ¨æ€æ³¨å…¥ç¯å¢ƒå˜é‡ï¼‰
COPY --chown=nextjs:nodejs scripts/generate-env.sh ./scripts/generate-env.sh
COPY --chown=nextjs:nodejs scripts/check-env.sh ./scripts/check-env.sh

# èµ‹äºˆæ‰§è¡Œæƒé™
RUN chmod +x ./scripts/generate-env.sh ./scripts/check-env.sh

# =============================================================================
# åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼ˆæ—¥å¿—ã€æ•°æ®ç­‰ï¼‰
# =============================================================================
RUN mkdir -p /app/logs /app/data \
    && chown -R nextjs:nodejs /app/logs /app/data

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nextjs

# =============================================================================
# æš´éœ²ç«¯å£å’Œå¥åº·æ£€æŸ¥
# =============================================================================
EXPOSE 3000 3001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"

# =============================================================================
# ğŸš€ å¯åŠ¨å‘½ä»¤ - ä¸‰æ­¥åˆå§‹åŒ–æµç¨‹
# =============================================================================
# æ‰§è¡Œé¡ºåºï¼ˆç¡®ä¿æ‰€æœ‰APIç¯å¢ƒå˜é‡éƒ½è¢«æ­£ç¡®æ³¨å…¥ï¼‰ï¼š
# 1. generate-env.sh   â†’ ç”Ÿæˆ.env.productionï¼ŒåŠ¨æ€æ³¨å…¥docker run -eä¼ å…¥çš„ç¯å¢ƒå˜é‡
# 2. check-env.sh      â†’ éªŒè¯å¿…è¦çš„APIå¯†é’¥å·²è®¾ç½®ï¼ˆDEEPSEEK_API_KEYã€NEXT_PUBLIC_AI_302_API_KEYç­‰ï¼‰
# 3. pm2-runtime       â†’ å¯åŠ¨Next.jsï¼ˆ3000ï¼‰+ Socket.IOï¼ˆ3001ï¼‰æœåŠ¡
# =============================================================================

CMD ["sh", "-c", "set -e && \
  echo 'ğŸš€ [1/3] ç”Ÿæˆè¿è¡Œæ—¶ç¯å¢ƒå˜é‡...' && \
  ./scripts/generate-env.sh && \
  echo 'âœ“ ç¯å¢ƒå˜é‡ç”Ÿæˆå®Œæˆ' && \
  echo '' && \
  echo 'ğŸ” [2/3] éªŒè¯ç¯å¢ƒå˜é‡...' && \
  ./scripts/check-env.sh && \
  echo 'âœ“ ç¯å¢ƒå˜é‡éªŒè¯å®Œæˆ' && \
  echo '' && \
  echo 'ğŸ¬ [3/3] å¯åŠ¨æœåŠ¡...' && \
  pm2-runtime ecosystem.config.js"]
