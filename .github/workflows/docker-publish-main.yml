# =============================================================================
# GitHub Actions - ä¸»åˆ†æ”¯è‡ªåŠ¨æž„å»ºDockeré•œåƒ
# =============================================================================
# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ°mainåˆ†æ”¯
# åŠŸèƒ½ï¼š
#   1. è‡ªåŠ¨æž„å»º Docker é•œåƒ
#   2. æŽ¨é€åˆ° GitHub Container Registry (GHCR)
#   3. æ ‡ç­¾ï¼šlatest + commit SHA
#   4. éªŒè¯Socket.IOä¾èµ–å®Œæ•´æ€§
# =============================================================================

name: Build Docker Image on Main Push

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/**'

  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push Docker Image (Main)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=main-
            type=raw,value=deploy-${{ github.run_number }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Docker Image Health
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” [CI] é•œåƒå®Œæ•´æ€§éªŒè¯ï¼ˆæ²»æœ¬æ–¹æ¡ˆ v2.0ï¼‰"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

          echo "ðŸ“¦ æ£€æŸ¥æ ¸å¿ƒä¾èµ–ï¼ˆè‡ªåŠ¨å®‰è£…éªŒè¯ï¼‰..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            sh -c '
              # Socket.IOæ ¸å¿ƒä¾èµ–æ£€æŸ¥
              test -d /app/node_modules/socket.io && echo "  âœ… socket.io" || exit 1
              test -d /app/node_modules/socket.io-client && echo "  âœ… socket.io-client" || exit 1
              test -d /app/node_modules/engine.io && echo "  âœ… engine.io" || exit 1

              # ä¼ é€’ä¾èµ–æ£€æŸ¥ï¼ˆIssue #49, #50ä¿®å¤éªŒè¯ï¼‰
              test -d /app/node_modules/negotiator && echo "  âœ… negotiator (ä¼ é€’ä¾èµ–)" || exit 1
              test -d /app/node_modules/accepts && echo "  âœ… accepts" || exit 1
              test -d /app/node_modules/cors && echo "  âœ… cors" || exit 1
              test -d /app/node_modules/mime-types && echo "  âœ… mime-types" || exit 1

              # AIç›¸å…³ä¾èµ–
              test -d /app/node_modules/tiktoken && echo "  âœ… tiktoken (WASM)" || exit 1

              # Socket.IOæœåŠ¡å™¨æ–‡ä»¶
              test -d /app/server && echo "  âœ… Socket.IO server" || exit 1
              test -f /app/server/socket-server.js && echo "  âœ… socket-server.js" || exit 1

              # çŽ¯å¢ƒéªŒè¯è„šæœ¬
              test -f /app/scripts/check-env.sh && echo "  âœ… check-env.sh" || exit 1
              test -x /app/scripts/check-env.sh && echo "  âœ… check-env.sh (å¯æ‰§è¡Œ)" || exit 1

              echo ""
              echo "âœ… æ‰€æœ‰æ ¸å¿ƒä¾èµ–éªŒè¯é€šè¿‡ï¼"
            '

          echo ""
          echo "ðŸ§ª æµ‹è¯•çŽ¯å¢ƒå˜é‡éªŒè¯è„šæœ¬..."
          docker run --rm \
            -e DEEPSEEK_API_KEY=test-key \
            -e NEXT_PUBLIC_DEEPSEEK_API_KEY=test-key \
            -e NODE_ENV=production \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            sh -c './scripts/check-env.sh'

          echo ""
          echo "âœ… é•œåƒå¥åº·æ£€æŸ¥å®Œæˆï¼"

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Dockeré•œåƒæž„å»ºå®Œæˆï¼ˆæ²»æœ¬æ–¹æ¡ˆ v2.0ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Additional Tag:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:deploy-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… æ ¸å¿ƒæ”¹è¿›" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ä¾èµ–è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šä½¿ç”¨ \`npm ci --only=production\` è‡ªåŠ¨å®‰è£…æ‰€æœ‰ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ä¼ é€’ä¾èµ–å®Œæ•´**ï¼šè‡ªåŠ¨å¤„ç† Socket.IO çš„æ‰€æœ‰ä¼ é€’ä¾èµ–ï¼ˆIssue #49, #50 å½»åº•ä¿®å¤ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **çŽ¯å¢ƒå˜é‡éªŒè¯**ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥å¿…éœ€çš„çŽ¯å¢ƒå˜é‡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **å¯ç»´æŠ¤æ€§æå‡**ï¼šsocket.io å‡çº§ä¸å†éœ€è¦ä¿®æ”¹ Dockerfile" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ å·²éªŒè¯çš„ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          echo "- Socket.IO (v4.8.1) + æ‰€æœ‰ä¼ é€’ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          echo "- tiktoken (WASMä¾èµ–)" >> $GITHUB_STEP_SUMMARY
          echo "- çŽ¯å¢ƒå˜é‡éªŒè¯è„šæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ éƒ¨ç½²å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# 1. æ‹‰å–æœ€æ–°é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 2. ç¡®ä¿çŽ¯å¢ƒå˜é‡æ–‡ä»¶å­˜åœ¨ï¼ˆå¿…éœ€ï¼ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "# å‚è€ƒ .env.example åˆ›å»º .env.production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 3. é‡å¯æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.prod.yml down" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.prod.yml up -d" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 4. éªŒè¯éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "docker logs law-edu-app-prod --tail 50" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ éƒ¨ç½²å‰å¿…è¯»" >> $GITHUB_STEP_SUMMARY
          echo "**å¿…éœ€çš„çŽ¯å¢ƒå˜é‡**ï¼ˆå®¹å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨éªŒè¯ï¼‰ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- \`DEEPSEEK_API_KEY\` - DeepSeek AIå¯†é’¥" >> $GITHUB_STEP_SUMMARY
          echo "- \`AI_302_API_KEY\` - 302.ai PPTç”Ÿæˆå¯†é’¥ï¼ˆæœåŠ¡ç«¯è¯»å–ï¼Œå‰ç«¯ä»…è®¿é—® \`/api/ppt\`ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚æžœçŽ¯å¢ƒå˜é‡ç¼ºå¤±ï¼Œå®¹å™¨å°†æ‹’ç»å¯åŠ¨å¹¶æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
