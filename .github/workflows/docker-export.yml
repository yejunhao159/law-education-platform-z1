# =============================================================================
# GitHub Actions - Dockeré•œåƒæ„å»ºå’Œå¯¼å‡º
# =============================================================================
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°mainåˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½ï¼š
#   1. æ„å»ºå®Œæ•´çš„Dockeré•œåƒ
#   2. å¯¼å‡ºä¸ºtaræ–‡ä»¶å¹¶ä¸Šä¼ ä¸ºGitHub Actions artifact
#   3. éªŒè¯é•œåƒåŠŸèƒ½
#   4. ç”Ÿæˆéƒ¨ç½²æ–‡æ¡£
# =============================================================================

name: Docker Build and Export

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/**'

  workflow_dispatch:
    inputs:
      deploy_version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.2.0)'
        required: false
        default: 'latest'
        type: string

env:
  IMAGE_NAME: law-education-platform-z1
  IMAGE_TAG: ${{ github.event.inputs.deploy_version || 'latest' }}

jobs:
  # ============================================
  # Job 1: æ„å»ºDockeré•œåƒ
  # ============================================
  build-and-export:
    name: Build Docker Image and Export
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker metadata
        id: meta
        run: |
          echo "IMAGE_TAG=${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "IMAGE_FULL_NAME=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "GIT_SHA=${{ github.sha }}" >> $GITHUB_ENV

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true  # å°†é•œåƒåŠ è½½åˆ°Docker daemon
          tags: ${{ env.IMAGE_FULL_NAME }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_NAME }}
            org.opencontainers.image.version=${{ env.IMAGE_TAG }}
            org.opencontainers.image.created=${{ env.BUILD_DATE }}
            org.opencontainers.image.revision=${{ env.GIT_SHA }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}

      - name: Verify Docker image
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” [CI] é•œåƒå®Œæ•´æ€§éªŒè¯"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          docker images ${{ env.IMAGE_FULL_NAME }}

          # åˆ›å»ºä¸´æ—¶å®¹å™¨è¿›è¡ŒåŠŸèƒ½éªŒè¯
          echo "ğŸ“¦ æ£€æŸ¥æ ¸å¿ƒä¾èµ–..."
          docker run --rm --name temp-test ${{ env.IMAGE_FULL_NAME }} \
            sh -c '
              # åŸºç¡€æ£€æŸ¥
              test -d /app/node_modules && echo "  âœ… node_modules" || exit 1
              test -f /app/server/socket-server.js && echo "  âœ… socket-server.js" || exit 1
              test -f /app/ecosystem.config.js && echo "  âœ… ecosystem.config.js" || exit 1
              test -f /app/scripts/check-env.sh && echo "  âœ… check-env.sh" || exit 1
              test -f /app/scripts/init-database.js && echo "  âœ… init-database.js" || exit 1
              test -f /app/scripts/test-ppt-functionality.js && echo "  âœ… test-ppt-functionality.js" || exit 1

              # æ£€æŸ¥å…³é”®ä¾èµ–
              test -d /app/node_modules/bcryptjs && echo "  âœ… bcryptjs (å¯†ç åŠ å¯†)" || exit 1
              test -d /app/node_modules/better-sqlite3 && echo "  âœ… better-sqlite3 (æ•°æ®åº“)" || exit 1
              test -d /app/node_modules/socket.io && echo "  âœ… socket.io" || exit 1

              echo ""
              echo "âœ… æ‰€æœ‰æ ¸å¿ƒç»„ä»¶éªŒè¯é€šè¿‡ï¼"
            '

      - name: Export Docker image to tar
        run: |
          echo "ğŸ“¦ [CI] å¯¼å‡ºDockeré•œåƒä¸ºtaræ–‡ä»¶..."
          docker save ${{ env.IMAGE_FULL_NAME }} | gzip > ${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar.gz
          ls -lh ${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar.gz

      - name: Generate deployment package
        run: |
          echo "ğŸ“‹ [CI] ç”Ÿæˆéƒ¨ç½²åŒ…..."

          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p deployment-package

          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp ${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar.gz deployment-package/
          cp docker-compose.prod.yml deployment-package/
          cp .env.production.example deployment-package/.env.production.example
          cp .env.production.configured deployment-package/.env.production.configured
          cp scripts/quick-deploy.sh deployment-package/
          chmod +x deployment-package/quick-deploy.sh

          # ç”Ÿæˆéƒ¨ç½²è¯´æ˜
          cat > deployment-package/README.md << 'EOF'
          # æ³•å­¦æ•™è‚²å¹³å° - éƒ¨ç½²åŒ…

          ## ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `IMAGE.tar.gz` - Dockeré•œåƒæ–‡ä»¶
          - `docker-compose.prod.yml` - Docker Composeé…ç½®
          - `.env.production.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿
          - `DEPLOY-GUIDE.md` - éƒ¨ç½²æŒ‡å—ï¼ˆæœ¬æ–‡ä»¶ï¼‰

          ## ğŸš€ å¿«é€Ÿéƒ¨ç½²

          ### 1. ä¸Šä¼ åˆ°æœåŠ¡å™¨
          ```bash
          # å°†æ•´ä¸ªdeployment-packageæ–‡ä»¶å¤¹ä¸Šä¼ åˆ°æœåŠ¡å™¨
          scp -r deployment-package/ user@your-server:/opt/law-education-platform/
          ```

          ### 2. åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²

          #### æ–¹æ³•1ï¼šä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰
          ```bash
          cd /opt/law-education-platform/

          # è¿è¡Œä¸€é”®éƒ¨ç½²è„šæœ¬
          ./quick-deploy.sh IMAGE.tar.gz
          ```

          #### æ–¹æ³•2ï¼šæ‰‹åŠ¨éƒ¨ç½²
          ```bash
          cd /opt/law-education-platform/

          # åŠ è½½Dockeré•œåƒ
          docker load < IMAGE.tar.gz

          # ä½¿ç”¨é¢„é…ç½®çš„ç¯å¢ƒå˜é‡ï¼ˆå·²åŒ…å«APIå¯†é’¥ï¼‰
          cp .env.production.configured .env.production

          # å¯åŠ¨æœåŠ¡
          docker-compose -f docker-compose.prod.yml up -d

          # æŸ¥çœ‹æ—¥å¿—
          docker-compose -f docker-compose.prod.yml logs -f
          ```

          ### 3. éªŒè¯éƒ¨ç½²
          ```bash
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          docker-compose -f docker-compose.prod.yml ps

          # æ£€æŸ¥å¥åº·çŠ¶æ€
          curl http://localhost:3000/api/health

          # æµ‹è¯•ç™»å½•
          # è®¿é—®: http://your-server:3000/login
          # ä½¿ç”¨è´¦å·: teacher01 - teacher05, å¯†ç : 2025
          ```

          ## âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®

          ç¼–è¾‘ `.env.production` æ–‡ä»¶ï¼Œé…ç½®ä»¥ä¸‹å¿…éœ€å˜é‡ï¼š

          ```bash
          # DeepSeek AI (å¿…éœ€)
          DEEPSEEK_API_KEY=your_deepseek_api_key
          NEXT_PUBLIC_DEEPSEEK_API_KEY=your_deepseek_api_key

          # 302.ai PPT (é‡è¦)
          NEXT_PUBLIC_AI_302_API_KEY=your_302_api_key

          # å…¶ä»–é…ç½®
          NODE_ENV=production
          ```

          ## ğŸ”§ æ•…éšœæ’é™¤

          ### å®¹å™¨æ— æ³•å¯åŠ¨
          ```bash
          # æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
          docker-compose -f docker-compose.prod.yml logs app

          # æ£€æŸ¥ç¯å¢ƒå˜é‡
          docker-compose -f docker-compose.prod.yml exec app printenv | grep -E "(DEEPSEEK|AI_302)"
          ```

          ### ç™»å½•å¤±è´¥
          ```bash
          # æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
          docker-compose -f docker-compose.prod.yml exec app ls -la /app/data/

          # é‡æ–°åˆå§‹åŒ–æ•°æ®åº“
          docker-compose -f docker-compose.prod.yml exec app node scripts/init-database.js
          ```

          ### PPTåŠŸèƒ½å¼‚å¸¸
          ```bash
          # æµ‹è¯•PPTåŠŸèƒ½
          docker-compose -f docker-compose.prod.yml exec app node scripts/test-ppt-functionality.js
          ```

          ## ğŸ“ æ”¯æŒ

          å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
          1. ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®
          2. APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
          3. æœåŠ¡å™¨èµ„æºæ˜¯å¦å……è¶³
          4. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
          EOF

          # é‡å‘½åREADMEä¸ºæ›´å…·ä½“çš„åç§°
          mv deployment-package/README.md deployment-package/DEPLOY-GUIDE.md

      - name: Upload deployment package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: law-education-platform-deployment-${{ env.IMAGE_TAG }}
          path: deployment-package/
          retention-days: 30

      - name: Create deployment summary
        run: |
          echo "## ğŸš€ Dockeré•œåƒæ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒ:** \`${{ env.IMAGE_FULL_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´:** \`${{ env.BUILD_DATE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### âœ… æ–°å¢åŠŸèƒ½ä¿®å¤" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **æ•°æ®åº“è‡ªåŠ¨åˆå§‹åŒ–**ï¼šå®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºç”¨æˆ·æ•°æ®" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ç™»å½•é—®é¢˜ä¿®å¤**ï¼šå†…ç½®5ä¸ªæµ‹è¯•è´¦å· (teacher01-05, å¯†ç : 2025)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **PPTåŠŸèƒ½å®Œå–„**ï¼šæ”¯æŒ302.ai PPTç”Ÿæˆï¼ŒåŒ…å«åŠŸèƒ½æµ‹è¯•è„šæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ç¯å¢ƒå˜é‡éªŒè¯**ï¼šå¯åŠ¨å‰æ£€æŸ¥æ‰€æœ‰å¿…éœ€é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **å¥åº·æ£€æŸ¥å¢å¼º**ï¼šéªŒè¯æ•°æ®åº“å’ŒæœåŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“¦ éƒ¨ç½²æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
          echo "1. **ä¸‹è½½éƒ¨ç½²åŒ…**ï¼šä»GitHub Actions Artifactsä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "2. **ä¸Šä¼ åˆ°æœåŠ¡å™¨**ï¼šå°†æ•´ä¸ªåŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨" >> $GITHUB_STEP_SUMMARY
          echo "3. **åŠ è½½é•œåƒ**ï¼š`docker load < IMAGE.tar.gz`" >> $GITHUB_STEP_SUMMARY
          echo "4. **é…ç½®ç¯å¢ƒ**ï¼šç¼–è¾‘ `.env.production` æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "5. **å¯åŠ¨æœåŠ¡**ï¼š`docker-compose -f docker-compose.prod.yml up -d`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ¯ é¢„ç½®è´¦å·" >> $GITHUB_STEP_SUMMARY
          echo "| ç”¨æˆ·å | å¯†ç  | è§’è‰² |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| teacher01 | 2025 | ç®¡ç†å‘˜ |" >> $GITHUB_STEP_SUMMARY
          echo "| teacher02 | 2025 | æ•™å¸ˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| teacher03 | 2025 | æ•™å¸ˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| teacher04 | 2025 | æ•™å¸ˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| teacher05 | 2025 | æ•™å¸ˆ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ”— ä¸‹è½½é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ [éƒ¨ç½²åŒ…ä¸‹è½½](actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY