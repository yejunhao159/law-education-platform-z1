# =============================================================================
# ä¼ä¸šçº§ CI/CD Pipeline - Docker æž„å»ºå’Œå‘å¸ƒ
# =============================================================================
# åŠŸèƒ½ï¼š
#   1. æž„å»º Docker é•œåƒï¼ˆæ”¯æŒç¼“å­˜åŠ é€Ÿï¼‰
#   2. å®‰å…¨æ‰«æï¼ˆTrivyï¼‰
#   3. æŽ¨é€åˆ° GitHub Container Registry (GHCR)
#   4. æŽ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“
#   5. ç”Ÿæˆéƒ¨ç½²æ‘˜è¦å’Œå‘½ä»¤
#
# è§¦å‘æ¡ä»¶ï¼š
#   - Push to main â†’ latest æ ‡ç­¾
#   - Push tag (v*) â†’ ç‰ˆæœ¬æ ‡ç­¾
#   - Manual trigger â†’ è‡ªå®šä¹‰å‚æ•°
# =============================================================================

name: ðŸš€ Docker Build & Publish

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/**'

  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'è‡ªå®šä¹‰æ ‡ç­¾åŽç¼€ (ä¾‹å¦‚: test, staging)'
        required: false
        default: ''

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_ALIYUN: ${{ secrets.ALIYUN_REGISTRY }}
  IMAGE_NAME: ${{ github.repository }}
  ALIYUN_IMAGE_REPO: ${{ secrets.ALIYUN_IMAGE_REPO }}

jobs:
  # ===========================================================================
  # Job 1: æž„å»º Docker é•œåƒ
  # ===========================================================================
  build-and-push:
    name: ðŸ—ï¸ Build and Push Docker Image
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      security-events: write

    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      # -----------------------------------------------------------------------
      # 1. å‡†å¤‡é˜¶æ®µ
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      # -----------------------------------------------------------------------
      # 2. ç¡®å®šé•œåƒæ ‡ç­¾
      # -----------------------------------------------------------------------
      - name: ðŸ·ï¸ Generate image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}
          tags: |
            # main åˆ†æ”¯ â†’ latest
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            # tag æŽ¨é€ â†’ ç‰ˆæœ¬å·
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # commit SHA (å‰7ä½)
            type=sha,prefix={{branch}}-,format=short
            # è‡ªå®šä¹‰åŽç¼€
            type=raw,value=${{ github.event.inputs.tag_suffix }},enable=${{ github.event.inputs.tag_suffix != '' }}
          labels: |
            org.opencontainers.image.title=æ³•å­¦æ•™è‚²å¹³å°
            org.opencontainers.image.description=åŸºäºŽè‹æ ¼æ‹‰åº•æ•™å­¦æ³•çš„äº¤äº’å¼æ³•å­¦æ•™è‚²å¹³å°
            org.opencontainers.image.vendor=DeepPractice.ai

      # -----------------------------------------------------------------------
      # 3. ç™»å½•åˆ°å®¹å™¨é•œåƒä»“åº“
      # -----------------------------------------------------------------------
      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Login to Aliyun Container Registry
        if: ${{ secrets.ALIYUN_REGISTRY_USER != '' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_ALIYUN }}
          username: ${{ secrets.ALIYUN_REGISTRY_USER }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      # -----------------------------------------------------------------------
      # 4. æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
      # -----------------------------------------------------------------------
      - name: ðŸš€ Build and push to GHCR
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
            AI_302_API_KEY=${{ secrets.AI_302_API_KEY }}
            NEXT_PUBLIC_BASE_URL=${{ secrets.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000' }}

      # -----------------------------------------------------------------------
      # 5. åŒæ—¶æŽ¨é€åˆ°é˜¿é‡Œäº‘ï¼ˆå¦‚æžœé…ç½®äº†ï¼‰
      # -----------------------------------------------------------------------
      - name: ðŸ·ï¸ Tag for Aliyun Registry
        if: ${{ secrets.ALIYUN_REGISTRY_USER != '' }}
        id: aliyun-tags
        run: |
          # èŽ·å–ä¸»è¦æ ‡ç­¾
          MAIN_TAG="${{ steps.meta.outputs.version }}"

          # æž„å»ºé˜¿é‡Œäº‘é•œåƒåœ°å€
          ALIYUN_IMAGE="${{ env.REGISTRY_ALIYUN }}/${{ env.ALIYUN_IMAGE_REPO }}"

          echo "main-tag=${ALIYUN_IMAGE}:${MAIN_TAG}" >> $GITHUB_OUTPUT
          echo "latest-tag=${ALIYUN_IMAGE}:latest" >> $GITHUB_OUTPUT

      - name: ðŸš€ Push to Aliyun Registry
        if: ${{ secrets.ALIYUN_REGISTRY_USER != '' }}
        run: |
          # ä»Ž GHCR æ‹‰å–é•œåƒ
          docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}

          # é‡æ–°æ ‡è®°ä¸ºé˜¿é‡Œäº‘é•œåƒ
          docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} \
                     ${{ steps.aliyun-tags.outputs.main-tag }}

          # æŽ¨é€åˆ°é˜¿é‡Œäº‘
          docker push ${{ steps.aliyun-tags.outputs.main-tag }}

          # å¦‚æžœæ˜¯ main åˆ†æ”¯ï¼ŒåŒæ—¶æ‰“ä¸Š latest æ ‡ç­¾
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} \
                       ${{ steps.aliyun-tags.outputs.latest-tag }}
            docker push ${{ steps.aliyun-tags.outputs.latest-tag }}
          fi

      # -----------------------------------------------------------------------
      # 6. å®‰å…¨æ‰«æ
      # -----------------------------------------------------------------------
      - name: ðŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ðŸ“¤ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # -----------------------------------------------------------------------
      # 7. ç”Ÿæˆéƒ¨ç½²æ‘˜è¦
      # -----------------------------------------------------------------------
      - name: ðŸ“‹ Generate deployment summary
        run: |
          echo "## ðŸŽ‰ Docker é•œåƒæž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“¦ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **ç‰ˆæœ¬æ ‡ç­¾** | \`${{ steps.meta.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **é•œåƒæ‘˜è¦** | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **æž„å»ºæ—¶é—´** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **æäº¤SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“¥ é•œåƒæ‹‰å–å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä»Ž GitHub Container Registry:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ secrets.ALIYUN_REGISTRY_USER }}" != "" ]]; then
            echo "**ä»Žé˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ steps.aliyun-tags.outputs.main-tag }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ðŸš€ éƒ¨ç½²å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# 1. æ‹‰å–æœ€æ–°é•œåƒ" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ secrets.ALIYUN_REGISTRY_USER }}" != "" ]]; then
            echo "docker pull ${{ steps.aliyun-tags.outputs.main-tag }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 2. é‡å¯æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.production.yml down" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.production.yml up -d" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 3. æŸ¥çœ‹æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "docker logs law-edu-app --tail 50 -f" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### âš™ï¸ çŽ¯å¢ƒå˜é‡è¦æ±‚" >> $GITHUB_STEP_SUMMARY
          echo "ç¡®ä¿æœåŠ¡å™¨çš„ \`.env.production\` æ–‡ä»¶åŒ…å«ä»¥ä¸‹å˜é‡ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- \`DEEPSEEK_API_KEY\` - DeepSeek AI å¯†é’¥" >> $GITHUB_STEP_SUMMARY
          echo "- \`AI_302_API_KEY\` - 302.ai PPT ç”Ÿæˆå¯†é’¥" >> $GITHUB_STEP_SUMMARY
          echo "- \`DB_PASSWORD\` - æ•°æ®åº“å¯†ç " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### âœ… æž„å»ºä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ä½¿ç”¨ BuildKit åŠ é€Ÿæž„å»º" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Actions ç¼“å­˜å·²å¯ç”¨" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trivy å®‰å…¨æ‰«æå·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é•œåƒå·²æŽ¨é€åˆ° 2 ä¸ªä»“åº“" >> $GITHUB_STEP_SUMMARY
