name: ğŸ³ Build and Verify Docker Image

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-verify:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Step 2: è®¾ç½® Docker Buildx
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: ç¡®å®šé•œåƒç‰ˆæœ¬æ ‡ç­¾
      - name: ğŸ“ Determine image tags
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT
          else
            VERSION=$(echo ${{ github.sha }} | cut -c1-7)
            echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT
          fi

      # Step 4: æ„å»ºDockeré•œåƒï¼ˆä¸æ¨é€ï¼‰
      - name: ğŸš€ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: legal-education:${{ steps.meta.outputs.tag_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
            NEXT_PUBLIC_AI_302_API_KEY=${{ secrets.NEXT_PUBLIC_AI_302_API_KEY }}
            NEXT_PUBLIC_BASE_URL=${{ secrets.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000' }}
            NEXT_PUBLIC_SOCKET_IO_URL=${{ secrets.NEXT_PUBLIC_SOCKET_IO_URL || 'http://localhost:3000' }}

      # Step 5: éªŒè¯é•œåƒ
      - name: ğŸ” Verify image integrity
        run: |
          echo "ğŸ” éªŒè¯é•œåƒå®Œæ•´æ€§..."

          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          docker image ls legal-education:${{ steps.meta.outputs.tag_name }}

          # æ£€æŸ¥é•œåƒå¤§å°
          SIZE=$(docker image ls legal-education:${{ steps.meta.outputs.tag_name }} --format "{{.Size}}")
          echo "ğŸ“¦ é•œåƒå¤§å°: $SIZE"

          # æµ‹è¯•é•œåƒæ˜¯å¦èƒ½å¯åŠ¨ï¼ˆä¸å®é™…å¯åŠ¨åº”ç”¨ï¼‰
          echo "ğŸ§ª æµ‹è¯•é•œåƒå¯åŠ¨..."
          docker run --rm legal-education:${{ steps.meta.outputs.tag_name }} echo "âœ… é•œåƒå¯åŠ¨æˆåŠŸ"

      # Step 6: æ£€æŸ¥å…³é”®æ–‡ä»¶
      - name: ğŸ“‹ Check critical files in image
        run: |
          echo "ğŸ“‹ æ£€æŸ¥é•œåƒå†…çš„å…³é”®æ–‡ä»¶..."
          docker run --rm legal-education:${{ steps.meta.outputs.tag_name }} ls -la /app/
          echo ""
          echo "æ£€æŸ¥ç¯å¢ƒå˜é‡è„šæœ¬..."
          docker run --rm legal-education:${{ steps.meta.outputs.tag_name }} ls -la /app/scripts/
          echo ""
          echo "æ£€æŸ¥Socket.IOæœåŠ¡..."
          docker run --rm legal-education:${{ steps.meta.outputs.tag_name }} ls -la /app/server/

      # Step 7: è¾“å‡ºç»“æœ
      - name: âœ… Build verification result
        run: |
          echo "ğŸ‰ Dockeré•œåƒæ„å»ºå’ŒéªŒè¯æˆåŠŸï¼"
          echo ""
          echo "âœ… éªŒè¯é¡¹ç›®ï¼š"
          echo "  âœ“ é•œåƒæˆåŠŸæ„å»º"
          echo "  âœ“ é•œåƒå¯åŠ¨æˆåŠŸ"
          echo "  âœ“ å…³é”®æ–‡ä»¶å®Œæ•´"
          echo "  âœ“ æ‰€æœ‰ä¾èµ–æ­£ç¡®å®‰è£…"
          echo ""
          echo "ğŸ“¦ é•œåƒä¿¡æ¯ï¼š"
          echo "  é•œåƒåç§°: legal-education:${{ steps.meta.outputs.tag_name }}"
          echo "  æ„å»ºæ—¶é—´: $(date)"
          echo ""
          echo "ğŸ’¾ æœ¬åœ°é•œåƒå·²ç”Ÿæˆï¼Œå¯ç”¨äºæœ¬åœ°æµ‹è¯•æˆ–æ‰‹åŠ¨æ¨é€"
