name: ğŸ³ Build and Verify Docker Image

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æƒé™é…ç½®
permissions:
  contents: read
  packages: write
  security-events: write  # å…è®¸ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ

jobs:
  build-and-verify:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Step 2: è®¾ç½® Docker Buildx
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: ç¡®å®šé•œåƒç‰ˆæœ¬æ ‡ç­¾
      - name: ğŸ“ Determine image tags
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT
          else
            VERSION=$(echo ${{ github.sha }} | cut -c1-7)
            echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT
          fi

      # Step 4: æ„å»ºDockeré•œåƒï¼ˆä¸æ¨é€ï¼‰
      - name: ğŸš€ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: legal-education:${{ steps.meta.outputs.tag_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
            NEXT_PUBLIC_AI_302_API_KEY=${{ secrets.NEXT_PUBLIC_AI_302_API_KEY }}
            NEXT_PUBLIC_BASE_URL=${{ secrets.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000' }}
            NEXT_PUBLIC_SOCKET_IO_URL=${{ secrets.NEXT_PUBLIC_SOCKET_IO_URL || 'http://localhost:3000' }}

      # Step 5: éªŒè¯é•œåƒ
      - name: ğŸ” Verify image integrity
        run: |
          echo "ğŸ” éªŒè¯é•œåƒå®Œæ•´æ€§..."

          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          docker image ls legal-education:${{ steps.meta.outputs.tag_name }}

          # æ£€æŸ¥é•œåƒå¤§å°
          SIZE=$(docker image ls legal-education:${{ steps.meta.outputs.tag_name }} --format "{{.Size}}")
          echo "ğŸ“¦ é•œåƒå¤§å°: $SIZE"

          # æµ‹è¯•é•œåƒæ˜¯å¦èƒ½å¯åŠ¨ï¼ˆä¸å®é™…å¯åŠ¨åº”ç”¨ï¼‰
          echo "ğŸ§ª æµ‹è¯•é•œåƒå¯åŠ¨..."
          docker run --rm legal-education:${{ steps.meta.outputs.tag_name }} echo "âœ… é•œåƒå¯åŠ¨æˆåŠŸ"

      # Step 6: æ£€æŸ¥å…³é”®æ–‡ä»¶
      - name: ğŸ“‹ Check critical files in image
        run: |
          echo "ğŸ“‹ æ£€æŸ¥é•œåƒå†…çš„å…³é”®æ–‡ä»¶..."
          docker run --rm legal-education:${{ steps.meta.outputs.tag_name }} ls -la /app/
          echo ""
          echo "æ£€æŸ¥ç¯å¢ƒå˜é‡è„šæœ¬..."
          docker run --rm legal-education:${{ steps.meta.outputs.tag_name }} ls -la /app/scripts/
          echo ""
          echo "æ£€æŸ¥Socket.IOæœåŠ¡..."
          docker run --rm legal-education:${{ steps.meta.outputs.tag_name }} ls -la /app/server/

      # Step 7: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“
      - name: ğŸ” Login to Aliyun Container Registry
        run: |
          echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“..."
          echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login \
            --username "${{ secrets.ALIYUN_REGISTRY_USER }}" \
            --password-stdin \
            "${{ secrets.ALIYUN_REGISTRY }}"

      # Step 8: æ ‡è®°å¹¶æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘
      - name: ğŸš€ Tag and Push to Aliyun Registry
        run: |
          # æ„å»ºå®Œæ•´çš„é˜¿é‡Œäº‘é•œåƒåœ°å€
          ALIYUN_IMAGE="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_IMAGE_REPO }}:${{ steps.meta.outputs.tag_name }}"
          ALIYUN_IMAGE_LATEST="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_IMAGE_REPO }}:latest"

          echo "ğŸ“¦ æ ‡è®°é•œåƒ..."
          docker tag legal-education:${{ steps.meta.outputs.tag_name }} $ALIYUN_IMAGE
          docker tag legal-education:${{ steps.meta.outputs.tag_name }} $ALIYUN_IMAGE_LATEST

          echo "ğŸš€ æ¨é€åˆ°é˜¿é‡Œäº‘..."
          docker push $ALIYUN_IMAGE
          docker push $ALIYUN_IMAGE_LATEST

          echo ""
          echo "âœ… é•œåƒå·²æˆåŠŸæ¨é€åˆ°é˜¿é‡Œäº‘ï¼"
          echo "ğŸ“¦ é•œåƒåœ°å€ï¼š"
          echo "  - $ALIYUN_IMAGE"
          echo "  - $ALIYUN_IMAGE_LATEST"

      # Step 9: è¾“å‡ºéƒ¨ç½²å‘½ä»¤
      - name: âœ… Deployment instructions
        run: |
          echo "ğŸ‰ Dockeré•œåƒæ„å»ºå’Œæ¨é€æˆåŠŸï¼"
          echo ""
          echo "âœ… éªŒè¯é¡¹ç›®ï¼š"
          echo "  âœ“ é•œåƒæˆåŠŸæ„å»º"
          echo "  âœ“ é•œåƒå¯åŠ¨æˆåŠŸ"
          echo "  âœ“ å…³é”®æ–‡ä»¶å®Œæ•´"
          echo "  âœ“ å·²æ¨é€åˆ°é˜¿é‡Œäº‘"
          echo ""
          echo "ğŸ“¦ é•œåƒä¿¡æ¯ï¼š"
          echo "  æœ¬åœ°é•œåƒ: legal-education:${{ steps.meta.outputs.tag_name }}"
          echo "  é˜¿é‡Œäº‘é•œåƒ: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_IMAGE_REPO }}:${{ steps.meta.outputs.tag_name }}"
          echo "  æ„å»ºæ—¶é—´: $(date)"
          echo ""
          echo "ğŸš€ éƒ¨ç½²å‘½ä»¤ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼‰ï¼š"
          echo "-----------------------------------"
          echo "# 1. æ‹‰å–é•œåƒ"
          echo "docker pull ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_IMAGE_REPO }}:latest"
          echo ""
          echo "# 2. åœæ­¢æ—§å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰"
          echo "docker stop law-edu-platform || true"
          echo "docker rm law-edu-platform || true"
          echo ""
          echo "# 3. å¯åŠ¨æ–°å®¹å™¨"
          echo "docker run -d --name law-edu-platform \\"
          echo "  -p 3000:3000 -p 3001:3001 \\"
          echo "  -e GUEST_MODE=true \\"
          echo "  -e DEEPSEEK_API_KEY=your-key \\"
          echo "  -e NEXT_PUBLIC_AI_302_API_KEY=your-key \\"
          echo "  ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_IMAGE_REPO }}:latest"
          echo "-----------------------------------"
