name: ğŸ³ Build and Push Docker Image

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  ALIYUN_REGISTRY: crpi-k9wo9ii25m22jesx.cn-shenzhen.personal.cr.aliyuncs.com
  ALIYUN_NAMESPACE: yejunhao
  IMAGE_NAME: legal-education

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Step 2: è®¾ç½® Docker Buildx
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: ç™»å½•åˆ°é˜¿é‡Œäº‘Container Registry
      - name: ğŸ” Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      # Step 4: ç¡®å®šé•œåƒç‰ˆæœ¬æ ‡ç­¾
      - name: ğŸ“ Determine image tags
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # ä»tagæå–ç‰ˆæœ¬å·
            VERSION=${GITHUB_REF#refs/tags/}
            echo "tags=${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${VERSION}" >> $GITHUB_OUTPUT
            echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT
          else
            # ä½¿ç”¨commit shaæˆ–latest
            VERSION=$(echo ${{ github.sha }} | cut -c1-7)
            echo "tags=${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest,${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${VERSION}" >> $GITHUB_OUTPUT
            echo "tag_name=latest" >> $GITHUB_OUTPUT
          fi

      # Step 5: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      - name: ğŸš€ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
            NEXT_PUBLIC_AI_302_API_KEY=${{ secrets.NEXT_PUBLIC_AI_302_API_KEY }}

      # Step 6: è¾“å‡ºç»“æœ
      - name: âœ… Build result
        run: |
          echo "ğŸ‰ Dockeré•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "é•œåƒåœ°å€: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag_name }}"
          echo ""
          echo "ğŸ“‹ æœåŠ¡å™¨æ‹‰å–å‘½ä»¤:"
          echo "docker pull ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag_name }}"
          echo ""
          echo "ğŸƒ è¿è¡Œå‘½ä»¤:"
          echo "docker run -d --name legal-education-prod \\"
          echo "  -p 3000:3000 -p 3001:3001 \\"
          echo "  -e DEEPSEEK_API_KEY=sk-xxxxx \\"
          echo "  -e NEXT_PUBLIC_AI_302_API_KEY=sk-xxxxx \\"
          echo "  -e NEXT_PUBLIC_BASE_URL=http://115.29.191.180:3000 \\"
          echo "  -e NEXT_PUBLIC_SOCKET_IO_URL=http://115.29.191.180:3001 \\"
          echo "  ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag_name }}"
