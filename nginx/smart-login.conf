# =============================================================================
# 智能登录页面配置 - 动态插入微信二维码和安全提示
# =============================================================================

upstream nextjs_backend {
    server 115.29.191.180:3000;
}

upstream socketio_backend {
    server 115.29.191.180:3001;
}

# HTTP 服务器 (80端口) - 重定向到HTTPS
server {
    listen 80;
    server_name legal-education.deepracticex.com www.legal-education.deepracticex.com;

    # 重定向所有HTTP请求到HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS 服务器 (443端口) - 主域名
server {
    listen 443 ssl http2;
    server_name legal-education.deepracticex.com www.legal-education.deepracticex.com;

    # SSL 证书配置
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # 日志配置
    access_log /var/log/nginx/law-edu-access.log;
    error_log /var/log/nginx/law-edu-error.log;

    # 登录页面特殊处理 - 插入安全提示和二维码
    location /login {
        proxy_pass http://nextjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 子过滤器 - 替换体验账号为安全提示
        sub_filter_types text/html;
        sub_filter '<div class="mt-6 text-center text-sm text-gray-600"><p>体验账号: teacher01 - teacher05</p><p>密码: 2025</p></div>' '<div class="mt-6 text-center"><div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin: 16px 0;"><div style="color: #0c4a6e; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;"><span style="font-size: 18px;">🔒</span><span>账号获取方式</span></div><div style="width: 120px; height: 120px; margin: 0 auto 12px; background: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; border: 2px solid #0ea5e9; overflow: hidden;"><img src="https://legal-education.deepracticex.com/wechat-qr-code.jpg" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'<span style=color:#64748b;font-size:12px;text-align:center;line-height:1.4>微信二维码<br>请扫码联系</span>\'"></div><div style="font-size: 13px; color: #0c4a6e; line-height: 1.5;"><strong>扫码添加微信获取账号</strong><br>请注明"法学AI系统体验"</div></div><div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px; margin-top: 12px; font-size: 12px; color: #92400e;"><strong>安全提示：</strong><br>为保护系统安全，体验账号需通过扫码获取。感谢您的理解与配合！</div></div></div>';
        sub_filter_once off;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 提供静态二维码图片
    location /wechat-qr-code.jpg {
        proxy_pass http://nextjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 缓存静态图片
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # Next.js API 路由
    location /api/ {
        proxy_pass http://nextjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # AI API超时设置 - 增加到3分钟以适应AI处理时间
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Socket.IO WebSocket 连接
    location /socket.io/ {
        proxy_pass http://socketio_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 特殊配置
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Next.js 主应用路由
    location / {
        proxy_pass http://nextjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# 保留原有域名的HTTP配置 (deepractice.ai)
server {
    listen 80;
    server_name deepractice.ai www.deepractice.ai;

    # Next.js 应用
    location / {
        proxy_pass http://nextjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Socket.IO
    location /socket.io/ {
        proxy_pass http://socketio_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
    }
}