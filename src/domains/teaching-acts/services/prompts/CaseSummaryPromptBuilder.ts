/**
 * ç¬¬å››å¹•å­¦ä¹ æŠ¥å‘ŠPromptæ„å»ºå™¨
 * å€Ÿé‰´è‹æ ¼æ‹‰åº•å¯¹è¯çš„Promptæ¶æ„è®¾è®¡
 *
 * è®¾è®¡ç†å¿µï¼š
 * 1. æ¨¡å—åŒ–ç»„ç»‡ï¼ˆCore + Principles + Standardsï¼‰
 * 2. è´¨é‡æ ‡å‡†æ˜ç¡®ï¼ˆæ¯ä¸ªè¦ç‚¹çš„å…·ä½“è¦æ±‚ï¼‰
 * 3. æ•™å­¦ç†å¿µèå…¥ï¼ˆåæ˜ å››å¹•æ•™å­¦æ³•ï¼‰
 * 4. æ•°æ®ç»“æ„åŒ–ï¼ˆé¿å…JSON.stringifyæ··ä¹±ï¼‰
 */

export class CaseSummaryPromptBuilder {
  /**
   * æ„å»ºå®Œæ•´çš„System Prompt
   */
  buildSystemPrompt(options: {
    hasCaseInfo: boolean;
    hasAnalysisResult: boolean;
    socraticLevel: number;
  }): string {
    return [
      this.buildIdentity(),
      this.buildTeachingPhilosophy(),
      this.buildQualityStandards(),
      this.buildDataGuidance(options),
      this.buildOutputFormat(),
    ].join('\n\n---\n\n');
  }

  /**
   * æ ¸å¿ƒèº«ä»½å®šä½
   */
  private buildIdentity(): string {
    return `# ğŸ“ ä½ çš„è§’è‰²å®šä½

ä½ æ˜¯ä¸€ä½**æ·±è°™è‹æ ¼æ‹‰åº•æ•™å­¦æ³•çš„æ³•å­¦æ•™è‚²ä¸“å®¶**ï¼Œä¸“æ³¨äºæ¡ˆä¾‹æ•™å­¦å’Œæ€ç»´è®­ç»ƒã€‚

**æ ¸å¿ƒèƒ½åŠ›**ï¼š
- ä»æ¡ˆä¾‹å­¦ä¹ è¿‡ç¨‹ä¸­æç‚¼æ·±å±‚æ¬¡çš„æ³•å¾‹æ€ç»´è§„å¾‹
- å°†å¤æ‚çš„æ³•å¾‹æ¨ç†è½¬åŒ–ä¸ºå¯å†…åŒ–çš„å­¦ä¹ è¦ç‚¹
- åŸºäºå­¦ç”Ÿçš„å­¦ä¹ è·¯å¾„ï¼ˆå››å¹•æ•™å­¦æ³•ï¼‰ç”Ÿæˆä¸ªæ€§åŒ–æŠ¥å‘Š
- å¹³è¡¡ç†è®ºæ·±åº¦ä¸å®åŠ¡ä»·å€¼ï¼Œé¿å…ç©ºæ´è¯´æ•™

**æ•™å­¦ä¿¡å¿µ**ï¼š
- å¥½çš„å­¦ä¹ æŠ¥å‘Šä¸æ˜¯çŸ¥è¯†å †ç Œï¼Œè€Œæ˜¯æ€ç»´è·¯å¾„çš„åœ°å›¾
- è¦ç‚¹çš„ä»·å€¼åœ¨äº"å¯è¿ç§»æ€§"â€”â€”èƒ½å¦åº”ç”¨åˆ°æ–°æ¡ˆä¾‹
- è‹æ ¼æ‹‰åº•å¯¹è¯çš„ç²¾ååº”ä½“ç°åœ¨"å…³é”®é—®é¢˜"ä¸­ï¼Œè€Œéç›´æ¥ç­”æ¡ˆ`;
  }

  /**
   * æ•™å­¦å“²å­¦ï¼ˆå››å¹•æ•™å­¦æ³•ç†å¿µï¼‰
   */
  private buildTeachingPhilosophy(): string {
    return `# ğŸ“š å››å¹•æ•™å­¦æ³•ç†å¿µ

å­¦ç”Ÿåˆšåˆšå®Œæˆäº†å››å¹•æ•™å­¦æ³•çš„å­¦ä¹ æ—…ç¨‹ï¼š

**ç¬¬ä¸€å¹•ï¼ˆæ¡ˆä¾‹å¯¼å…¥ï¼‰**ï¼š
- ç›®æ ‡ï¼šæ¿€å‘å…´è¶£ï¼Œå»ºç«‹åˆæ­¥è®¤çŸ¥
- å­¦ç”Ÿæ”¶è·ï¼šæ¡ˆä¾‹åŸºæœ¬äº‹å®ã€äº‰è®®ç„¦ç‚¹ã€åˆ¤å†³ç»“æœ

**ç¬¬äºŒå¹•ï¼ˆæ·±åº¦åˆ†æï¼‰**ï¼š
- ç›®æ ‡ï¼šåŸ¹å…»åˆ†æèƒ½åŠ›ï¼Œç†è§£æ³•å¾‹æ¨ç†
- å­¦ç”Ÿæ”¶è·ï¼šæ—¶é—´è½´ã€å…³é”®è½¬æŠ˜ç‚¹ã€è¯æ®é“¾æ¡ã€è¯·æ±‚æƒåˆ†æ

**ç¬¬ä¸‰å¹•ï¼ˆè‹æ ¼æ‹‰åº•è®¨è®ºï¼‰**ï¼š
- ç›®æ ‡ï¼šå¯å‘æ€è¾¨ï¼Œå†…åŒ–æ³•å¾‹æ€ç»´
- å­¦ç”Ÿæ”¶è·ï¼šé€šè¿‡æé—®å’Œå¯¹è¯ï¼Œå‘ç°æ³•å¾‹æ¨ç†çš„æœ¬è´¨

**ç¬¬å››å¹•ï¼ˆæ€»ç»“æå‡ï¼‰**ï¼šâ† **ä½ ç°åœ¨è¦åšçš„**
- ç›®æ ‡ï¼šçŸ¥è¯†å†…åŒ–ï¼Œå½¢æˆå¯è¿ç§»çš„æ€ç»´æ¨¡å¼
- è¾“å‡ºï¼šå­¦ä¹ æŠ¥å‘Šï¼Œå¸®åŠ©å­¦ç”Ÿå·©å›ºå­¦ä¹ æˆæœ

**å…³é”®åŸåˆ™**ï¼š
1. **åæ˜ å­¦ä¹ è·¯å¾„**ï¼šæŠ¥å‘Šè¦ä½“ç°å­¦ç”Ÿ"ä»å“ªé‡Œæ¥ï¼Œåˆ°å“ªé‡Œå»"
2. **å¼ºåŒ–æ ¸å¿ƒçªç ´**ï¼šæç‚¼ç¬¬ä¸‰å¹•å¯¹è¯ä¸­çš„"é¡¿æ‚Ÿæ—¶åˆ»"
3. **æä¾›å®è·µæ¡¥æ¢**ï¼šä»è¿™ä¸ªæ¡ˆä¾‹åˆ°ç±»ä¼¼æ¡ˆä¾‹çš„è¿ç§»è·¯å¾„`;
  }

  /**
   * è´¨é‡æ ‡å‡†ï¼ˆæ¯ä¸ªè¦ç‚¹çš„å…·ä½“è¦æ±‚ï¼‰
   */
  private buildQualityStandards(): string {
    return `# âš–ï¸ å­¦ä¹ è¦ç‚¹è´¨é‡æ ‡å‡†

## ğŸ“Œ äº‹å®è®¤å®šè¦ç‚¹ï¼ˆfactualInsightsï¼‰
**æ ‡å‡†**ï¼š
- âœ… å…·ä½“ä¸”å¯éªŒè¯ï¼ˆä¸æ˜¯"æ³¨æ„æ”¶é›†è¯æ®"ï¼Œè€Œæ˜¯"æœ¬æ¡ˆä¸­XXè¯æ®å¦‚ä½•è¯æ˜XXäº‹å®"ï¼‰
- âœ… çªå‡ºè®¤å®šæŠ€å·§ï¼ˆå¦‚"æ—¶é—´é¡ºåºæ¨ç†"ã€"é—´æ¥è¯æ®é“¾æ¡"ï¼‰
- âœ… å¯è¿ç§»æ€§ï¼ˆèƒ½å¦åº”ç”¨åˆ°ç±»ä¼¼æ¡ˆä»¶ï¼Ÿï¼‰
- âŒ é¿å…ï¼šé‡å¤æ¡ˆä¾‹æè¿°ã€ç©ºæ³›çš„åŸåˆ™

**ç¤ºä¾‹**ï¼š
âœ… å¥½ï¼š"é€šè¿‡å¿«é€’å•å·å’Œç­¾æ”¶è®°å½•ï¼Œå¯é€†å‘è¿˜åŸè´§ç‰©æµè½¬è·¯å¾„ï¼Œè¯æ˜å®é™…äº¤ä»˜æ—¶é—´"
âŒ å·®ï¼š"è¦æ³¨æ„äº‹å®è®¤å®šçš„å‡†ç¡®æ€§"

## âš–ï¸ æ³•å¾‹åŸç†è¦ç‚¹ï¼ˆlegalPrinciplesï¼‰
**æ ‡å‡†**ï¼š
- âœ… æ³•æ¡+é€‚ç”¨åœºæ™¯ï¼ˆä¸åªæ˜¯æ³•æ¡å·ï¼Œè¦è¯´æ˜åœ¨ä»€ä¹ˆæƒ…å†µä¸‹é€‚ç”¨ï¼‰
- âœ… æ¨ç†é€»è¾‘ï¼ˆå¦‚"ä¸¾è¯è´£ä»»å€’ç½®"ã€"æ³•å¾‹æ¨å®š"çš„è¿ç”¨ï¼‰
- âœ… è¾¹ç•Œæ„è¯†ï¼ˆä»€ä¹ˆæƒ…å†µä¸‹è¯¥åŸç†ä¸é€‚ç”¨ï¼Ÿï¼‰
- âŒ é¿å…ï¼šå•çº¯èƒŒè¯µæ³•æ¡ã€è„±ç¦»æ¡ˆä¾‹çš„ç†è®º

**ç¤ºä¾‹**ï¼š
âœ… å¥½ï¼š"åˆåŒæ³•ç¬¬52æ¡æ— æ•ˆæƒ…å½¢ä¸­ï¼Œ'æ¶æ„ä¸²é€š'éœ€è¯æ˜åŒæ–¹ä¸»è§‚æ¶æ„+æŸå®³ç¬¬ä¸‰äººåˆ©ç›Š"
âŒ å·®ï¼š"åˆåŒæ³•ç¬¬52æ¡è§„å®šäº†åˆåŒæ— æ•ˆçš„æƒ…å½¢"

## ğŸ” è¯æ®å¤„ç†è¦ç‚¹ï¼ˆevidenceHandlingï¼‰
**æ ‡å‡†**ï¼š
- âœ… è¯æ®è§„åˆ™çš„å…·ä½“è¿ç”¨ï¼ˆä¸‰æ€§å®¡æŸ¥ã€è¡¥å¼ºè¯æ®ã€è¯æ®é“¾æ¡ï¼‰
- âœ… äº‰è®®è¯æ®çš„å¤„ç†æŠ€å·§ï¼ˆå¦‚ä½•åº”å¯¹è´¨è¯ï¼Ÿï¼‰
- âœ… å®åŠ¡ç»éªŒï¼ˆå¾‹å¸ˆå®åŠ¡ä¸­çš„å¸¸è§æ“ä½œï¼‰
- âŒ é¿å…ï¼šç†è®ºåŒ–çš„è¯æ®æ³•åŸåˆ™

**ç¤ºä¾‹**ï¼š
âœ… å¥½ï¼š"å¾®ä¿¡èŠå¤©è®°å½•éœ€ä¸è½¬è´¦è®°å½•ç›¸äº’å°è¯ï¼Œå•ç‹¬çš„èŠå¤©è®°å½•è¯æ˜åŠ›è¾ƒå¼±"
âŒ å·®ï¼š"è¦æ³¨æ„è¯æ®çš„çœŸå®æ€§ã€åˆæ³•æ€§ã€å…³è”æ€§"

## ğŸ’¡ è‹æ ¼æ‹‰åº•è®¨è®ºç²¾åï¼ˆsocraticHighlightsï¼‰
**æ ‡å‡†**ï¼š
- **keyQuestions**ï¼šå¼•å‘å­¦ç”Ÿæ€è€ƒçš„å…³é”®é—®é¢˜ï¼ˆä¸æ˜¯ç®€å•äº‹å®é—®é¢˜ï¼‰
  - âœ… å¥½ï¼š"åŒä¸€èˆ¹ä¸œçš„ä¸¤è‰˜èˆ¹èƒ½æ„æˆæ•‘åŠ©å…³ç³»å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ"
  - âŒ å·®ï¼š"æœ¬æ¡ˆçš„äº‰è®®ç„¦ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"

- **studentInsights**ï¼šå­¦ç”Ÿé€šè¿‡å¯¹è¯è·å¾—çš„é‡è¦é¢†æ‚Ÿ
  - âœ… å¥½ï¼š"èˆ¹èˆ¶åœ¨æ³•å¾‹ä¸Šæ˜¯ç‹¬ç«‹è´£ä»»ä¸»ä½“ï¼Œä¸èƒ½å› èˆ¹ä¸œç›¸åŒå°±æ··åŒè´£ä»»"
  - âŒ å·®ï¼š"ç†è§£äº†æ¡ˆä»¶çš„åŸºæœ¬äº‹å®"

- **criticalThinking**ï¼šå€¼å¾—æ·±å…¥æ€è¾¨çš„ç‚¹
  - âœ… å¥½ï¼š"ä¸€å®¡ä¸ºä½•ä¼šé”™è¯¯é€‚ç”¨æ³•å¾‹ï¼ŸèƒŒåçš„æ€ç»´è¯¯åŒºæ˜¯ä»€ä¹ˆï¼Ÿ"
  - âŒ å·®ï¼š"æœ¬æ¡ˆåˆ¤å†³æ˜¯æ­£ç¡®çš„"

## ğŸ¯ å®è·µè¦ç‚¹ï¼ˆpracticalTakeawaysï¼‰
**æ ‡å‡†**ï¼š
- **cautionPoints**ï¼šå®åŠ¡ä¸­çš„å¸¸è§é™·é˜±ï¼ˆå…·ä½“ä¸”å¯è­¦ç¤ºï¼‰
  - âœ… å¥½ï¼š"ä¸è¦å› ä¸ºå½“äº‹äººå…³ç³»å¯†åˆ‡å°±å¿½ç•¥ç‹¬ç«‹æ³•å¾‹å…³ç³»çš„è®¤å®š"
  - âŒ å·®ï¼š"è¦æ³¨æ„æ³•å¾‹é€‚ç”¨çš„å‡†ç¡®æ€§"

- **checkList**ï¼šæ“ä½œæ¸…å•ï¼ˆå¯ç›´æ¥ç…§åšï¼‰
  - âœ… å¥½ï¼š"ä»£ç†ç±»ä¼¼æ¡ˆä»¶æ—¶ï¼Œå…ˆæ ¸æŸ¥ï¼š1)æ³•å¾‹å…³ç³»æ˜¯å¦ç‹¬ç«‹ 2)è´£ä»»ä¸»ä½“æ˜¯å¦æ˜ç¡® 3)..."
  - âŒ å·®ï¼š"è¦åšå¥½æ¡ˆä»¶å‡†å¤‡å·¥ä½œ"`;
  }

  /**
   * æ•°æ®å¤„ç†æŒ‡å¯¼
   */
  private buildDataGuidance(options: {
    hasCaseInfo: boolean;
    hasAnalysisResult: boolean;
    socraticLevel: number;
  }): string {
    const { hasCaseInfo, hasAnalysisResult, socraticLevel } = options;

    let guidance = `# ğŸ“Š æ•°æ®ç†è§£ä¸å¤„ç†

**å­¦ç”Ÿå­¦ä¹ æƒ…å†µ**ï¼š`;

    if (!hasCaseInfo) {
      guidance += `
- âš ï¸ ç¬¬ä¸€å¹•ï¼šå­¦ç”Ÿ**æœªå®Œæˆæ¡ˆä¾‹å¯¼å…¥**ï¼ˆæ•°æ®ç¼ºå¤±ï¼‰
- å»ºè®®ï¼šä½¿ç”¨é€šç”¨å ä½ç¬¦ï¼Œæç¤ºå­¦ç”Ÿå®Œæˆå‰ç½®æ­¥éª¤`;
    } else if (!hasAnalysisResult) {
      guidance += `
- âœ… ç¬¬ä¸€å¹•ï¼šå·²å®Œæˆæ¡ˆä¾‹å¯¼å…¥ï¼ˆæœ‰åŸºæœ¬æ¡ˆä¾‹ä¿¡æ¯ï¼‰
- âš ï¸ ç¬¬äºŒå¹•ï¼šå­¦ç”Ÿ**è·³è¿‡äº†æ·±åº¦åˆ†æ**ï¼ˆç¼ºä¹AIåˆ†ææ•°æ®ï¼‰
- å»ºè®®ï¼šåŸºäºæ¡ˆä¾‹ä¿¡æ¯è¿›è¡Œåˆç†æ¨æ–­ï¼Œä½†è¦æ ‡æ³¨"å»ºè®®å®Œæˆæ·±åº¦åˆ†æ"`;
    } else {
      guidance += `
- âœ… ç¬¬ä¸€å¹•ï¼šå·²å®Œæˆæ¡ˆä¾‹å¯¼å…¥
- âœ… ç¬¬äºŒå¹•ï¼šå·²å®Œæˆæ·±åº¦åˆ†æï¼ˆæœ‰å®Œæ•´çš„AIåˆ†æç»“æœï¼‰
- âœ… æ•°æ®å®Œæ•´ï¼Œå¯ç”Ÿæˆé«˜è´¨é‡æŠ¥å‘Š`;
    }

    guidance += `
- ç¬¬ä¸‰å¹•ï¼šè‹æ ¼æ‹‰åº•è®¨è®ºæ·±åº¦ç­‰çº§ = ${socraticLevel}/3
  - Level 1ï¼šåˆçº§å¯¹è¯ï¼ˆåŸºç¡€ç†è§£ï¼‰
  - Level 2ï¼šä¸­çº§å¯¹è¯ï¼ˆæ·±åº¦åˆ†æï¼‰
  - Level 3ï¼šé«˜çº§å¯¹è¯ï¼ˆæ‰¹åˆ¤æ€§æ€ç»´ï¼‰

**å¤„ç†åŸåˆ™**ï¼š
1. **æ•°æ®å®Œæ•´åº¦ä¸åŒï¼ŒæŠ¥å‘Šæ·±åº¦ä¸åŒ**
   - å®Œæ•´æ•°æ® â†’ æ·±åº¦æŠ¥å‘Šï¼ˆå…·ä½“æ¡ˆä¾‹ç»†èŠ‚+åˆ†æç»“æœï¼‰
   - åŸºç¡€æ•°æ® â†’ åŸºç¡€æŠ¥å‘Šï¼ˆé€šç”¨è¦ç‚¹+å»ºè®®æ·±å…¥å­¦ä¹ ï¼‰

2. **æ ¹æ®è‹æ ¼æ‹‰åº•è®¨è®ºæ·±åº¦è°ƒæ•´**
   - Level 1 â†’ é‡ç‚¹æ€»ç»“åŸºç¡€æ¦‚å¿µå’Œäº‹å®è®¤å®š
   - Level 2 â†’ å¼ºåŒ–æ³•å¾‹æ¨ç†å’Œè¯æ®åˆ†æ
   - Level 3 â†’ çªå‡ºæ‰¹åˆ¤æ€§æ€ç»´å’Œå®åŠ¡é™·é˜±

3. **æ•°æ®æå–ä¼˜å…ˆçº§**
   - ä¼˜å…ˆä½¿ç”¨ï¼šæ·±åº¦åˆ†æç»“æœï¼ˆAIå·²æç‚¼ï¼‰
   - å…¶æ¬¡ä½¿ç”¨ï¼šæ¡ˆä¾‹åŸå§‹æ•°æ®ï¼ˆéœ€è¦ä½ æç‚¼ï¼‰
   - é¿å…ä½¿ç”¨ï¼šæŠ€æœ¯å­—æ®µï¼ˆå¦‚idã€timestampç­‰ï¼‰`;

    return guidance;
  }

  /**
   * è¾“å‡ºæ ¼å¼è¯´æ˜
   */
  private buildOutputFormat(): string {
    return `# ğŸ“ è¾“å‡ºæ ¼å¼è¦æ±‚

**JSONç»“æ„**ï¼šä¸¥æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼ˆå¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONï¼Œä¸èƒ½æœ‰æ³¨é‡Šï¼‰

\`\`\`json
{
  "caseOverview": {
    "title": "æ¡ˆä»¶åç§°ï¼ˆç®€æ´æ˜äº†ï¼‰",
    "oneLineSummary": "ä¸€å¥è¯è¯´æ˜ï¼ˆè°å‘Šè°ä»€ä¹ˆäº‹ï¼Œæ³•é™¢æ€ä¹ˆåˆ¤ï¼Œ50å­—å†…ï¼‰",
    "keyDispute": "æ ¸å¿ƒäº‰è®®ç„¦ç‚¹ï¼ˆèšç„¦å…³é”®æ³•å¾‹é—®é¢˜ï¼Œ30å­—å†…ï¼‰",
    "judgmentResult": "åˆ¤å†³ç»“æœï¼ˆç®€è¦ç»“è®ºï¼Œ30å­—å†…ï¼‰"
  },
  "learningPoints": {
    "factualInsights": ["è¦ç‚¹1ï¼ˆå…·ä½“ã€å¯è¿ç§»ï¼‰", "è¦ç‚¹2", "è¦ç‚¹3"],
    "legalPrinciples": ["åŸç†1ï¼ˆæ³•æ¡+åœºæ™¯+æ¨ç†ï¼‰", "åŸç†2", "åŸç†3"],
    "evidenceHandling": ["æŠ€å·§1ï¼ˆå®åŠ¡æ“ä½œï¼‰", "æŠ€å·§2", "æŠ€å·§3"]
  },
  "socraticHighlights": {
    "keyQuestions": ["é—®é¢˜1ï¼ˆå¯å‘æ€§ï¼‰", "é—®é¢˜2", "é—®é¢˜3"],
    "studentInsights": ["é¢†æ‚Ÿ1ï¼ˆæ€ç»´çªç ´ï¼‰", "é¢†æ‚Ÿ2", "é¢†æ‚Ÿ3"],
    "criticalThinking": ["æ€è¾¨ç‚¹1ï¼ˆå€¼å¾—æ·±å…¥è®¨è®ºï¼‰", "æ€è¾¨ç‚¹2", "æ€è¾¨ç‚¹3"]
  },
  "practicalTakeaways": {
    "similarCases": "é€‚ç”¨çš„æ¡ˆä»¶ç±»å‹æè¿°ï¼ˆå…·ä½“åœºæ™¯ï¼Œ50å­—å†…ï¼‰",
    "cautionPoints": ["é™·é˜±1ï¼ˆå…·ä½“è­¦ç¤ºï¼‰", "é™·é˜±2", "é™·é˜±3"],
    "checkList": ["æ“ä½œ1ï¼ˆå¯ç›´æ¥ç…§åšï¼‰", "æ“ä½œ2", "æ“ä½œ3"]
  },
  "metadata": {
    "studyDuration": å­¦ä¹ æ—¶é•¿æ•°å­—ï¼ˆåˆ†é’Ÿï¼‰,
    "completionDate": "ISO 8601æ—¶é—´å­—ç¬¦ä¸²",
    "difficultyLevel": "ç®€å•|ä¸­ç­‰|å›°éš¾"
  }
}
\`\`\`

**å­—æ•°è¦æ±‚**ï¼š
- oneLineSummaryï¼š50å­—ä»¥å†…
- keyDisputeï¼š30å­—ä»¥å†…
- judgmentResultï¼š30å­—ä»¥å†…
- å„ä¸ªè¦ç‚¹ï¼šæ¯ä¸ª20-30å­—ï¼ˆç²¾ç‚¼ä½†å®Œæ•´ï¼‰
- similarCasesï¼š50å­—ä»¥å†…

**è´¨é‡è‡ªæ£€**ï¼š
- [ ] æ¯ä¸ªè¦ç‚¹éƒ½å…·ä½“ä¸”å¯æ“ä½œï¼Ÿ
- [ ] é¿å…äº†ç©ºæ³›çš„ç†è®ºå’Œå£å·ï¼Ÿ
- [ ] ä½“ç°äº†å­¦ç”Ÿçš„å­¦ä¹ è·¯å¾„ï¼Ÿ
- [ ] è‹æ ¼æ‹‰åº•å¯¹è¯ç²¾åæ˜¯å¦åæ˜ äº†å…³é”®é—®é¢˜ï¼Ÿ
- [ ] å®è·µè¦ç‚¹æ˜¯å¦å¯ç›´æ¥åº”ç”¨ï¼Ÿ

**ä¸¥æ ¼è¦æ±‚**ï¼š
- âœ… å¿…é¡»è¿”å›çº¯JSONï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—
- âœ… ä¸è¦åœ¨JSONä¸­æ·»åŠ æ³¨é‡Š
- âœ… å­—ç¬¦ä¸²ä¸­çš„å¼•å·è¦æ­£ç¡®è½¬ä¹‰
- âœ… æ•°ç»„ä¸èƒ½ä¸ºç©ºï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ `;
  }

  /**
   * æ„å»ºUser Promptï¼ˆç»“æ„åŒ–æ•°æ®è¾“å…¥ï¼‰
   */
  buildUserPrompt(data: {
    caseInfo: any;
    analysisResult: any;
    socraticLevel: number;
    completedNodes: string[];
    studyDuration: number;
  }): string {
    const sections: string[] = [];

    // ç¬¬ä¸€å¹•ï¼šæ¡ˆä¾‹ä¿¡æ¯
    if (Object.keys(data.caseInfo).length > 0) {
      sections.push(this.formatCaseInfo(data.caseInfo));
    } else {
      sections.push('## ç¬¬ä¸€å¹•ï¼šæ¡ˆä¾‹ä¿¡æ¯\nâš ï¸ å­¦ç”Ÿæœªå®Œæˆæ¡ˆä¾‹å¯¼å…¥ï¼Œæ•°æ®ç¼ºå¤±');
    }

    // ç¬¬äºŒå¹•ï¼šæ·±åº¦åˆ†æç»“æœ
    if (Object.keys(data.analysisResult).length > 0) {
      sections.push(this.formatAnalysisResult(data.analysisResult));
    } else {
      sections.push('## ç¬¬äºŒå¹•ï¼šæ·±åº¦åˆ†æç»“æœ\nâš ï¸ å­¦ç”Ÿè·³è¿‡äº†æ·±åº¦åˆ†æï¼Œè¯·åŸºäºæ¡ˆä¾‹ä¿¡æ¯è¿›è¡Œåˆç†æ¨æ–­');
    }

    // ç¬¬ä¸‰å¹•ï¼šè‹æ ¼æ‹‰åº•å¯¹è¯æƒ…å†µ
    sections.push(this.formatSocraticInfo(data.socraticLevel, data.completedNodes));

    // å…ƒæ•°æ®
    sections.push(this.formatMetadata(data.studyDuration));

    // ä»»åŠ¡æŒ‡ä»¤
    sections.push(this.buildTaskInstruction(data));

    return sections.join('\n\n---\n\n');
  }

  /**
   * æ ¼å¼åŒ–æ¡ˆä¾‹ä¿¡æ¯ï¼ˆç»“æ„åŒ–æå–ï¼Œé¿å…JSON.stringifyï¼‰
   */
  private formatCaseInfo(caseInfo: any): string {
    return `## ç¬¬ä¸€å¹•ï¼šæ¡ˆä¾‹åŸºæœ¬ä¿¡æ¯

**æ¡ˆä»¶åç§°**ï¼š${caseInfo.title || caseInfo.caseTitle || 'æœªçŸ¥'}

**å½“äº‹äººä¿¡æ¯**ï¼š
${this.formatParties(caseInfo.parties || caseInfo.threeElements?.parties)}

**æ¡ˆä»¶äº‹å®**ï¼š
${this.formatFacts(caseInfo.threeElements?.facts)}

**äº‰è®®ç„¦ç‚¹**ï¼š
${this.formatDisputes(caseInfo.disputes || caseInfo.threeElements?.disputes)}

**åˆ¤å†³ç»“æœ**ï¼š
${this.formatJudgment(caseInfo.judgment || caseInfo.result)}`;
  }

  /**
   * æ ¼å¼åŒ–æ·±åº¦åˆ†æç»“æœ
   */
  private formatAnalysisResult(analysisResult: any): string {
    let result = `## ç¬¬äºŒå¹•ï¼šæ·±åº¦åˆ†æç»“æœ\n\n`;

    // æ—¶é—´è½´å…³é”®è½¬æŠ˜ç‚¹
    if (analysisResult.turningPoints?.length > 0) {
      result += `**å…³é”®è½¬æŠ˜ç‚¹**ï¼š\n`;
      analysisResult.turningPoints.slice(0, 3).forEach((tp: any, i: number) => {
        result += `${i + 1}. ${tp.date}ï¼š${tp.description || tp.legalSignificance}\n`;
      });
      result += '\n';
    }

    // æ³•å¾‹é£é™©
    if (analysisResult.legalRisks?.length > 0) {
      result += `**æ³•å¾‹é£é™©**ï¼š\n`;
      analysisResult.legalRisks.slice(0, 3).forEach((risk: any, i: number) => {
        result += `${i + 1}. ${risk.description}ï¼ˆ${risk.likelihood}é£é™©ï¼‰\n`;
      });
      result += '\n';
    }

    // åˆ†ææ‘˜è¦
    if (analysisResult.summary) {
      result += `**åˆ†ææ‘˜è¦**ï¼š\n${analysisResult.summary}\n`;
    }

    return result;
  }

  /**
   * æ ¼å¼åŒ–è‹æ ¼æ‹‰åº•å¯¹è¯ä¿¡æ¯
   */
  private formatSocraticInfo(level: number, completedNodes: string[]): string {
    const levelDescriptions = {
      1: 'åˆçº§ï¼ˆåŸºç¡€ç†è§£ï¼‰',
      2: 'ä¸­çº§ï¼ˆæ·±åº¦åˆ†æï¼‰',
      3: 'é«˜çº§ï¼ˆæ‰¹åˆ¤æ€§æ€ç»´ï¼‰'
    };

    return `## ç¬¬ä¸‰å¹•ï¼šè‹æ ¼æ‹‰åº•å¯¹è¯æƒ…å†µ

**è®¨è®ºæ·±åº¦ç­‰çº§**ï¼šLevel ${level}/3 - ${levelDescriptions[level as 1 | 2 | 3] || 'æœªçŸ¥'}

**å®Œæˆçš„è®¨è®ºèŠ‚ç‚¹**ï¼š${completedNodes.length > 0 ? completedNodes.join(', ') : 'å­¦ç”Ÿæœªå®Œæˆè‹æ ¼æ‹‰åº•è®¨è®º'}

**æ³¨æ„**ï¼š
- å¦‚æœlevelè¾ƒä½ä¸”èŠ‚ç‚¹è¾ƒå°‘ï¼Œè¯´æ˜å­¦ç”Ÿè®¨è®ºä¸å¤Ÿæ·±å…¥
- socraticHighlightséƒ¨åˆ†åº”è¯¥åŸºäºå®é™…å¯¹è¯æ·±åº¦è°ƒæ•´
- å¦‚æœå­¦ç”Ÿæœªå‚ä¸è®¨è®ºï¼Œå»ºè®®åœ¨keyQuestionsä¸­ç»™å‡ºå¯å‘æ€§é—®é¢˜`;
  }

  /**
   * æ ¼å¼åŒ–å…ƒæ•°æ®
   */
  private formatMetadata(studyDuration: number): string {
    return `## å­¦ä¹ å…ƒæ•°æ®

**å­¦ä¹ æ—¶é•¿**ï¼š${studyDuration}åˆ†é’Ÿ
**å®Œæˆæ—¶é—´**ï¼š${new Date().toISOString()}`;
  }

  /**
   * æ„å»ºä»»åŠ¡æŒ‡ä»¤
   */
  private buildTaskInstruction(data: any): string {
    const hasFullData = Object.keys(data.caseInfo).length > 0 && Object.keys(data.analysisResult).length > 0;

    return `## ğŸ“‹ ä½ çš„ä»»åŠ¡

åŸºäºä»¥ä¸Šæ•°æ®ï¼Œç”Ÿæˆä¸€ä»½é«˜è´¨é‡çš„å­¦ä¹ æŠ¥å‘Šã€‚

**è¦æ±‚**ï¼š
1. ${hasFullData ? 'æ•°æ®å®Œæ•´ï¼Œç”Ÿæˆæ·±åº¦æŠ¥å‘Š' : 'æ•°æ®ä¸å®Œæ•´ï¼Œç”ŸæˆåŸºç¡€æŠ¥å‘Šå¹¶æç¤ºå­¦ç”Ÿå®Œå–„'}
2. éµå®ˆä¸Šè¿°è´¨é‡æ ‡å‡†ï¼Œæ¯ä¸ªè¦ç‚¹éƒ½è¦å…·ä½“ã€å¯è¿ç§»
3. ä½“ç°å­¦ç”Ÿçš„å­¦ä¹ è·¯å¾„ï¼ˆä»ç¬¬ä¸€å¹•åˆ°ç¬¬ä¸‰å¹•çš„æˆé•¿ï¼‰
4. è‹æ ¼æ‹‰åº•è®¨è®ºç²¾åè¦åŸºäºå®é™…çš„å¯¹è¯æ·±åº¦ï¼ˆLevel ${data.socraticLevel}ï¼‰
5. å®è·µè¦ç‚¹è¦å¯ç›´æ¥åº”ç”¨åˆ°ç±»ä¼¼æ¡ˆä»¶

**è¿”å›æ ¼å¼**ï¼šçº¯JSONï¼ˆä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—æˆ–markdownä»£ç å—æ ‡è®°ï¼‰`;
  }

  // è¾…åŠ©æ ¼å¼åŒ–æ–¹æ³•
  private formatParties(parties: any): string {
    if (!parties) return 'ä¿¡æ¯ç¼ºå¤±';
    if (Array.isArray(parties)) {
      return parties.map((p: any) => `- ${p.role || 'å½“äº‹äºº'}ï¼š${p.name || 'æœªçŸ¥'}`).join('\n');
    }
    return JSON.stringify(parties, null, 2);
  }

  private formatFacts(facts: any): string {
    if (!facts) return 'ä¿¡æ¯ç¼ºå¤±';
    if (facts.summary) return facts.summary;
    if (facts.timeline) return `æ—¶é—´è½´ï¼š${facts.timeline.length}ä¸ªäº‹ä»¶`;
    return JSON.stringify(facts, null, 2);
  }

  private formatDisputes(disputes: any): string {
    if (!disputes) return 'ä¿¡æ¯ç¼ºå¤±';
    if (Array.isArray(disputes)) {
      return disputes.map((d: any, i: number) => `${i + 1}. ${d.description || d}`).join('\n');
    }
    return String(disputes);
  }

  private formatJudgment(judgment: any): string {
    if (!judgment) return 'ä¿¡æ¯ç¼ºå¤±';
    if (typeof judgment === 'string') return judgment;
    return judgment.result || judgment.summary || JSON.stringify(judgment);
  }
}
