/**
 * å…¨é‡æç¤ºè¯æ„å»ºå™¨ V2
 *
 * æ•´åˆæ‰€æœ‰ä¼˜åŒ–åçš„æç¤ºè¯ï¼š
 * 1. æ³•å­¦æ–¹æ³•è®ºï¼ˆ12ç§æ–¹æ³•ï¼‰
 * 2. æ³•å­¦æ•™è‚²Socraticæµç¨‹ï¼ˆ6é˜¶æ®µï¼‰
 * 3. ISSUEåä½œèŒƒå¼ï¼ˆDeepPracticeæ ‡å‡†ï¼‰
 * 4. è®°å¿†é”šç‚¹è‡ªç„¶åŒ–ç­–ç•¥
 *
 * è®¾è®¡ç†å¿µï¼š
 * - å–å…¶ç²¾åï¼šèåˆISSUEçš„è®¤çŸ¥é™è´Ÿï¼ˆæä¾›é€‰é¡¹ï¼‰+ è‹æ ¼æ‹‰åº•çš„é”‹åˆ©è¿½é—®
 * - å»å…¶ç³Ÿç²•ï¼šåˆ é™¤é‡å¤çš„å†…å®¹ï¼Œä¿æŒç®€æ´
 * - æ·±åº¦ç»‘å®šï¼šä¸åˆ¤å†³ä¹¦æå–ä¿¡æ¯æ·±åº¦ç»“åˆ
 */

// è‹æ ¼æ‹‰åº•æ ¸å¿ƒæ¨¡å—ï¼ˆåŸç‰ˆä¿ç•™ï¼‰
import { getSocraticIdentityPrompt } from '../prompts/core/SocraticIdentity';
import { getCognitiveConstraintsPrompt } from '../prompts/core/CognitiveConstraints';
import { getChineseLegalThinkingPrompt } from '../prompts/core/ChineseLegalThinking';
import { getTeachingPrinciplesPrompt } from '../prompts/core/TeachingPrinciples';

// æ–°å¢ä¼˜åŒ–æ¨¡å—
import { getLegalMethodologyPrompt } from '../prompts/core/LegalMethodology';
import { getLegalEducationSocraticPrompt } from '../prompts/LegalEducationSocratic';
import { getISSUEDeepPracticePrompt } from '../prompts/protocols/ISSUE-DeepPractice-Style';
import { getMemoryAnchorStrategyPrompt } from '../prompts/core/MemoryAnchorStrategy';

export interface FullPromptContextV2 {
  /** å½“å‰å¯¹è¯é˜¶æ®µ */
  phase: 'initial_analysis' | 'initiate' | 'structure' | 'socratic' | 'unify' | 'execute';

  /** å½“å‰éš¾åº¦çº§åˆ« */
  difficulty: 'basic' | 'intermediate' | 'advanced';

  /** æ˜¯å¦ä¸ºåˆæ¬¡å¯¹è¯ï¼ˆéœ€è¦AIå…¨å±€åˆ†æï¼‰*/
  isInitialQuestion?: boolean;

  /** å½“å‰è®¨è®ºä¸»é¢˜ */
  topic?: string;

  /** åˆ¤å†³ä¹¦æå–ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰*/
  judgmentData?: {
    basicInfo?: any;
    facts?: any;
    evidence?: any;
    reasoning?: any;
  };

  /** æ˜¯å¦åŒ…å«è¯Šæ–­ä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰*/
  includeDiagnostics?: boolean;
}

/**
 * å…¨é‡æç¤ºè¯æ„å»ºå™¨ V2
 */
export class FullPromptBuilderV2 {

  /**
   * æ„å»ºå®Œæ•´çš„System Prompt
   *
   * èåˆæ¶æ„ï¼ˆ10ä¸ªæ¨¡å—ï¼‰ï¼š
   * ã€è‹æ ¼æ‹‰åº•æ ¸å¿ƒã€‘ï¼ˆåŸç‰ˆä¿ç•™ï¼Œç¡®ä¿é”‹åˆ©æœ¬è´¨ï¼‰
   * M1. è‹æ ¼æ‹‰åº•èº«ä»½ï¼ˆé”‹åˆ©+å¹½é»˜+ä¸¥è‚ƒï¼‰
   * M2. è®¤çŸ¥çº¦æŸï¼ˆæ¡ˆä»¶é”šå®šã€ç¦æ­¢è½¯æ€§å¼•å¯¼ï¼‰
   * M3. ä¸­å›½æ³•å­¦æ€ç»´ï¼ˆå››å±‚è·¯å¾„ï¼‰
   * M4. æ•™å­¦åŸåˆ™ï¼ˆä¸‰å¤§æ­¦å™¨+è®°å¿†é”šç‚¹ï¼‰
   *
   * ã€ISSUEä¼˜åŒ–å±‚ã€‘ï¼ˆæ–°å¢ï¼Œé™ä½è®¤çŸ¥è´Ÿæ‹…ï¼‰
   * M5. ISSUEåä½œèŒƒå¼ï¼ˆDeepPracticeæ ‡å‡†ï¼‰
   * M6. æ³•å­¦æ–¹æ³•è®ºï¼ˆ12ç§æ–¹æ³•ï¼‰
   * M7. æ³•å­¦æ•™è‚²æµç¨‹ï¼ˆ6é˜¶æ®µï¼‰
   * M8. è®°å¿†é”šç‚¹ç­–ç•¥ï¼ˆè‡ªç„¶åŒ–ï¼‰
   *
   * ã€æ‰§è¡Œå±‚ã€‘ï¼ˆé«˜æ³¨æ„åŠ›åŒºï¼‰
   * M9. å½“å‰é˜¶æ®µæ‰§è¡Œè¦æ±‚
   * M10. è¯Šæ–­ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
   */
  static buildFullSystemPrompt(context: FullPromptContextV2): string {
    const sections: string[] = [];
    const separator = "\n\n" + "=".repeat(80) + "\n\n";

    // ========================================
    // ã€è‹æ ¼æ‹‰åº•æ ¸å¿ƒã€‘- ä¿ç•™é”‹åˆ©æœ¬è´¨
    // ========================================

    // M1. è‹æ ¼æ‹‰åº•èº«ä»½
    sections.push(this.buildSectionHeader(
      "ğŸ­ M1. è‹æ ¼æ‹‰åº•èº«ä»½è®¤çŸ¥",
      "é”‹åˆ©+å¹½é»˜+ä¸¥è‚ƒçš„ç²¾ç¥åŠ©äº§å£«"
    ));
    sections.push(getSocraticIdentityPrompt());

    // M2. è®¤çŸ¥çº¦æŸ
    sections.push(this.buildSectionHeader(
      "âš–ï¸ M2. å¼ºåˆ¶æ€§è®¤çŸ¥çº¦æŸ",
      "æ¡ˆä»¶é”šå®šã€ç¦æ­¢è½¯æ€§å¼•å¯¼"
    ));
    sections.push(getCognitiveConstraintsPrompt());

    // M3. ä¸­å›½æ³•å­¦æ€ç»´
    sections.push(this.buildSectionHeader(
      "ğŸ§  M3. ä¸­å›½æ³•å­¦æ€ç»´æ¡†æ¶",
      "å››å±‚æ€ç»´è·¯å¾„ï¼šæ¡ˆä»¶äº‹å® â†’ æ³•æ¡é€‚ç”¨ â†’ æ³•ç†ä¾æ® â†’ ç¤¾ä¼šæ•ˆæœ"
    ));
    sections.push(getChineseLegalThinkingPrompt());

    // M4. æ•™å­¦åŸåˆ™ï¼ˆä¸‰å¤§æ­¦å™¨ï¼‰
    sections.push(this.buildSectionHeader(
      "ğŸ¯ M4. è‹æ ¼æ‹‰åº•æ•™å­¦åŸåˆ™",
      "ä¸‰å¤§æ­¦å™¨ï¼ˆåŠ©äº§æœ¯ã€åè¯˜æ³•ã€å½’è°¬æ³•ï¼‰+ æ¡ˆä»¶-æ³•æ¡é“¾æ¥"
    ));
    sections.push(getTeachingPrinciplesPrompt());

    // ========================================
    // ã€ISSUEä¼˜åŒ–å±‚ã€‘- é™ä½è®¤çŸ¥è´Ÿæ‹…ï¼Œä¿æŒé”‹åˆ©è¿½é—®
    // ========================================

    // M5. ISSUEåä½œèŒƒå¼
    sections.push(this.buildSectionHeader(
      "ğŸ¤ M5. ISSUEåä½œèŒƒå¼",
      "DeepPracticeæ ‡å‡†ï¼šå•ç‚¹èšç„¦ + æä¾›é€‰é¡¹ + ä¿æŒå¼€æ”¾"
    ));
    sections.push(getISSUEDeepPracticePrompt());

    // M6. æ³•å­¦æ–¹æ³•è®º
    sections.push(this.buildSectionHeader(
      "ğŸ“š M6. æ³•å­¦æ–¹æ³•è®ºå®Œæ•´ä½“ç³»",
      "12ç§ä¸“ä¸šåˆ†ææ–¹æ³•ï¼šè§£é‡Šï¼ˆ6ï¼‰+ æ¨ç†ï¼ˆ3ï¼‰+ è®ºè¯ï¼ˆ3ï¼‰"
    ));
    sections.push(getLegalMethodologyPrompt());

    // M7. æ³•å­¦æ•™è‚²Socraticæµç¨‹
    sections.push(this.buildSectionHeader(
      "ğŸ“– M7. æ³•å­¦æ•™è‚²Socraticæµç¨‹",
      "å…ˆåˆ†æè®²è§£ï¼ˆé˜¶æ®µ0ï¼‰â†’ åISSUEæ¢è®¨ï¼ˆé˜¶æ®µ1-5ï¼‰"
    ));

    // å°†ç®€åŒ–çš„phaseåæ˜ å°„åˆ°å®Œæ•´çš„phaseå
    const phaseMapping: Record<typeof context.phase, keyof typeof import('../prompts/LegalEducationSocratic').LEGAL_EDUCATION_SOCRATIC_FLOW> = {
      'initial_analysis': 'phase0_aiAnalysis',
      'initiate': 'phase1_initiate',
      'structure': 'phase2_structure',
      'socratic': 'phase3_socratic',
      'unify': 'phase4_unify',
      'execute': 'phase5_execute'
    };

    sections.push(getLegalEducationSocraticPrompt(phaseMapping[context.phase]));

    // M8. è®°å¿†é”šç‚¹ç­–ç•¥
    sections.push(this.buildSectionHeader(
      "ğŸ’¡ M8. è®°å¿†é”šç‚¹è‡ªç„¶åŒ–ç­–ç•¥",
      "ä¸æœºæ¢°è¦æ±‚ï¼Œè€Œæ˜¯å·§å¦™æ¤å…¥"
    ));
    sections.push(getMemoryAnchorStrategyPrompt());

    // ========================================
    // ã€æ‰§è¡Œå±‚ã€‘- é«˜æ³¨æ„åŠ›åŒº
    // ========================================

    // M9. å½“å‰é˜¶æ®µæ‰§è¡Œè¦æ±‚
    sections.push(this.buildSectionHeader(
      "ğŸš€ M9. å½“å‰é˜¶æ®µæ‰§è¡Œè¦æ±‚",
      "ä½ ç°åœ¨è¦åšä»€ä¹ˆï¼ˆé‡è¦ï¼ï¼‰"
    ));
    sections.push(this.buildCurrentPhaseRequirements(context));

    // M10. è¯Šæ–­ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    if (context.includeDiagnostics) {
      sections.push(this.buildSectionHeader(
        "ğŸ” M10. è¯Šæ–­ä¿¡æ¯",
        "å¼€å‘æ¨¡å¼ - Tokenä½¿ç”¨å’Œæ¨¡å—ç»Ÿè®¡"
      ));
      sections.push(this.buildDiagnostics(context));
    }

    return sections.join(separator);
  }

  /**
   * M9. å½“å‰é˜¶æ®µæ‰§è¡Œè¦æ±‚
   */
  private static buildCurrentPhaseRequirements(context: FullPromptContextV2): string {
    const phaseDescriptions = {
      initial_analysis: "é˜¶æ®µ0ï¼šAIå…¨å±€åˆ†æ",
      initiate: "é˜¶æ®µ1ï¼šç¡®è®¤æ¢è®¨è®®é¢˜",
      structure: "é˜¶æ®µ2ï¼šé€‰æ‹©æ³•å­¦æ–¹æ³•è®ºæ¡†æ¶",
      socratic: "é˜¶æ®µ3ï¼šé”‹åˆ©è¿½é—®ï¼Œå±‚å±‚æ·±å…¥ï¼ˆäº”å±‚é€’è¿›ï¼‰",
      unify: "é˜¶æ®µ4ï¼šæ•´åˆç†è§£",
      execute: "é˜¶æ®µ5ï¼šç»ƒä¹ åº”ç”¨"
    };

    const currentPhase = phaseDescriptions[context.phase] || "æœªçŸ¥é˜¶æ®µ";

    return `# å½“å‰é˜¶æ®µï¼š${currentPhase}

## ä½ ç°åœ¨è¦åšä»€ä¹ˆ

${this.getPhaseSpecificRequirements(context)}

---

## æ ¸å¿ƒåŸåˆ™ï¼ˆè´¯ç©¿æ‰€æœ‰é˜¶æ®µï¼‰

1. **é”‹åˆ©è¿½é—®**ï¼šä¸€é’ˆè§è¡€æš´éœ²çŸ›ç›¾ + æä¾›é€‰é¡¹é™ä½è®¤çŸ¥è´Ÿæ‹… + ä¿æŒé€»è¾‘å¼€æ”¾æ€§
2. **ä¸“ä¸šä¸¥è°¨**ï¼šå‡†ç¡®æœ¯è¯­ + ä¸¥å¯†é€»è¾‘ + æ–¹æ³•è®ºæ˜ç¡®
3. **è‡ªç„¶è®°å¿†**ï¼šå·§å¦™è¿½é—®ï¼Œè€Œéæœºæ¢°è¦æ±‚"åˆ›é€ è®°å¿†é”šç‚¹"
4. **å› ææ–½æ•™**ï¼šæ ¹æ®å­¦ç”Ÿå›ç­”è´¨é‡è°ƒæ•´éš¾åº¦

---

## è´¨é‡è‡ªæ£€ï¼ˆç”Ÿæˆå›ç­”å‰é—®è‡ªå·±ï¼‰

- [ ] æˆ‘æ˜¯å¦æä¾›äº†é€‰é¡¹ï¼Ÿï¼ˆISSUEåŸåˆ™ï¼‰
- [ ] æˆ‘æ˜¯å¦åªèšç„¦ä¸€ä¸ªé—®é¢˜ï¼Ÿï¼ˆå•ç‚¹åŸåˆ™ï¼‰
- [ ] æˆ‘æ˜¯å¦ä½¿ç”¨äº†å‡†ç¡®çš„æ³•å­¦æœ¯è¯­ï¼Ÿï¼ˆä¸“ä¸šæ€§ï¼‰
- [ ] æˆ‘æ˜¯å¦æ˜ç¡®äº†ä½¿ç”¨çš„æ–¹æ³•è®ºï¼Ÿï¼ˆæ–¹æ³•æ„è¯†ï¼‰
- [ ] æˆ‘æ˜¯å¦è‡ªç„¶åœ°æ¤å…¥äº†è®°å¿†é”šç‚¹ï¼Ÿï¼ˆä¸æœºæ¢°ï¼‰

${context.includeDiagnostics ? `

---

## ğŸ” è¯Šæ–­ä¿¡æ¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰

- å½“å‰é˜¶æ®µï¼š${context.phase}
- éš¾åº¦çº§åˆ«ï¼š${context.difficulty}
- æ˜¯å¦åˆæ¬¡å¯¹è¯ï¼š${context.isInitialQuestion ? 'æ˜¯' : 'å¦'}
- è®¨è®ºä¸»é¢˜ï¼š${context.topic || 'æœªæŒ‡å®š'}
- åˆ¤å†³ä¹¦æ•°æ®ï¼š${context.judgmentData ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}
` : ''}
`;
  }

  /**
   * è·å–å„é˜¶æ®µçš„å…·ä½“è¦æ±‚
   */
  private static getPhaseSpecificRequirements(context: FullPromptContextV2): string {
    switch (context.phase) {
      case 'initial_analysis':
        return `
**é˜¶æ®µ0çš„ä»»åŠ¡**ï¼šåŸºäºæå–çš„åˆ¤å†³ä¹¦ä¿¡æ¯ï¼Œè¿›è¡Œå…¨å±€åˆ†æå¹¶è®²è§£

**è¾“å‡ºæ ¼å¼**ï¼ˆä¸¥æ ¼éµå®ˆï¼‰ï¼š

\`\`\`markdown
ğŸ“‹ **æ¡ˆä»¶å…¨å±€åˆ†æ**

**äº‰è®®ç„¦ç‚¹**ï¼š[ä»keyArgumentsä¸­æå–ï¼Œç®€æ´è®²è§£åŸè¢«å‘Šçš„æ ¸å¿ƒåˆ†æ­§]

**é€‚ç”¨æ³•æ¡**ï¼š
- ã€Šæ°‘æ³•å…¸ã€‹ç¬¬Xæ¡ï¼š[æ³•æ¡å†…å®¹]
  æ„æˆè¦ä»¶ï¼šâ‘ ... â‘¡... â‘¢...
  æ³•å¾‹æ•ˆæœï¼š...

**æ³•æ¡ä¸æ¡ˆä»¶çš„å…³ç³»**ï¼ˆä¸‰æ®µè®ºï¼‰ï¼š
- å¤§å‰æï¼šæ³•æ¡è§„å®š...
- å°å‰æï¼šæœ¬æ¡ˆä¸­...[æ¡ˆä»¶äº‹å®]...ç¬¦åˆæ³•æ¡è¦ä»¶
- ç»“è®ºï¼šå› æ­¤...[æ³•å¾‹æ•ˆæœ]

**æ³•é™¢åˆ¤å†³**ï¼š[åˆ¤å†³ç»“æœ]

---

ğŸ’¡ **ç°åœ¨ï¼Œä½ æƒ³æ·±å…¥æ¢è®¨å“ªä¸ªæ–¹é¢ï¼Ÿ**
A) ä¸ºä»€ä¹ˆé€‚ç”¨è¿™ä¸ªæ³•æ¡è€Œä¸æ˜¯å…¶ä»–æ³•æ¡ï¼Ÿ
B) æ¡ˆä»¶äº‹å®å¦‚ä½•ç¬¦åˆæ³•æ¡çš„æ„æˆè¦ä»¶ï¼Ÿ
C) æ³•é™¢çš„æ¨ç†é€»è¾‘æœ‰å“ªäº›äº®ç‚¹æˆ–äº‰è®®ï¼Ÿ
D) å…¶ä»–æ–¹é¢ï¼Ÿ
\`\`\`

**æ•°æ®æ¥æº**ï¼š${context.judgmentData ? 'ä½¿ç”¨context.judgmentDataä¸­çš„æ•°æ®' : 'âš ï¸ æœªæä¾›åˆ¤å†³ä¹¦æ•°æ®'}
        `;

      case 'initiate':
        return `
**é˜¶æ®µ1çš„ä»»åŠ¡**ï¼šç¡®è®¤å­¦ç”Ÿé€‰æ‹©çš„æ¢è®¨æ–¹å‘ï¼Œèšç„¦å…·ä½“è®®é¢˜

**äº¤äº’æ¨¡å¼**ï¼š

å­¦ç”Ÿé€‰æ‹©äº†X â†’ AIç¡®è®¤å¹¶èšç„¦ï¼š

\`\`\`
å¥½çš„ï¼Œæˆ‘ä»¬æ¥æ¢è®¨[å…·ä½“è®®é¢˜]ã€‚

è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒåœ¨äºï¼š[ç”¨ä¸€å¥è¯è¯´æ˜æ ¸å¿ƒ]

ä½ å‡†å¤‡å¥½äº†å—ï¼Ÿæˆ‘ä»¬å¼€å§‹ã€‚
\`\`\`
        `;

      case 'structure':
        return `
**é˜¶æ®µ2çš„ä»»åŠ¡**ï¼šæ¨èæ³•å­¦æ–¹æ³•è®ºæ¡†æ¶ï¼Œè®©å­¦ç”Ÿé€‰æ‹©

**äº¤äº’æ¨¡å¼**ï¼ˆæä¾›2-3ä¸ªæ¡†æ¶ï¼‰ï¼š

\`\`\`
åˆ†æè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å»ºè®®ç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€ï¼š

**æ–¹æ³•Aï¼š[æ–¹æ³•å]**
æ€ç»´è·¯å¾„ï¼š[æ­¥éª¤]
é€‚åˆï¼š[åœºæ™¯]

**æ–¹æ³•Bï¼š[æ–¹æ³•å]**
æ€ç»´è·¯å¾„ï¼š[æ­¥éª¤]
é€‚åˆï¼š[åœºæ™¯]

ä½ å€¾å‘äºç”¨å“ªä¸ªæ–¹æ³•ï¼Ÿæˆ–è€…ä½ æœ‰å…¶ä»–æƒ³æ³•ï¼Ÿ
\`\`\`

**å¯é€‰æ–¹æ³•**ï¼šè§M3ï¼ˆæ³•å­¦æ–¹æ³•è®ºä½“ç³»ï¼‰
        `;

      case 'socratic':
        return `
**é˜¶æ®µ3çš„ä»»åŠ¡**ï¼šäº”å±‚é€’è¿›æ¢ç´¢

**äº”å±‚ç»“æ„**ï¼š
1. ç¬¬1å±‚ï¼šäº‹å®ç¡®è®¤
2. ç¬¬2å±‚ï¼šæ³•æ¡é€‰æ‹©
3. ç¬¬3å±‚ï¼šè¦ä»¶åˆ†æ
4. ç¬¬4å±‚ï¼šæ³•ç†æ¢è®¨
5. ç¬¬5å±‚ï¼šè¾¹ç•Œæ¢è®¨

**æ ¸å¿ƒåŸåˆ™**ï¼š
- é”‹åˆ©è¿½é—®ï¼šä¸€é’ˆè§è¡€ï¼Œå•ç‚¹èšç„¦ï¼Œç›´å‡»é€»è¾‘æ¼æ´
- é™ä½è®¤çŸ¥è´Ÿæ‹…ï¼šæä¾›2-4ä¸ªé€‰é¡¹ï¼Œä½†ä¸é™ä½é”‹åˆ©åº¦
- ä¿æŒé€»è¾‘å¼€æ”¾ï¼šå¿…é¡»åŠ "æˆ–è€…ä½ æœ‰å…¶ä»–æƒ³æ³•ï¼Ÿ"
- æš´éœ²çŸ›ç›¾åé‡å»ºï¼šå­¦ç”Ÿå¡ä½æ—¶æä¾›è„šæ‰‹æ¶ï¼Œè€Œéç»§ç»­è¿½é—®åˆ°æ­»

è¯¦ç»†è¯´æ˜è§M4ï¼ˆæ³•å­¦æ•™è‚²Socraticæµç¨‹ï¼‰çš„é˜¶æ®µ3ã€‚
        `;

      case 'unify':
        return `
**é˜¶æ®µ4çš„ä»»åŠ¡**ï¼šæ•´åˆç¢ç‰‡ç†è§£ï¼Œå½¢æˆç³»ç»Ÿè®¤çŸ¥

**è¾“å‡ºæ ¼å¼**ï¼š

\`\`\`
æˆ‘ä»¬ä¸€èµ·æ¢³ç†ä¸€ä¸‹åˆšæ‰çš„æ¢è®¨ï¼š

**è®®é¢˜**ï¼š[æ ¸å¿ƒè®®é¢˜]

**æ–¹æ³•è®º**ï¼š[ä½¿ç”¨çš„æ³•å­¦æ–¹æ³•è®º]

**åˆ†æè¿‡ç¨‹**ï¼š
1. äº‹å®ç¡®è®¤ï¼š[å…³é”®äº‹å®]
2. æ³•æ¡é€‰æ‹©ï¼šã€Šæ°‘æ³•å…¸ã€‹ç¬¬Xæ¡ï¼Œå› ä¸º...[ç†ç”±]
3. è¦ä»¶åˆ†æï¼š[é€ä¸€æ£€éªŒ]
4. æ³•ç†ä¾æ®ï¼š[æ³•æ¡èƒŒåçš„æ³•ç†]
5. é€‚ç”¨è¾¹ç•Œï¼š[æ³•æ¡çš„é€‚ç”¨è¾¹ç•Œ]

**ä½ è®°ä½çš„å…³é”®ç‚¹**ï¼ˆè¯·è¡¥å……ï¼‰ï¼š
- è¿™ä¸ªæ¡ˆä»¶ â†” ã€Šæ°‘æ³•å…¸ã€‹ç¬¬Xæ¡ï¼ˆæ¡ˆä»¶-æ³•æ¡ç»‘å®šï¼‰
- Xæ¡ä¸Yæ¡çš„åŒºåˆ«æ˜¯...[è¯·ä½ è¯´]
- é€‚ç”¨Xæ¡çš„è¾¹ç•Œæ˜¯...[è¯·ä½ è¯´]

ä½ è§‰å¾—è¿˜æœ‰å“ªé‡Œéœ€è¦è¡¥å……æˆ–ä¿®æ­£ï¼Ÿ
\`\`\`
        `;

      case 'execute':
        return `
**é˜¶æ®µ5çš„ä»»åŠ¡**ï¼šè®¾è®¡ç»ƒä¹ ï¼Œæµ‹è¯•çŸ¥è¯†è¿ç§»

**ç»ƒä¹ ç±»å‹**ï¼ˆé€‰æ‹©1-2ä¸ªï¼‰ï¼š
1. å˜å¼æ¡ˆä»¶ï¼šæ”¹å˜æ¡ˆä»¶äº‹å®ï¼Œæµ‹è¯•ç†è§£
2. å¯¹æ¯”åˆ†æï¼šæ‰¾ç›¸ä¼¼ä½†ç»“è®ºä¸åŒçš„æ¡ˆä¾‹
3. ä¸»åŠ¨recallï¼šæµ‹è¯•è®°å¿†é”šå®šå¼ºåº¦
4. è§’è‰²æ‰®æ¼”ï¼šå‡å¦‚ä½ æ˜¯æ³•å®˜...

è¯¦ç»†ç¤ºä¾‹è§M4ï¼ˆæ³•å­¦æ•™è‚²Socraticæµç¨‹ï¼‰çš„é˜¶æ®µ5ã€‚
        `;

      default:
        return "æœªçŸ¥é˜¶æ®µï¼Œè¯·æ£€æŸ¥phaseå‚æ•°";
    }
  }

  /**
   * æ„å»ºç« èŠ‚æ ‡é¢˜
   */
  private static buildSectionHeader(title: string, description: string): string {
    return `# ${title}

> ${description}
`;
  }

  /**
   * æ„å»ºè¯Šæ–­ä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
   */
  private static buildDiagnostics(context: FullPromptContextV2): string {
    return `
---

# ğŸ” è¯Šæ–­ä¿¡æ¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰

## ä¸Šä¸‹æ–‡ä¿¡æ¯
- å½“å‰é˜¶æ®µï¼š${context.phase}
- éš¾åº¦çº§åˆ«ï¼š${context.difficulty}
- æ˜¯å¦åˆæ¬¡å¯¹è¯ï¼š${context.isInitialQuestion ? 'æ˜¯' : 'å¦'}
- è®¨è®ºä¸»é¢˜ï¼š${context.topic || 'æœªæŒ‡å®š'}

## æ•°æ®åŠ è½½çŠ¶æ€
- åŸºæœ¬ä¿¡æ¯ï¼š${context.judgmentData?.basicInfo ? 'âœ“' : 'âœ—'}
- æ¡ˆä»¶äº‹å®ï¼š${context.judgmentData?.facts ? 'âœ“' : 'âœ—'}
- è¯æ®åˆ†æï¼š${context.judgmentData?.evidence ? 'âœ“' : 'âœ—'}
- è£åˆ¤ç†ç”±ï¼š${context.judgmentData?.reasoning ? 'âœ“' : 'âœ—'}

## Promptæ¨¡å—åŠ è½½
ã€è‹æ ¼æ‹‰åº•æ ¸å¿ƒã€‘
- M1 è‹æ ¼æ‹‰åº•èº«ä»½ï¼šâœ“
- M2 è®¤çŸ¥çº¦æŸï¼šâœ“
- M3 ä¸­å›½æ³•å­¦æ€ç»´ï¼šâœ“
- M4 æ•™å­¦åŸåˆ™ï¼šâœ“

ã€ISSUEä¼˜åŒ–å±‚ã€‘
- M5 ISSUEåä½œèŒƒå¼ï¼šâœ“
- M6 æ³•å­¦æ–¹æ³•è®ºï¼šâœ“
- M7 æ³•å­¦æ•™è‚²æµç¨‹ï¼šâœ“
- M8 è®°å¿†é”šç‚¹ç­–ç•¥ï¼šâœ“

ã€æ‰§è¡Œå±‚ã€‘
- M9 å½“å‰é˜¶æ®µæ‰§è¡Œï¼šâœ“
- M10 è¯Šæ–­ä¿¡æ¯ï¼šâœ“ï¼ˆå½“å‰æ¨¡å—ï¼‰

---
`;
  }
}
