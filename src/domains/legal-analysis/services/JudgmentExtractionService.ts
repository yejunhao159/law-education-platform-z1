/**
 * åˆ¤å†³ä¹¦æå–æœåŠ¡
 * èŒè´£ï¼šä»åˆ¤å†³ä¹¦ä¸­æå–å®Œæ•´çš„ä¸‰è¦ç´ ï¼ˆäº‹å®ã€è¯æ®ã€æ¨ç†ï¼‰
 *
 * è¿ç§»è‡ªï¼šlib/ai-legal-agent.ts (DeepSeekLegalAgent)
 * DeepPractice Standards Compliant
 *
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - extractBasicInfo: æå–æ¡ˆä»¶åŸºæœ¬ä¿¡æ¯
 * - extractFacts: æå–æ¡ˆä»¶äº‹å®å’Œæ—¶é—´è½´
 * - extractEvidence: æå–è¯æ®åˆ†æï¼ˆæ•™å­¦æ ¸å¿ƒï¼‰
 * - extractReasoning: æå–æ³•å®˜è¯´ç†ï¼ˆæ•™å­¦æ ¸å¿ƒï¼‰
 */

import { createLogger } from '@/lib/logging';
import type {
  BasicInfo,
  Facts,
  Evidence,
  Reasoning,
  Metadata,
} from '@/types/legal-case';
import { DeeChatAIClient, createDeeChatConfig } from '@/src/domains/socratic-dialogue/services/DeeChatAIClient';
import {
  processJudgmentText,
  type ProcessedJudgmentText,
} from './utils/JudgmentTextProcessor';
import { extractRuleBasicInfo, type RuleBasicInfo } from './extraction/RuleBasedExtractor';
import { validateFacts, validateEvidence, validateReasoning } from './extraction/JudgmentValidators';
import { buildConfidenceReport } from './extraction/ConfidenceCalculator';

const logger = createLogger('JudgmentExtractionService');

/**
 * åˆ¤å†³ä¹¦æå–ç»“æœ
 */
export interface JudgmentExtractedData {
  basicInfo: BasicInfo;
  facts: Facts;
  evidence: Evidence;
  reasoning: Reasoning;
  metadata: Metadata;
}

/**
 * åˆ¤å†³ä¹¦æå–æœåŠ¡é…ç½®
 */
export interface JudgmentExtractionConfig {
  apiKey?: string;
  apiUrl?: string;
  model?: string;
  temperature?: number;
  maxTokens?: number;
  timeout?: number;
}

/**
 * åˆ¤å†³ä¹¦æå–æœåŠ¡
 */
export class JudgmentExtractionService {
  private apiKey: string;
  private apiUrl: string;
  private model: string;
  private temperature: number;
  private maxTokens: number;
  private aiClient: DeeChatAIClient;  // ğŸ”§ ä½¿ç”¨å·²ä¿®å¤çš„AIå®¢æˆ·ç«¯

  constructor(config?: JudgmentExtractionConfig) {
    this.apiKey = config?.apiKey || process.env.DEEPSEEK_API_KEY || '';
    this.apiUrl = config?.apiUrl || process.env.DEEPSEEK_API_URL || 'https://api.deepseek.com/v1';
    this.model = config?.model || 'deepseek-chat';
    this.temperature = config?.temperature || 0.3;
    this.maxTokens = config?.maxTokens || 8000; // ğŸ”§ ä¿®å¤ï¼šå¢åŠ åˆ°8000ï¼Œç¡®ä¿è¯æ®å’Œè¯´ç†å®Œæ•´è¾“å‡º

    // åˆå§‹åŒ–AIå®¢æˆ·ç«¯ï¼ˆä½¿ç”¨å·²ä¿®å¤çš„DeeChatAIClientï¼‰
    const aiConfig = createDeeChatConfig({
      provider: 'deepseek',
      apiKey: this.apiKey,
      apiUrl: this.apiUrl,
      model: this.model,
      temperature: this.temperature,
      maxContextTokens: this.maxTokens
    });
    this.aiClient = new DeeChatAIClient(aiConfig);

    console.log('âœ… JudgmentExtractionServiceåˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨DeeChatAIClient');
  }

  /**
   * ä¸»å…¥å£ï¼šæå–åˆ¤å†³ä¹¦å®Œæ•´æ•°æ®
   */
  async extractThreeElements(documentText: string): Promise<JudgmentExtractedData> {
    const startTime = Date.now();

    const processedText = processJudgmentText(documentText);
    const ruleBasicInfo = extractRuleBasicInfo(processedText);
    logger.info('åˆ¤å†³ä¹¦æ–‡æœ¬é¢„å¤„ç†å®Œæˆ', processedText.stats);
    logger.info('è§„åˆ™æŠ½å–åŸºç¡€ä¿¡æ¯è¦†ç›–ç‡', { coverage: `${ruleBasicInfo.coverage}%` });

    try {
      logger.info('å¼€å§‹ä½¿ç”¨AIè¿›è¡Œåˆ¤å†³ä¹¦æ·±åº¦åˆ†æ...');

      // ğŸ”§ WSL2ä¿®å¤ï¼šæ”¹ä¸ºé¡ºåºæ‰§è¡Œ,é¿å…å¹¶å‘APIè°ƒç”¨è§¦å‘undiciè¿æ¥æ± é—®é¢˜
      // ä¹‹å‰çš„Promise.allå¹¶è¡Œä¼šå¯¼è‡´4ä¸ªfetchåŒæ—¶å‘èµ·,åœ¨WSL2+Node20ç¯å¢ƒä¸‹è§¦å‘è¿æ¥è¶…æ—¶
      const basicInfoAI = await this.extractBasicInfo(processedText, ruleBasicInfo);
      const basicInfo = this.mergeBasicInfo(ruleBasicInfo, basicInfoAI);
      const facts = await this.extractFacts(processedText);
      const evidence = await this.extractEvidence(processedText);
      const reasoning = await this.extractReasoning(processedText);

      const factsValidation = validateFacts(facts);
      const evidenceValidation = validateEvidence(evidence);
      const reasoningValidation = validateReasoning(reasoning);

      if (!factsValidation.valid) {
        logger.warn('äº‹å®æå–æ ¡éªŒæœªé€šè¿‡', { warnings: factsValidation.warnings });
      }
      if (!evidenceValidation.valid) {
        logger.warn('è¯æ®æå–æ ¡éªŒæœªé€šè¿‡', { warnings: evidenceValidation.warnings });
      }
      if (!reasoningValidation.valid) {
        logger.warn('è£åˆ¤ç†ç”±æå–æ ¡éªŒæœªé€šè¿‡', { warnings: reasoningValidation.warnings });
      }

      const confidenceReport = buildConfidenceReport({
        facts,
        evidence,
        reasoning,
        validations: {
          facts: factsValidation,
          evidence: evidenceValidation,
          reasoning: reasoningValidation
        }
      });

      const processingTime = Date.now() - startTime;

      return {
        basicInfo,
        facts,
        evidence,
        reasoning,
        metadata: {
          extractedAt: new Date().toISOString(),
          confidence: confidenceReport.overall / 100,  // ğŸ”§ ä¿®å¤ï¼šè½¬æ¢ä¸º0-1èŒƒå›´ï¼ˆSchemaè¦æ±‚ï¼‰
          processingTime,
          aiModel: `DeepSeek-${this.model}`,
          extractionMethod: 'ai',  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨Schemaæšä¸¾å€¼ï¼ˆ'ai'|'rule'|'hybrid'|'manual'ï¼‰
          version: '2.1.0',
          confidenceReport
        }
      };
    } catch (error) {
      logger.error('åˆ¤å†³ä¹¦æå–å¤±è´¥', error);
      throw error;
    }
  }

  /**
   * æå–åŸºæœ¬ä¿¡æ¯
   */
  private async extractBasicInfo(processed: ProcessedJudgmentText, ruleInfo: RuleBasicInfo): Promise<BasicInfo> {
    const context = this.buildBasicInfoContext(processed, ruleInfo);

    const prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ³•å¾‹æ–‡ä¹¦åˆ†æä¸“å®¶ã€‚è¯·ä»ä»¥ä¸‹åˆ¤å†³ä¹¦ä¸­æå–åŸºæœ¬ä¿¡æ¯ã€‚

ä»»åŠ¡è¦æ±‚ï¼š
1. æå–æ¡ˆå·ï¼ˆæ ¼å¼å¦‚ï¼š(2024)äº¬01æ°‘åˆ123å·ï¼‰
2. æå–æ³•é™¢åç§°
3. æå–åˆ¤å†³æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
4. è¯†åˆ«æ¡ˆä»¶ç±»å‹ï¼ˆæ°‘äº‹/åˆ‘äº‹/è¡Œæ”¿/æ‰§è¡Œï¼‰
5. æå–åŸå‘Šå’Œè¢«å‘Šä¿¡æ¯ï¼ˆåŒ…æ‹¬åç§°ã€ç±»å‹ã€ä»£ç†å¾‹å¸ˆç­‰ï¼‰
6. æå–å®¡åˆ¤äººå‘˜ä¿¡æ¯

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼š
{
  "caseNumber": "æ¡ˆå·",
  "court": "æ³•é™¢åç§°",
  "judgeDate": "YYYY-MM-DD",
  "caseType": "æ°‘äº‹/åˆ‘äº‹/è¡Œæ”¿/æ‰§è¡Œ",
  "judge": ["å®¡åˆ¤é•¿", "å®¡åˆ¤å‘˜"],
  "clerk": "ä¹¦è®°å‘˜",
  "parties": {
    "plaintiff": [
      {
        "name": "åŸå‘Šåç§°",
        "type": "è‡ªç„¶äºº/æ³•äºº/å…¶ä»–ç»„ç»‡",
        "legalRepresentative": "æ³•å®šä»£è¡¨äºº",
        "attorney": ["ä»£ç†å¾‹å¸ˆ"]
      }
    ],
    "defendant": [
      {
        "name": "è¢«å‘Šåç§°",
        "type": "è‡ªç„¶äºº/æ³•äºº/å…¶ä»–ç»„ç»‡",
        "legalRepresentative": "æ³•å®šä»£è¡¨äºº",
        "attorney": ["ä»£ç†å¾‹å¸ˆ"]
      }
    ],
    "thirdParty": []
  }
}

åˆ¤å†³ä¹¦å†…å®¹ï¼ˆèŠ‚é€‰ï¼‰ï¼š
${context}`;

    try {
      const response = await this.callDeepSeekAPI(prompt);
      return this.parseBasicInfoResponse(response);
    } catch (error) {
      logger.error('æå–åŸºæœ¬ä¿¡æ¯å¤±è´¥', error);
      return this.getDefaultBasicInfo();
    }
  }

  private buildBasicInfoContext(processed: ProcessedJudgmentText, ruleInfo: RuleBasicInfo): string {
    const segments: string[] = [];

    if (processed.sections.header) {
      segments.push(processed.sections.header);
    }
    if (processed.sections.parties) {
      segments.push(processed.sections.parties);
    }
    if (processed.sections.claims) {
      segments.push(processed.sections.claims);
    }
    if (processed.sections.trial) {
      segments.push(processed.sections.trial);
    }
    if (ruleInfo.coverage > 0) {
      segments.push('ã€è§„åˆ™æŠ½å–ç»“æœï¼ˆä¾›æ ¸éªŒï¼‰ã€‘\n' + JSON.stringify({
        caseNumber: ruleInfo.caseNumber,
        court: ruleInfo.court,
        judgeDate: ruleInfo.judgeDate,
        judges: ruleInfo.judges,
        clerk: ruleInfo.clerk,
        parties: ruleInfo.parties
      }, null, 2));
    }
    if (processed.sections.ending) {
      segments.push('ã€è½æ¬¾ä¿¡æ¯ã€‘\n' + processed.sections.ending);
    } else {
      // è‹¥æœªè¯†åˆ«è½æ¬¾ï¼Œé™„åŠ åŸæ–‡æœ«å°¾ä½œä¸ºå‚è€ƒ
      const tailSnippet = processed.normalized.slice(-800);
      segments.push('ã€åŸæ–‡ç»“å°¾ç‰‡æ®µã€‘\n' + tailSnippet);
    }

    const context = segments.join('\n\n').trim();
    return this.truncateContext(context, 4000);
  }

  private truncateContext(text: string, limit = 4000): string {
    if (text.length <= limit) {
      return text;
    }

    const head = text.slice(0, Math.floor(limit * 0.75));
    const tail = text.slice(-Math.floor(limit * 0.25));
    return `${head}\n...\n${tail}`;
  }

  private mergeBasicInfo(ruleInfo: RuleBasicInfo, aiInfo: BasicInfo): BasicInfo {
    const merged: BasicInfo = {
      caseNumber: aiInfo.caseNumber || ruleInfo.caseNumber || '',
      court: aiInfo.court || ruleInfo.court || '',
      judgeDate: (aiInfo.judgeDate || ruleInfo.judgeDate || new Date().toISOString().split('T')[0]) as string,
      caseType: aiInfo.caseType,
      judge: aiInfo.judge && aiInfo.judge.length > 0 ? aiInfo.judge : (ruleInfo.judges ?? []),
      clerk: aiInfo.clerk || ruleInfo.clerk,
      parties: {
        plaintiff: aiInfo.parties?.plaintiff?.length
          ? aiInfo.parties.plaintiff
          : ruleInfo.parties.plaintiff.map(name => ({ name })),
        defendant: aiInfo.parties?.defendant?.length
          ? aiInfo.parties.defendant
          : ruleInfo.parties.defendant.map(name => ({ name })),
        thirdParty: aiInfo.parties?.thirdParty?.length
          ? aiInfo.parties.thirdParty
          : ruleInfo.parties.thirdParty.map(name => ({ name })),
      },
    };

    if (merged.parties.plaintiff.length === 0) {
      merged.parties.plaintiff.push({ name: 'æœªæå–' });
    }
    if (merged.parties.defendant.length === 0) {
      merged.parties.defendant.push({ name: 'æœªæå–' });
    }

    return merged;
  }

  /**
   * æå–æ¡ˆä»¶äº‹å®
   */
  private async extractFacts(processed: ProcessedJudgmentText): Promise<Facts> {
    const factsSection =
      processed.sections.facts ||
      processed.sections.trial ||
      processed.sections.arguments ||
      this.locateSection(processed.normalized, [
        'ç»å®¡ç†æŸ¥æ˜',
        'æœ¬é™¢æŸ¥æ˜',
        'æŸ¥æ˜',
        'ç»æŸ¥æ˜',
        'å®¡ç†æŸ¥æ˜'
      ]);

    logger.info(`äº‹å®è®¤å®šæ®µè½å®šä½æˆåŠŸï¼Œé•¿åº¦: ${factsSection.length}å­—`);

    const prompt = `ä½ æ˜¯èµ„æ·±æ³•å­¦æ•™æˆå’Œå¸æ³•å®åŠ¡ä¸“å®¶ï¼Œæ­£åœ¨ä¸ºæ³•å­¦é™¢å­¦ç”Ÿå‡†å¤‡æ•™å­¦æ¡ˆä¾‹ææ–™ã€‚è¿™ä»½ææ–™çš„è´¨é‡ç›´æ¥å½±å“æ•´ä¸ªè¯¾å ‚çš„æ•™å­¦æ•ˆæœï¼Œå¿…é¡»åšåˆ°**æè‡´å‡†ç¡®å’Œå®Œæ•´**ã€‚

# æ ¸å¿ƒä»»åŠ¡
ä»åˆ¤å†³ä¹¦çš„äº‹å®è®¤å®šéƒ¨åˆ†ï¼Œæ„å»º**100%å®Œæ•´ä¸”ç»å¯¹å‡†ç¡®çš„æ—¶é—´çº¿å’Œäº‹å®ä½“ç³»**ã€‚

# âš ï¸ è´¨é‡çº¢çº¿ï¼ˆè¿åä»»ä½•ä¸€æ¡éƒ½ä¸åˆæ ¼ï¼‰
ğŸš¨ **å®Œæ•´æ€§çº¢çº¿**ï¼šåˆ¤å†³ä¹¦æåˆ°çš„æ¯ä¸€ä¸ªæ—¶é—´èŠ‚ç‚¹ã€æ¯ä¸€ä¸ªäº‹ä»¶ï¼Œç»å¯¹ä¸èƒ½é—æ¼
ğŸš¨ **å‡†ç¡®æ€§çº¢çº¿**ï¼šå¿…é¡»å¿ å®äºåˆ¤å†³ä¹¦åŸæ–‡ï¼Œä¸èƒ½è‡†æµ‹ã€ä¸èƒ½æ·»æ²¹åŠ é†‹ã€ä¸èƒ½æ›²è§£
ğŸš¨ **è¯¦ç»†æ€§çº¢çº¿**ï¼šæ¯ä¸ªäº‹ä»¶å¿…é¡»è¯¦ç»†åˆ°èƒ½è®©ä»æœªçœ‹è¿‡åˆ¤å†³ä¹¦çš„å­¦ç”Ÿå®Œå…¨ç†è§£æ¡ˆæƒ…
ğŸš¨ **é€»è¾‘æ€§çº¢çº¿**ï¼šæ—¶é—´çº¿å¿…é¡»ä¸¥æ ¼æŒ‰æ—¶é—´é¡ºåºï¼Œäº‹ä»¶ä¹‹é—´çš„å› æœå…³ç³»å¿…é¡»æ¸…æ™°
ğŸš¨ **æ•™å­¦æ€§çº¢çº¿**ï¼šæå–çš„å†…å®¹å¿…é¡»æœ‰åŠ©äºå­¦ç”Ÿç†è§£æ³•å¾‹æ¨ç†ï¼Œè€Œéæœºæ¢°å¤åˆ¶

# æ—¶é—´çº¿å®Œæ•´åº¦æ ‡å‡†
**å¿…é¡»åŒ…å«çš„æ—¶é—´èŠ‚ç‚¹ç±»å‹**ï¼š
1. **åˆåŒ/åè®®ç›¸å…³**ï¼šç­¾è®¢æ—¥æœŸã€ç”Ÿæ•ˆæ—¥æœŸã€çº¦å®šå±¥è¡ŒæœŸé™
2. **å±¥è¡Œç›¸å…³**ï¼šæ¬¾é¡¹æ”¯ä»˜ã€è´§ç‰©äº¤ä»˜ã€æœåŠ¡æä¾›ã€å·¥ä½œå®Œæˆç­‰
3. **è¿çº¦ç›¸å…³**ï¼šè¿çº¦è¡Œä¸ºå‘ç”Ÿã€å‚¬å‘Šé€šçŸ¥ã€æŸå¤±å‘ç”Ÿç­‰
4. **æ²Ÿé€šç›¸å…³**ï¼šåå•†ã€é€šçŸ¥ã€å‡½ä»¶å¾€æ¥ç­‰
5. **è¯‰è®¼ç›¸å…³**ï¼šèµ·è¯‰æ—¥æœŸã€å¼€åº­æ—¥æœŸã€åˆ¤å†³æ—¥æœŸ
6. **å…¶ä»–äº‹ä»¶**ï¼šä»»ä½•åˆ¤å†³ä¹¦æ˜ç¡®æåˆ°çš„æ—¶é—´èŠ‚ç‚¹

**äº‹ä»¶æè¿°è´¨é‡æ ‡å‡†**ï¼š
- âŒ ä½è´¨é‡ï¼š"åŒæ–¹ç­¾è®¢åˆåŒ" â†’ è¿‡äºç®€ç•¥
- âœ… é«˜è´¨é‡ï¼š"åŸå‘Šå¼ ä¸‰ä¸è¢«å‘Šæå››ç­¾è®¢ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ï¼Œçº¦å®šæˆ¿å±‹æ€»ä»·200ä¸‡å…ƒï¼Œè¢«å‘Šéœ€åœ¨2æœˆ1æ—¥å‰äº¤ä»˜"

# é‡è¦æ€§åˆ†çº§æ ‡å‡†ï¼ˆåŠ¡å¿…å‡†ç¡®åˆ¤æ–­ï¼‰
- **criticalï¼ˆå…³é”®ï¼‰**ï¼šç›´æ¥å½±å“åˆ¤å†³ç»“æœçš„æ ¸å¿ƒäº‹ä»¶
  - ä¾‹å¦‚ï¼šåˆåŒç­¾è®¢ã€è¿çº¦è¡Œä¸ºå‘ç”Ÿã€æŸå¤±å‘ç”Ÿ
- **importantï¼ˆé‡è¦ï¼‰**ï¼šå½±å“æ¡ˆä»¶ç†è§£çš„é‡è¦äº‹ä»¶
  - ä¾‹å¦‚ï¼šå‚¬å‘Šå±¥è¡Œã€åå•†æœªæœã€æèµ·è¯‰è®¼
- **normalï¼ˆä¸€èˆ¬ï¼‰**ï¼šèƒŒæ™¯æ€§æˆ–ç¨‹åºæ€§äº‹ä»¶
  - ä¾‹å¦‚ï¼šå¼€åº­å®¡ç†ã€è¯æ®æäº¤

# JSONæ ¼å¼è¾“å‡ºï¼ˆåŠ¡å¿…å®Œæ•´ï¼‰
{
  "summary": "äº‹å®æ‘˜è¦ï¼ˆ300-500å­—ï¼‰ï¼Œå®Œæ•´æ¦‚æ‹¬æ¡ˆä»¶ç»è¿‡ï¼ŒåŒ…æ‹¬æ—¶é—´ã€äººç‰©ã€äº‹ä»¶ã€å› æœå…³ç³»",
  "timeline": [
    {
      "date": "2023-01-15ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼Œæˆ–'2023å¹´1æœˆ'ï¼Œæˆ–'2023å¹´æŸæœˆ'ï¼Œæˆ–'æœªæ˜ç¡®'ï¼‰",
      "event": "å…·ä½“äº‹ä»¶æè¿°ï¼ˆä¸å°‘äº20å­—ï¼‰ï¼ŒåŒ…æ‹¬ï¼šè°ã€åšäº†ä»€ä¹ˆã€å…·ä½“å†…å®¹ã€ç»“æœå¦‚ä½•",
      "importance": "critical|important|normal",
      "actors": ["åŸå‘Šå¼ ä¸‰", "è¢«å‘Šæå››"],
      "location": "åŒ—äº¬å¸‚æµ·æ·€åŒºæŸå°åŒºï¼ˆå¦‚åˆ¤å†³ä¹¦æåŠï¼‰",
      "relatedEvidence": ["ä¹°å–åˆåŒ", "è½¬è´¦å‡­è¯"],
      "causalRelation": "è¯¥äº‹ä»¶å¯¼è‡´åç»­è¿çº¦çº çº·å‘ç”Ÿï¼ˆå¦‚æœ‰å› æœå…³ç³»ï¼‰"
    }
  ],
  "keyFacts": [
    "å…³é”®äº‹å®æè¿°å¿…é¡»å…·ä½“ä¸”å®Œæ•´ï¼ˆä¸å°‘äº15å­—ï¼‰ï¼Œå¦‚ï¼šåŸå‘Šå¼ ä¸‰ä¸è¢«å‘Šæå››äº2023å¹´1æœˆ15æ—¥ç­¾è®¢æˆ¿å±‹ä¹°å–åˆåŒï¼Œçº¦å®šæ€»ä»·200ä¸‡å…ƒ"
  ],
  "disputedFacts": [
    "åŸè¢«å‘Šå­˜åœ¨äº‰è®®çš„äº‹å®ï¼ˆéœ€è¯´æ˜åŒæ–¹å„è‡ªä¸»å¼ ï¼‰ï¼Œå¦‚ï¼šè¢«å‘Šä¸»å¼ æˆ¿ä»·å¤§å¹…ä¸Šæ¶¨æ„æˆæƒ…åŠ¿å˜æ›´ï¼ŒåŸå‘Šå¦è®¤"
  ],
  "undisputedFacts": [
    "åŸè¢«å‘Šå‡æ— å¼‚è®®çš„äº‹å®ï¼Œå¦‚ï¼šåŒæ–¹äº2023å¹´1æœˆ15æ—¥ç­¾è®¢ä¹°å–åˆåŒ"
  ]
}

# æå–ç¤ºä¾‹ï¼ˆå‚è€ƒæ ‡å‡†ï¼‰
å‡è®¾åˆ¤å†³ä¹¦å†™ï¼š"2023å¹´1æœˆ15æ—¥ï¼ŒåŸå‘Šä¸è¢«å‘Šç­¾è®¢ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ï¼Œçº¦å®šæˆ¿å±‹æ€»ä»·200ä¸‡å…ƒã€‚åŸå‘Šäº2æœˆ1æ—¥æ”¯ä»˜é¦–ä»˜æ¬¾50ä¸‡å…ƒã€‚2023å¹´3æœˆèµ·ï¼Œè¯¥åœ°åŒºæˆ¿ä»·å¼€å§‹ä¸Šæ¶¨ã€‚2023å¹´4æœˆ20æ—¥ï¼Œè¢«å‘Šæ˜ç¡®è¡¨ç¤ºæ‹’ç»é…åˆåŠç†è¿‡æˆ·æ‰‹ç»­ã€‚"

ä½ åº”è¯¥æå–ä¸ºï¼š
{
  "timeline": [
    {
      "date": "2023-01-15",
      "event": "åŸå‘Šä¸è¢«å‘Šç­¾è®¢ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ï¼Œçº¦å®šæˆ¿å±‹æ€»ä»·200ä¸‡å…ƒï¼Œè¢«å‘Šåº”é…åˆåŠç†è¿‡æˆ·æ‰‹ç»­",
      "importance": "critical",
      "actors": ["åŸå‘Š", "è¢«å‘Š"],
      "relatedEvidence": ["ä¹°å–åˆåŒ"],
      "causalRelation": "è¯¥åˆåŒæˆç«‹æ˜¯åç»­çº çº·çš„åŸºç¡€"
    },
    {
      "date": "2023-02-01",
      "event": "åŸå‘Šå‘è¢«å‘Šæ”¯ä»˜é¦–ä»˜æ¬¾50ä¸‡å…ƒï¼Œå±¥è¡Œäº†åˆåŒçº¦å®šçš„é¦–ä»˜ä¹‰åŠ¡",
      "importance": "critical",
      "actors": ["åŸå‘Š"],
      "relatedEvidence": ["è½¬è´¦å‡­è¯"],
      "causalRelation": "åŸå‘Šå·²å±¥è¡Œä»˜æ¬¾ä¹‰åŠ¡ï¼Œè¢«å‘Šåº”å±¥è¡Œè¿‡æˆ·ä¹‰åŠ¡"
    },
    {
      "date": "2023-03",
      "event": "è¯¥åœ°åŒºæˆ¿ä»·å¼€å§‹ä¸Šæ¶¨ï¼Œå¸‚åœºä»·æ ¼å‘ç”Ÿå˜åŒ–",
      "importance": "important",
      "actors": [],
      "causalRelation": "æˆ¿ä»·ä¸Šæ¶¨å¯¼è‡´è¢«å‘Šæ‹’ç»å±¥è¡ŒåˆåŒ"
    },
    {
      "date": "2023-04-20",
      "event": "è¢«å‘Šæ˜ç¡®è¡¨ç¤ºæ‹’ç»é…åˆåŠç†æˆ¿å±‹è¿‡æˆ·æ‰‹ç»­ï¼Œæ„æˆè¿çº¦",
      "importance": "critical",
      "actors": ["è¢«å‘Š"],
      "causalRelation": "è¢«å‘Šè¿çº¦å¯¼è‡´åŸå‘Šæèµ·è¯‰è®¼"
    }
  ]
}

# åˆ¤å†³ä¹¦äº‹å®è®¤å®šéƒ¨åˆ†
${factsSection}`;

    try {
      const response = await this.callDeepSeekAPI(prompt);

      // ğŸ” å¢å¼ºæ—¥å¿—ï¼šè®°å½•AIåŸå§‹è¿”å›
      console.log('ğŸ” [extractFacts] AIåŸå§‹è¿”å›:', {
        hasResponse: !!response,
        responseType: typeof response,
        hasTimeline: Array.isArray(response?.timeline),
        timelineLength: response?.timeline?.length || 0,
        hasKeyFacts: Array.isArray(response?.keyFacts),
        keyFactsLength: response?.keyFacts?.length || 0,
        hasSummary: !!response?.summary,
        summaryLength: response?.summary?.length || 0,
      });

      const facts = this.parseFactsResponse(response);

      // ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
      const isComplete = facts.timeline.length > 0 && facts.keyFacts.length > 0;
      if (!isComplete) {
        console.warn('âš ï¸ [extractFacts] AIè¿”å›æ•°æ®ä¸å®Œæ•´ï¼', {
          timelineCount: facts.timeline.length,
          keyFactsCount: facts.keyFacts.length,
          hasSummary: facts.summary.length > 0,
        });
        console.warn('âš ï¸ å»ºè®®æ£€æŸ¥ï¼š1) AIæœåŠ¡æ˜¯å¦æ­£å¸¸ 2) æ–‡æ¡£è´¨é‡ 3) Promptæ˜¯å¦è¿‡äºå¤æ‚');
      } else {
        console.log('âœ… [extractFacts] AIè¿”å›æ•°æ®å®Œæ•´', {
          timelineCount: facts.timeline.length,
          keyFactsCount: facts.keyFacts.length,
        });
      }

      return facts;
    } catch (error) {
      logger.error('æå–äº‹å®å¤±è´¥', error);
      return this.createFailedFacts('è°ƒç”¨ AI æœåŠ¡æå–äº‹å®å¤±è´¥');
    }
  }

  /**
   * æ™ºèƒ½å®šä½åˆ¤å†³ä¹¦å…³é”®æ®µè½
   * é€šè¿‡å…³é”®è¯è¯†åˆ«å„éƒ¨åˆ†çš„ä½ç½®
   */
  private locateSection(text: string, keywords: string[]): string {
    // å°è¯•ç”¨å…³é”®è¯å®šä½æ®µè½
    for (const keyword of keywords) {
      const index = text.indexOf(keyword);
      if (index !== -1) {
        // æ‰¾åˆ°å…³é”®è¯ï¼Œæå–è¯¥æ®µè½ï¼ˆåˆ°ä¸‹ä¸€ä¸ªæ˜æ˜¾åˆ†éš”ç‚¹æˆ–ç»“å°¾ï¼‰
        const nextSectionKeywords = [
          'æœ¬é™¢è®¤ä¸º', 'ç»¼ä¸Šæ‰€è¿°', 'åˆ¤å†³å¦‚ä¸‹', 'è£å®šå¦‚ä¸‹',
          'å®¡åˆ¤é•¿', 'å®¡åˆ¤å‘˜', 'ä¹¦è®°å‘˜'
        ];

        let endIndex = text.length;
        for (const endKeyword of nextSectionKeywords) {
          const end = text.indexOf(endKeyword, index + keyword.length);
          if (end !== -1 && end < endIndex) {
            endIndex = end;
          }
        }

        const bufferStart = Math.max(0, index - 200);
        const bufferEnd = Math.min(text.length, endIndex + 200);

        return text.substring(bufferStart, bufferEnd);
      }
    }

    // å¦‚æœæ²¡æ‰¾åˆ°å…³é”®è¯ï¼Œè¿”å›å…¨æ–‡ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
    return text;
  }

  /**
   * æå–è¯æ®åˆ†æï¼ˆæ•™å­¦æ ¸å¿ƒï¼‰
   */
  private async extractEvidence(processed: ProcessedJudgmentText): Promise<Evidence> {
    // æ™ºèƒ½å®šä½è¯æ®æ®µè½ï¼ˆé€šå¸¸åœ¨"ç»å®¡ç†æŸ¥æ˜"éƒ¨åˆ†ï¼‰
    const evidenceSection =
      processed.sections.evidence ||
      processed.sections.facts ||
      processed.sections.arguments ||
      this.locateSection(processed.normalized, [
        'ç»å®¡ç†æŸ¥æ˜',
        'æœ¬é™¢æŸ¥æ˜',
        'æŸ¥æ˜',
        'ç»æŸ¥æ˜',
        'è¯æ®åŠäº‹å®'
      ]);

    logger.info(`è¯æ®æ®µè½å®šä½æˆåŠŸï¼Œé•¿åº¦: ${evidenceSection.length}å­—`);

    const prompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±æ³•å®˜åŠ©ç†ï¼Œæ­£åœ¨æ•™å­¦ç”Ÿå¦‚ä½•**ç²¾ç¡®ã€å…¨é¢**åœ°åˆ†æåˆ¤å†³ä¹¦ä¸­çš„è¯æ®ã€‚

# æ ¸å¿ƒä»»åŠ¡
ä»åˆ¤å†³ä¹¦çš„äº‹å®è®¤å®šéƒ¨åˆ†ï¼Œæå–**æ‰€æœ‰**æåˆ°çš„è¯æ®ï¼ŒåŒ…æ‹¬æ¯ä¸€é¡¹è¯æ®çš„å…·ä½“ç»†èŠ‚ã€‚

# âš ï¸ ç‰¹åˆ«æ³¨æ„ï¼šäºŒå®¡åˆ¤å†³ä¹¦å¤„ç†
å¦‚æœåˆ¤å†³ä¹¦æ˜¯äºŒå®¡åˆ¤å†³ä¸”ç®€å•å†™"ç»å®¡ç†æŸ¥æ˜ï¼Œä¸€å®¡è®¤å®šäº‹å®æ— è¯¯"æˆ–ç±»ä¼¼è¡¨è¿°ï¼š
- è¯´æ˜äºŒå®¡ç»´æŒä¸€å®¡è¯æ®è®¤å®šï¼Œä½†åŸæ–‡æœªåˆ—ä¸¾å…·ä½“è¯æ®
- åœ¨è¿™ç§æƒ…å†µä¸‹ï¼š
  - summaryä¸­è¯´æ˜"æœ¬æ¡ˆä¸ºäºŒå®¡åˆ¤å†³ï¼Œç»´æŒä¸€å®¡è®¤å®šäº‹å®ï¼ŒåŸåˆ¤å†³ä¹¦æœªè¯¦ç»†åˆ—ä¸¾è¯æ®"
  - itemsæ•°ç»„å¯ä»¥ä¸ºç©ºï¼ˆå› ä¸ºåŸæ–‡ç¡®å®æœªåˆ—ä¸¾ï¼‰
  - æˆ–è€…æ ¹æ®åŸæ–‡ç®€ç•¥æåŠçš„è¯æ®ç±»å‹ï¼ˆå¦‚"å·¥å•†ä¿¡æ¯"ã€"ä¸“åˆ©æ–‡ä»¶"ï¼‰åˆ›å»ºç®€åŒ–æ¡ç›®

# é“å¾‹è¦æ±‚ï¼ˆç»å¯¹ä¸èƒ½è¿åï¼‰
ğŸš¨ **å¿…é¡»åˆ—ä¸¾åˆ¤å†³ä¹¦ä¸­æ˜ç¡®æåˆ°çš„æ¯ä¸€é¡¹è¯æ®ï¼Œå“ªæ€•åªæ˜¯ä¸€å¥è¯æåŠï¼Œä¹Ÿç»ä¸èƒ½é—æ¼**
ğŸš¨ **å¿…é¡»æå–è¯æ®çš„å…·ä½“å†…å®¹**ï¼ˆå¦‚åˆåŒçº¦å®šçš„å†…å®¹ã€å‘ç¥¨çš„é‡‘é¢ã€è¯äººçš„å…·ä½“é™ˆè¿°ç­‰ï¼‰
ğŸš¨ **å¦‚æœåˆ¤å†³ä¹¦è¯¦ç»†åˆ—ä¸¾è¯æ®ï¼Œå¿…é¡»è®°å½•è¯æ®çš„å½¢æˆæ—¶é—´**ï¼ˆå¦‚æœ‰ï¼‰ã€æäº¤æ–¹ã€æ³•é™¢æ˜¯å¦é‡‡çº³
ğŸš¨ **å³ä½¿æ³•é™¢æœªé‡‡çº³æˆ–ä¸€ç¬”å¸¦è¿‡çš„è¯æ®ï¼Œä¹Ÿå¿…é¡»åˆ—å‡º**
ğŸš¨ **å¦‚æœåˆ¤å†³ä¹¦å®Œå…¨æœªæåŠä»»ä½•è¯æ®ï¼Œæ‰è¿”å›ç©ºæ•°ç»„ items: []**

# è¯æ®æå–çš„å®Œæ•´åº¦æ ‡å‡†
**é«˜è´¨é‡æå–ç¤ºä¾‹**ï¼š
- âŒ é”™è¯¯ï¼š"ä¹°å–åˆåŒ" â†’ è¿‡äºç®€ç•¥
- âœ… æ­£ç¡®ï¼š"2023å¹´1æœˆ15æ—¥ç­¾è®¢çš„ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ï¼Œçº¦å®šæˆ¿å±‹æ€»ä»·200ä¸‡å…ƒï¼Œè¢«å‘Šéœ€åœ¨2023å¹´2æœˆ1æ—¥å‰äº¤ä»˜æˆ¿å±‹"

**è¯æ®æè¿°å¿…é¡»åŒ…å«**ï¼š
1. è¯æ®åç§°ï¼ˆå®Œæ•´è§„èŒƒåç§°ï¼‰
2. è¯æ®çš„å…·ä½“å†…å®¹æˆ–å…³é”®ä¿¡æ¯
3. è¯æ®å½¢æˆçš„æ—¶é—´ï¼ˆå¦‚åˆ¤å†³ä¹¦æåŠï¼‰
4. è¯æ®ä¸æ¡ˆä»¶äº‰è®®çš„å…³è”ï¼ˆè¯æ˜ä»€ä¹ˆäº‹å®ï¼‰

# è¯æ®åˆ†ç±»æ ‡å‡†ï¼ˆå¿…é¡»ç²¾ç¡®åˆ†ç±»ï¼‰
- **ä¹¦è¯**ï¼šåˆåŒã€åè®®ã€å‘ç¥¨ã€æ”¶æ®ã€è¯æ˜ã€é€šçŸ¥ã€å‡½ä»¶ã€è´¦æœ¬ç­‰ä¹¦é¢ææ–™
- **ç‰©è¯**ï¼šå®ç‰©ã€æ ·å“ã€äº§å“ç­‰æœ‰å½¢ç‰©å“
- **è¯äººè¯è¨€**ï¼šè¯äººçš„é™ˆè¿°ï¼ˆéœ€æ³¨æ˜è¯äººèº«ä»½ï¼‰
- **é‰´å®šæ„è§**ï¼šä¸“ä¸šæœºæ„çš„é‰´å®šç»“è®ºï¼ˆéœ€æ³¨æ˜é‰´å®šæœºæ„ï¼‰
- **å‹˜éªŒç¬”å½•**ï¼šç°åœºå‹˜æŸ¥è®°å½•
- **è§†å¬èµ„æ–™**ï¼šå½•éŸ³ã€å½•åƒã€ç…§ç‰‡ç­‰
- **ç”µå­æ•°æ®**ï¼šç”µå­é‚®ä»¶ã€èŠå¤©è®°å½•ã€ç”µå­ç­¾åã€ç”µå­è½¬è´¦è®°å½•ç­‰
- **å½“äº‹äººé™ˆè¿°**ï¼šåŸå‘Š/è¢«å‘Šçš„é™ˆè¿°ï¼ˆéœ€æ³¨æ˜æ˜¯åŸå‘Šè¿˜æ˜¯è¢«å‘Šï¼‰

# è¯æ®é‡‡çº³åˆ¤æ–­æ ‡å‡†
- **accepted**: æ³•é™¢æ˜¯å¦é‡‡çº³è¯¥è¯æ®
  - æ˜ç¡®é‡‡çº³æˆ–ç”¨äºæ”¯æŒåˆ¤å†³ â†’ true
  - æ˜ç¡®ä¸é‡‡çº³æˆ–è´¨ç–‘çœŸå®æ€§ â†’ false
  - æœªæ˜ç¡®è¯´æ˜ä½†åœ¨äº‹å®è®¤å®šä¸­ä½¿ç”¨ â†’ true

# JSONæ ¼å¼è¾“å‡ºï¼ˆåŠ¡å¿…å®Œæ•´ï¼‰
{
  "summary": "æœ¬æ¡ˆåŸå‘Šæäº¤Xé¡¹è¯æ®ï¼Œè¢«å‘Šæäº¤Yé¡¹è¯æ®ï¼Œæ³•é™¢å…±å®¡æŸ¥Zé¡¹è¯æ®ã€‚ä¸»è¦åŒ…æ‹¬...[åˆ—ä¸¾ä¸»è¦è¯æ®ç±»å‹åŠæ•°é‡]",
  "items": [
    {
      "id": "evidence-1",
      "name": "è¯æ®çš„å®Œæ•´è§„èŒƒåç§°ï¼ˆå¦‚ï¼š2023å¹´1æœˆ15æ—¥ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ï¼‰",
      "type": "ä¹¦è¯|ç‰©è¯|è¯äººè¯è¨€|é‰´å®šæ„è§|å‹˜éªŒç¬”å½•|è§†å¬èµ„æ–™|ç”µå­æ•°æ®|å½“äº‹äººé™ˆè¿°",
      "submittedBy": "plaintiff|defendant|third-party|court ï¼ˆè‹±æ–‡æšä¸¾å€¼ï¼åŸå‘Šç”¨plaintiffï¼Œè¢«å‘Šç”¨defendantï¼Œç¬¬ä¸‰äººç”¨third-partyï¼Œæ³•é™¢è°ƒå–ç”¨courtã€‚âš ï¸ å¦‚æœåˆ¤å†³ä¹¦æœªæ˜ç¡®è¯´æ˜è¯æ®æäº¤æ–¹ï¼Œè¯·çœç•¥æ­¤å­—æ®µï¼Œä¸è¦å¡«å†™ä»»ä½•å€¼ï¼‰",
      "description": "è¯æ®çš„å…·ä½“å†…å®¹æè¿°ï¼ˆå°½é‡è¯¦ç»†ï¼Œå¦‚æœåˆ¤å†³ä¹¦æœ‰è¯¦ç»†æè¿°åˆ™ä¸å°‘äº50å­—ï¼›å¦‚æœåˆ¤å†³ä¹¦åªç®€ç•¥æåŠåˆ™å†™æ˜å¯è·å–çš„ä¿¡æ¯å³å¯ï¼‰ã€‚å¿…é¡»åŒ…æ‹¬ï¼š1.è¯æ®å½¢æˆæ—¶é—´ï¼ˆå¦‚æœ‰ï¼‰ 2.è¯æ®å…·ä½“å†…å®¹ï¼ˆå¦‚åˆåŒæ¡æ¬¾ã€é‡‘é¢ã€è¯äººé™ˆè¿°ç­‰ï¼Œå¦‚åˆ¤å†³ä¹¦æä¾›ï¼‰ 3.è¯æ®çš„å…³é”®ä¿¡æ¯ 4.è¯æ®ä¸æ¡ˆä»¶çš„å…³è”ã€‚å¦‚æœåˆ¤å†³ä¹¦ä»…æåŠè¯æ®åç§°æœªè¯¦è¿°å†…å®¹ï¼Œåˆ™å¦‚å®è¯´æ˜'åˆ¤å†³ä¹¦ä»…æåŠè¯¥è¯æ®åç§°ï¼Œæœªè¯¦è¿°å…·ä½“å†…å®¹'",
      "accepted": true,
      "courtOpinion": "æ³•é™¢å¯¹è¯¥è¯æ®çš„å®Œæ•´è¯„ä»·æ„è§ï¼ˆä¸å°‘äº30å­—ï¼Œå¦‚åˆ¤å†³ä¹¦æ˜ç¡®è¯´æ˜ï¼›å¦‚æœªæ˜ç¡®è¯´æ˜åˆ™çœç•¥æ­¤å­—æ®µï¼‰",
      "relatedFacts": ["è¯¥è¯æ®å…·ä½“è¯æ˜çš„äº‹å®1ï¼ˆå¿…é¡»å…·ä½“æ˜ç¡®ï¼‰", "è¯¥è¯æ®å…·ä½“è¯æ˜çš„äº‹å®2"]
    }
  ],
  "chainAnalysis": {
    "complete": true,
    "missingLinks": ["å¦‚æœè¯æ®é“¾ä¸å®Œæ•´ï¼Œå…·ä½“åˆ—å‡ºç¼ºå¤±çš„ç¯èŠ‚å’Œå½±å“"],
    "strength": "strong|moderate|weak",
    "analysis": "è¯æ®é“¾æ•´ä½“è¯„ä»·ï¼ˆ100-200å­—ï¼‰ï¼Œåˆ†æè¯æ®ä¹‹é—´çš„é€»è¾‘å…³ç³»ã€æ˜¯å¦å½¢æˆå®Œæ•´é—­ç¯ã€å¯¹åˆ¤å†³ç»“æœçš„æ”¯æ’‘åŠ›åº¦"
  },
  "crossExamination": "è´¨è¯è¿‡ç¨‹çš„å…·ä½“æè¿°ï¼ˆå¦‚æœåˆ¤å†³ä¹¦æåˆ°åŒæ–¹è´¨è¯æ„è§ï¼Œå¿…é¡»è¯¦ç»†è®°å½•ï¼‰"
}

# æå–ç¤ºä¾‹ï¼ˆå‚è€ƒï¼‰
å‡è®¾åˆ¤å†³ä¹¦å†™ï¼š"åŸå‘Šæäº¤äº†2023å¹´1æœˆ15æ—¥ç­¾è®¢çš„ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹åŠé¦–ä»˜æ¬¾è½¬è´¦å‡­è¯ã€‚è¢«å‘Šå¯¹åˆåŒçœŸå®æ€§æ— å¼‚è®®ï¼Œä½†è®¤ä¸ºä¸æ„æˆè¿çº¦ã€‚"

ä½ åº”è¯¥æå–ä¸ºï¼š
{
  "items": [
    {
      "id": "evidence-1",
      "name": "2023å¹´1æœˆ15æ—¥ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹",
      "type": "ä¹¦è¯",
      "submittedBy": "plaintiff",
      "description": "åŸå‘Šå¼ æŸä¸è¢«å‘ŠææŸäº2023å¹´1æœˆ15æ—¥ç­¾è®¢çš„ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ï¼Œçº¦å®šæ¶‰æ¡ˆæˆ¿å±‹æ€»ä»·200ä¸‡å…ƒï¼Œè¢«å‘Šåº”åœ¨æ”¶åˆ°é¦–ä»˜æ¬¾åé…åˆåŠç†è¿‡æˆ·æ‰‹ç»­ã€‚è¢«å‘Šå¯¹åˆåŒçœŸå®æ€§æ— å¼‚è®®ï¼Œä»…å¯¹æ˜¯å¦æ„æˆè¿çº¦å­˜åœ¨äº‰è®®ã€‚è¯¥åˆåŒç³»åŒæ–¹çœŸå®æ„æ€è¡¨ç¤ºï¼Œå†…å®¹åˆæ³•æœ‰æ•ˆã€‚",
      "accepted": true,
      "courtOpinion": "è¢«å‘Šå¯¹åˆåŒçœŸå®æ€§æ— å¼‚è®®ï¼Œæœ¬é™¢ç¡®è®¤è¯¥åˆåŒç³»åŒæ–¹çœŸå®æ„æ€è¡¨ç¤ºï¼Œå†…å®¹ä¸è¿åæ³•å¾‹æ³•è§„å¼ºåˆ¶æ€§è§„å®šï¼Œåº”è®¤å®šæœ‰æ•ˆ",
      "relatedFacts": ["åŸè¢«å‘Šä¹‹é—´å­˜åœ¨æˆ¿å±‹ä¹°å–åˆåŒå…³ç³»", "åˆåŒçº¦å®šæˆ¿å±‹æ€»ä»·200ä¸‡å…ƒ", "è¢«å‘Šè´Ÿæœ‰é…åˆè¿‡æˆ·ä¹‰åŠ¡"]
    },
    {
      "id": "evidence-2",
      "name": "é¦–ä»˜æ¬¾è½¬è´¦å‡­è¯",
      "type": "ä¹¦è¯",
      "submittedBy": "åŸå‘Š",
      "description": "åŸå‘Šäº2023å¹´2æœˆ1æ—¥é€šè¿‡é“¶è¡Œè½¬è´¦å‘è¢«å‘Šæ”¯ä»˜é¦–ä»˜æ¬¾50ä¸‡å…ƒçš„è½¬è´¦å‡­è¯ï¼Œè½¬è´¦å¤‡æ³¨ä¸º'æˆ¿å±‹ä¹°å–é¦–ä»˜æ¬¾'ã€‚è¯¥å‡­è¯æ˜¾ç¤ºè½¬è´¦æ—¶é—´ã€é‡‘é¢ã€æ”¶æ¬¾äººè´¦æˆ·ä¿¡æ¯ä¸è¢«å‘Šä¸€è‡´ï¼Œè¯æ˜åŸå‘Šå·²ä¾çº¦å±¥è¡Œé¦–ä»˜æ¬¾æ”¯ä»˜ä¹‰åŠ¡ã€‚",
      "accepted": true,
      "courtOpinion": "è½¬è´¦å‡­è¯çœŸå®æœ‰æ•ˆï¼Œè¯æ˜åŸå‘Šå·²æŒ‰çº¦å®šæ”¯ä»˜é¦–ä»˜æ¬¾50ä¸‡å…ƒï¼Œå±¥è¡Œäº†åˆåŒçº¦å®šçš„ä»˜æ¬¾ä¹‰åŠ¡",
      "relatedFacts": ["åŸå‘Šå·²æ”¯ä»˜é¦–ä»˜æ¬¾50ä¸‡å…ƒ", "åŸå‘Šå·²å±¥è¡ŒåˆåŒçº¦å®šçš„ä»˜æ¬¾ä¹‰åŠ¡", "è¢«å‘Šåº”ç›¸åº”å±¥è¡Œè¿‡æˆ·ä¹‰åŠ¡"]
    }
  ]
}

# åˆ¤å†³ä¹¦äº‹å®è®¤å®šéƒ¨åˆ†
${evidenceSection}`;

    try {
      const response = await this.callDeepSeekAPI(prompt);
      return this.parseEvidenceResponse(response);
    } catch (error) {
      logger.error('æå–è¯æ®å¤±è´¥', error);
      return this.createFailedEvidence('è°ƒç”¨ AI æœåŠ¡æå–è¯æ®å¤±è´¥');
    }
  }

  /**
   * æå–è£åˆ¤ç†ç”±ï¼ˆæ•™å­¦æ ¸å¿ƒï¼‰
   */
  private async extractReasoning(processed: ProcessedJudgmentText): Promise<Reasoning> {
    // æ™ºèƒ½å®šä½æ³•å®˜è¯´ç†æ®µè½ï¼ˆé€šå¸¸åœ¨"æœ¬é™¢è®¤ä¸º"éƒ¨åˆ†ï¼‰
    const reasoningSection =
      processed.sections.reasoning ||
      this.locateSection(processed.normalized, [
        'æœ¬é™¢è®¤ä¸º',
        'ç»æœ¬é™¢å®¡ç†è®¤ä¸º',
        'æœ¬é™¢å®¡ç†åè®¤ä¸º',
        'åˆè®®åº­è®¤ä¸º'
      ]);

    logger.info(`æ³•å®˜è¯´ç†æ®µè½å®šä½æˆåŠŸï¼Œé•¿åº¦: ${reasoningSection.length}å­—`);

    const prompt = `ä½ æ˜¯èµ„æ·±æ³•å­¦æ•™æˆå’Œå®¡åˆ¤å®åŠ¡ä¸“å®¶ï¼Œæ­£åœ¨ä¸ºæ³•å­¦é™¢å­¦ç”Ÿå‡†å¤‡**é«˜è´¨é‡æ•™å­¦æ¡ˆä¾‹**çš„æ³•å¾‹æ¨ç†åˆ†æææ–™ã€‚è¿™ä»½ææ–™çš„è´¨é‡ç›´æ¥å½±å“å­¦ç”Ÿå¯¹æ³•å¾‹æ¨ç†å’Œæ³•æ¡é€‚ç”¨çš„ç†è§£ï¼Œå¿…é¡»åšåˆ°**æè‡´å‡†ç¡®å’Œå®Œæ•´**ã€‚

# æ ¸å¿ƒä»»åŠ¡
ä»"æœ¬é™¢è®¤ä¸º"æ®µè½ä¸­ï¼Œæå–æ³•å®˜çš„**æ‰€æœ‰æ³•å¾‹æ¨ç†è¿‡ç¨‹**å’Œ**æ‰€æœ‰æ³•æ¡å¼•ç”¨**ï¼Œæ„å»º**100%å®Œæ•´ä¸”æ•™å­¦ä»·å€¼æé«˜çš„æ³•å¾‹è®ºè¯ä½“ç³»**ã€‚

# ä»€ä¹ˆæ˜¯æ³•å¾‹æ¨ç†ï¼ˆä¸‰æ®µè®ºï¼‰
æ¯ä¸ªæ¨ç†éƒ½åŒ…å«ï¼š
1. **å¤§å‰æ**ï¼ˆæ³•å¾‹è§„èŒƒï¼‰ï¼šæ³•å®˜å¼•ç”¨çš„æ³•æ¡åŠå…¶å®Œæ•´å†…å®¹
2. **å°å‰æ**ï¼ˆäº‹å®è®¤å®šï¼‰ï¼šæ³•å®˜è®¤å®šçš„æ¡ˆä»¶äº‹å®å¦‚ä½•ç¬¦åˆæ³•æ¡æ„æˆè¦ä»¶
3. **ç»“è®º**ï¼ˆæ³•å¾‹æ•ˆæœï¼‰ï¼šåŸºäºå‰ä¸¤è€…å¾—å‡ºçš„åˆ¤å†³ç»“è®º

# âš ï¸ è´¨é‡çº¢çº¿ï¼ˆè¿åä»»ä½•ä¸€æ¡éƒ½ä¸åˆæ ¼ï¼‰
ğŸš¨ **å®Œæ•´æ€§çº¢çº¿**ï¼šåˆ¤å†³ä¹¦æåˆ°çš„æ¯ä¸€ä¸ªæ³•æ¡ã€æ¯ä¸€æ­¥æ¨ç†ï¼Œç»å¯¹ä¸èƒ½é—æ¼
ğŸš¨ **å‡†ç¡®æ€§çº¢çº¿**ï¼šæ³•æ¡å†…å®¹å¿…é¡»å‡†ç¡®ï¼Œæ¥æºå¿…é¡»æ ‡æ³¨æ¸…æ¥šï¼ˆåˆ¤å†³ä¹¦åŸæ–‡ vs AIè¡¥å……ï¼‰
ğŸš¨ **è¯¦ç»†æ€§çº¢çº¿**ï¼šæ¯ä¸ªæ³•æ¡çš„é€‚ç”¨è¯´æ˜å¿…é¡»è¯¦ç»†åˆ°èƒ½è®©å­¦ç”Ÿå®Œå…¨ç†è§£æ¨ç†é€»è¾‘
ğŸš¨ **é€»è¾‘æ€§çº¢çº¿**ï¼šæ¨ç†é“¾å¿…é¡»ä½“ç°å®Œæ•´çš„ä¸‰æ®µè®ºç»“æ„ï¼Œé€»è¾‘ä¸¥å¯†
ğŸš¨ **æ•™å­¦æ€§çº¢çº¿**ï¼šæå–çš„å†…å®¹å¿…é¡»æœ‰åŠ©äºå­¦ç”Ÿç†è§£æ³•å¾‹æ¨ç†æ–¹æ³•ï¼Œè€Œéæœºæ¢°å¤åˆ¶

# æ³•æ¡æå–çš„å…³é”®è§„åˆ™ï¼ˆåŠ¡å¿…éµå®ˆï¼‰

## è§„åˆ™1ï¼šæ³•æ¡å†…å®¹æå–
**æƒ…å†µA - åˆ¤å†³ä¹¦å¼•ç”¨äº†æ³•æ¡å…¨æ–‡**ï¼š
- å®Œæ•´å¤åˆ¶åˆ¤å†³ä¹¦ä¸­çš„æ³•æ¡åŸæ–‡ â†’ contentå­—æ®µ
- æ ‡æ³¨ source: "åˆ¤å†³ä¹¦åŸæ–‡"

**æƒ…å†µB - åˆ¤å†³ä¹¦åªå†™äº†æ³•æ¡å·ï¼ˆå¦‚"æ°‘æ³•å…¸ç¬¬577æ¡"ï¼‰**ï¼š
- å¦‚æœä½ çš„çŸ¥è¯†åº“æœ‰è¯¥æ³•æ¡ â†’ è¡¥å……æ³•æ¡å†…å®¹åˆ°contentå­—æ®µ
- æ ‡æ³¨ source: "AIè¡¥å……"
- âš ï¸ å¦‚æœä½ ä¸ç¡®å®šæ³•æ¡å†…å®¹æ˜¯å¦å‡†ç¡® â†’ æ ‡æ³¨ source: "å¾…æ ¸å®"

**æƒ…å†µC - åˆ¤å†³ä¹¦å®Œå…¨æœªæåŠæ³•æ¡ä½†æœ‰æ³•å¾‹æ¨ç†**ï¼š
- å°½é‡æ¨æ–­é€‚ç”¨çš„æ³•æ¡
- æ ‡æ³¨ source: "å¾…æ ¸å®"

## è§„åˆ™2ï¼šæ³•æ¡å¼•ç”¨çš„å®Œæ•´æ€§
æ¯ä¸ªæ³•æ¡å¿…é¡»åŒ…å«ï¼š
- **law**: æ³•å¾‹åç§°ï¼ˆå¦‚"ä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸"æˆ–"æ°‘æ³•å…¸"ï¼‰
- **article**: æ¡æ¬¾å·ï¼ˆå¦‚"ç¬¬577æ¡"ï¼‰
- **clause**: å…·ä½“æ¬¾é¡¹å·ï¼ˆå¦‚æœ‰ï¼Œå¦‚"ç¬¬äºŒæ¬¾"ï¼‰
- **content**: æ³•æ¡å®Œæ•´å†…å®¹ï¼ˆå¦‚æœ‰ï¼‰
- **source**: "åˆ¤å†³ä¹¦åŸæ–‡" | "AIè¡¥å……" | "å¾…æ ¸å®"ï¼ˆå¿…é¡»æ ‡æ³¨ï¼‰
- **application**: ä¸å°‘äº50å­—ï¼Œå¿…é¡»è¯´æ˜ï¼šâ‘ æœ¬æ¡ˆå…·ä½“äº‹å®æ˜¯ä»€ä¹ˆ â‘¡å¦‚ä½•ç¬¦åˆæ³•æ¡æ„æˆè¦ä»¶ â‘¢äº§ç”Ÿä»€ä¹ˆæ³•å¾‹æ•ˆæœ

## è§„åˆ™3ï¼šapplicationå­—æ®µçš„æ•™å­¦è´¨é‡æ ‡å‡†
- âŒ ä½è´¨é‡ï¼š"è¯¥æ³•æ¡é€‚ç”¨äºæœ¬æ¡ˆ" â†’ è¿‡äºç¬¼ç»Ÿï¼Œæ²¡æœ‰æ•™å­¦ä»·å€¼
- âœ… é«˜è´¨é‡ï¼š"è¢«å‘Šæ‹’ç»é…åˆåŠç†æˆ¿å±‹è¿‡æˆ·æ‰‹ç»­çš„è¡Œä¸ºï¼ˆäº‹å®ï¼‰ï¼Œæ„æˆäº†'ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡'çš„æƒ…å½¢ï¼ˆç¬¦åˆæ³•æ¡æ„æˆè¦ä»¶ï¼‰ï¼Œæ ¹æ®ã€Šæ°‘æ³•å…¸ã€‹ç¬¬577æ¡è§„å®šï¼Œåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»ï¼ˆæ³•å¾‹æ•ˆæœï¼‰ï¼Œå³è¢«å‘Šåº”é…åˆåŸå‘ŠåŠç†è¿‡æˆ·ç™»è®°æ‰‹ç»­"

# æ¨ç†é“¾æ•™å­¦è´¨é‡æ ‡å‡†
**ä¸‰æ®µè®ºç»“æ„å®Œæ•´æ€§è¦æ±‚**ï¼š
- **premiseï¼ˆå¤§å‰æï¼‰**ï¼šå¿…é¡»åŒ…å«æ³•æ¡å·+æ³•æ¡å®Œæ•´å†…å®¹
  - âŒ é”™è¯¯ï¼š"æ ¹æ®åˆåŒæ³•"
  - âœ… æ­£ç¡®ï¼š"ã€Šæ°‘æ³•å…¸ã€‹ç¬¬577æ¡è§„å®šï¼šå½“äº‹äººä¸€æ–¹ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡æˆ–è€…å±¥è¡ŒåˆåŒä¹‰åŠ¡ä¸ç¬¦åˆçº¦å®šçš„ï¼Œåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œã€é‡‡å–è¡¥æ•‘æªæ–½æˆ–è€…èµ”å¿æŸå¤±ç­‰è¿çº¦è´£ä»»"

- **inferenceï¼ˆå°å‰æ+æ¨ç†ï¼‰**ï¼šä¸å°‘äº50å­—ï¼Œå¿…é¡»è¯´æ˜æœ¬æ¡ˆäº‹å®å¦‚ä½•ç¬¦åˆæ³•æ¡
  - âŒ é”™è¯¯ï¼š"è¢«å‘Šè¿çº¦"
  - âœ… æ­£ç¡®ï¼š"è¢«å‘ŠææŸåœ¨æ”¶åˆ°åŸå‘Šæ”¯ä»˜çš„é¦–ä»˜æ¬¾50ä¸‡å…ƒåï¼Œæ˜ç¡®æ‹’ç»é…åˆåŠç†æˆ¿å±‹è¿‡æˆ·æ‰‹ç»­ï¼Œè¯¥è¡Œä¸ºæ„æˆäº†'ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡'ï¼Œç¬¦åˆã€Šæ°‘æ³•å…¸ã€‹ç¬¬577æ¡è§„å®šçš„è¿çº¦æƒ…å½¢"

- **conclusionï¼ˆç»“è®ºï¼‰**ï¼šå¿…é¡»æ˜ç¡®æ³•å¾‹åæœ
  - âŒ é”™è¯¯ï¼š"è¢«å‘Šæœ‰è´£ä»»"
  - âœ… æ­£ç¡®ï¼š"è¢«å‘Šæ„æˆè¿çº¦ï¼Œåº”æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»ï¼Œå³åº”é…åˆåŸå‘ŠåŠç†æ¶‰æ¡ˆæˆ¿å±‹çš„è¿‡æˆ·ç™»è®°æ‰‹ç»­"

- **supportingEvidenceï¼ˆæ”¯æŒè¯æ®ï¼‰**ï¼šåˆ—å‡ºæ”¯æŒè¯¥æ¨ç†çš„å…·ä½“è¯æ®

# JSONæ ¼å¼è¾“å‡ºï¼ˆåŠ¡å¿…å®Œæ•´ï¼‰
{
  "summary": "è£åˆ¤ç†ç”±æ ¸å¿ƒæ‘˜è¦ï¼ˆ100-300å­—ï¼‰ï¼Œå¿…é¡»åŒ…æ‹¬ï¼šâ‘ æ³•é™¢çš„ä¸»è¦æ³•å¾‹è§‚ç‚¹ â‘¡é€‚ç”¨çš„æ ¸å¿ƒæ³•æ¡ â‘¢æ¨ç†çš„æ ¸å¿ƒé€»è¾‘ â‘£åˆ¤å†³ç»“æœ",
  "legalBasis": [
    {
      "law": "ä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸ï¼ˆå®Œæ•´æ³•å¾‹åç§°ï¼‰",
      "article": "ç¬¬577æ¡ï¼ˆç²¾ç¡®æ¡æ¬¾å·ï¼‰",
      "clause": "ç¬¬ä¸€æ¬¾ï¼ˆå¦‚æœ‰åˆ†æ¬¾ï¼‰",
      "content": "å½“äº‹äººä¸€æ–¹ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡æˆ–è€…å±¥è¡ŒåˆåŒä¹‰åŠ¡ä¸ç¬¦åˆçº¦å®šçš„ï¼Œåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œã€é‡‡å–è¡¥æ•‘æªæ–½æˆ–è€…èµ”å¿æŸå¤±ç­‰è¿çº¦è´£ä»»ã€‚ï¼ˆå®Œæ•´æ³•æ¡å†…å®¹ï¼‰",
      "source": "åˆ¤å†³ä¹¦åŸæ–‡|AIè¡¥å……|å¾…æ ¸å®ï¼ˆå¿…é¡»æ˜ç¡®æ ‡æ³¨ï¼‰",
      "application": "æ³•å®˜é€‚ç”¨è¯¥æ³•æ¡çš„å…·ä½“è¯´æ˜ï¼ˆä¸å°‘äº50å­—ï¼‰ï¼Œå¿…é¡»åŒ…æ‹¬ï¼šâ‘ æœ¬æ¡ˆå…·ä½“äº‹å®ï¼ˆè°+åšäº†ä»€ä¹ˆï¼‰â‘¡å¦‚ä½•ç¬¦åˆæ³•æ¡æ„æˆè¦ä»¶ï¼ˆå¯¹åº”æ³•æ¡ä¸­çš„å“ªä¸ªè¦ç´ ï¼‰â‘¢äº§ç”Ÿä»€ä¹ˆæ³•å¾‹æ•ˆæœï¼ˆåˆ¤å†³ç»“æœï¼‰ã€‚ç¤ºä¾‹ï¼šè¢«å‘ŠææŸåœ¨æ”¶åˆ°åŸå‘Šæ”¯ä»˜çš„50ä¸‡å…ƒé¦–ä»˜æ¬¾åï¼ˆäº‹å®ï¼‰ï¼Œæ˜ç¡®æ‹’ç»é…åˆåŠç†æˆ¿å±‹è¿‡æˆ·æ‰‹ç»­ï¼Œæ„æˆäº†ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡çš„æƒ…å½¢ï¼ˆç¬¦åˆè¦ä»¶ï¼‰ï¼Œæ ¹æ®è¯¥æ¡è§„å®šï¼Œåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»ï¼Œå³åº”é…åˆåŸå‘ŠåŠç†è¿‡æˆ·ç™»è®°æ‰‹ç»­ï¼ˆæ³•å¾‹æ•ˆæœï¼‰",
      "interpretation": "æ³•å®˜å¯¹è¯¥æ³•æ¡çš„å…·ä½“è§£é‡Šæˆ–è¡¥å……è¯´æ˜ï¼ˆå¦‚åˆ¤å†³ä¹¦æ˜ç¡®è¯´æ˜ï¼Œå¦åˆ™å¯çœç•¥ï¼‰"
    }
  ],
  "logicChain": [
    {
      "premise": "å¤§å‰æï¼šæ³•å¾‹è§„èŒƒçš„å®Œæ•´è¡¨è¿°ï¼Œå¿…é¡»åŒ…å«æ³•æ¡å·+æ³•æ¡å®Œæ•´å†…å®¹ã€‚ç¤ºä¾‹ï¼šã€Šä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸ã€‹ç¬¬577æ¡è§„å®šï¼šå½“äº‹äººä¸€æ–¹ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡æˆ–è€…å±¥è¡ŒåˆåŒä¹‰åŠ¡ä¸ç¬¦åˆçº¦å®šçš„ï¼Œåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œã€é‡‡å–è¡¥æ•‘æªæ–½æˆ–è€…èµ”å¿æŸå¤±ç­‰è¿çº¦è´£ä»»",
      "inference": "å°å‰æ+æ¨ç†ï¼šä»æ³•æ¡åˆ°æœ¬æ¡ˆäº‹å®çš„å…·ä½“æ¨ç†è¿‡ç¨‹ï¼ˆä¸å°‘äº50å­—ï¼‰ï¼Œå¿…é¡»è¯´æ˜ï¼šâ‘ æœ¬æ¡ˆä¸­è°åšäº†ä»€ä¹ˆï¼ˆå…·ä½“äº‹å®ï¼‰â‘¡è¯¥äº‹å®å¦‚ä½•ç¬¦åˆæ³•æ¡è§„å®šçš„æ„æˆè¦ä»¶ï¼ˆè¦ç´ å¯¹åº”ï¼‰â‘¢ä¸ºä»€ä¹ˆå¾—å‡ºè¿™ä¸ªç»“è®ºï¼ˆæ¨ç†é€»è¾‘ï¼‰ã€‚ç¤ºä¾‹ï¼šè¢«å‘ŠææŸåœ¨æ”¶åˆ°åŸå‘Šå¼ æŸæ”¯ä»˜çš„é¦–ä»˜æ¬¾50ä¸‡å…ƒåï¼Œæ˜ç¡®è¡¨ç¤ºæ‹’ç»é…åˆåŠç†æˆ¿å±‹è¿‡æˆ·æ‰‹ç»­ï¼Œè¯¥è¡Œä¸ºæ„æˆäº†'ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡'ï¼Œç¬¦åˆã€Šæ°‘æ³•å…¸ã€‹ç¬¬577æ¡è§„å®šçš„è¿çº¦æƒ…å½¢ï¼Œä¾æ³•åº”æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»",
      "conclusion": "ç»“è®ºï¼šå¾—å‡ºçš„å…·ä½“æ³•å¾‹ç»“è®ºï¼Œå¿…é¡»æ˜ç¡®æ³•å¾‹åæœã€‚ç¤ºä¾‹ï¼šè¢«å‘Šæ„æˆè¿çº¦ï¼Œåº”æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»ï¼Œå³åº”äºæœ¬åˆ¤å†³ç”Ÿæ•ˆä¹‹æ—¥èµ·åæ—¥å†…é…åˆåŸå‘ŠåŠç†æ¶‰æ¡ˆæˆ¿å±‹çš„è¿‡æˆ·ç™»è®°æ‰‹ç»­",
      "supportingEvidence": ["æ”¯æŒè¯¥æ¨ç†çš„å…·ä½“è¯æ®åç§°ï¼Œå¦‚ï¼šã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ã€é¦–ä»˜æ¬¾è½¬è´¦å‡­è¯ã€è¢«å‘Šæ‹’ç»è¿‡æˆ·çš„ä¹¦é¢é€šçŸ¥"]
    }
  ],
  "keyArguments": [
    "æ ¸å¿ƒè®ºç‚¹ï¼ˆä¸å°‘äº30å­—ï¼‰ï¼Œå¿…é¡»åŒ…å«å®Œæ•´çš„è®ºè¯é€»è¾‘ï¼šâ‘ äº‰è®®ç„¦ç‚¹ â‘¡æ³•é™¢è§‚ç‚¹ â‘¢æ³•å¾‹ä¾æ® â‘£ç»“è®ºã€‚ç¤ºä¾‹ï¼šè¢«å‘Šä¸»å¼ å› æˆ¿ä»·ä¸Šæ¶¨æ„æˆæƒ…åŠ¿å˜æ›´åº”å˜æ›´æˆ–è§£é™¤åˆåŒï¼Œä½†æœ¬é™¢è®¤ä¸ºï¼Œæˆ¿ä»·æ­£å¸¸å¸‚åœºæ³¢åŠ¨å±äºå•†ä¸šé£é™©èŒƒç•´ï¼Œä¸ç¬¦åˆã€Šæ°‘æ³•å…¸ã€‹ç¬¬533æ¡è§„å®šçš„æƒ…åŠ¿å˜æ›´'éä¸å¯æŠ—åŠ›ä¸”ä¸å±äºå•†ä¸šé£é™©'çš„æ„æˆè¦ä»¶ï¼Œæ•…å¯¹è¢«å‘Šçš„è¯¥é¡¹æŠ—è¾©ä¸äºˆæ”¯æŒ"
  ],
  "judgment": "æœ€ç»ˆåˆ¤å†³ç»“æœçš„å®Œæ•´è¡¨è¿°ï¼ˆå¿…é¡»åŒ…æ‹¬åˆ¤å†³ä¸»æ–‡çš„å®Œæ•´å†…å®¹ï¼Œå¦‚ï¼šè¢«å‘ŠææŸäºæœ¬åˆ¤å†³ç”Ÿæ•ˆä¹‹æ—¥èµ·åæ—¥å†…é…åˆåŸå‘Šå¼ æŸåŠç†æ¶‰æ¡ˆæˆ¿å±‹çš„è¿‡æˆ·ç™»è®°æ‰‹ç»­ï¼‰",
  "dissenting": "å°‘æ•°æ„è§ï¼ˆå¦‚æœ‰ï¼Œæ°‘äº‹æ¡ˆä»¶ä¸€èˆ¬æ²¡æœ‰ï¼Œåˆ‘äº‹æ¡ˆä»¶å¯èƒ½æœ‰ï¼‰"
}

# æå–ç¤ºä¾‹ï¼ˆé«˜è´¨é‡å‚è€ƒæ ‡å‡†ï¼‰
å‡è®¾åˆ¤å†³ä¹¦å†™ï¼š"æœ¬é™¢è®¤ä¸ºï¼ŒåŸè¢«å‘Šç­¾è®¢çš„ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ç³»åŒæ–¹çœŸå®æ„æ€è¡¨ç¤ºï¼Œå†…å®¹ä¸è¿åæ³•å¾‹ã€è¡Œæ”¿æ³•è§„çš„å¼ºåˆ¶æ€§è§„å®šï¼Œåº”å±æœ‰æ•ˆã€‚åŸå‘Šå·²æŒ‰çº¦å®šæ”¯ä»˜é¦–ä»˜æ¬¾50ä¸‡å…ƒï¼Œå±¥è¡Œäº†åˆåŒçº¦å®šçš„ä»˜æ¬¾ä¹‰åŠ¡ï¼Œè¢«å‘Šåº”ç›¸åº”å±¥è¡Œé…åˆåŠç†è¿‡æˆ·ç™»è®°çš„ä¹‰åŠ¡ã€‚è¢«å‘Šä»¥æˆ¿ä»·ä¸Šæ¶¨ä¸ºç”±æ‹’ç»å±¥è¡Œï¼Œä¸æ„æˆæ³•å®šçš„å…è´£äº‹ç”±ã€‚ä¾ç…§ã€Šä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸ã€‹ç¬¬äº”ç™¾é›¶ä¹æ¡ã€ç¬¬äº”ç™¾ä¸ƒåä¸ƒæ¡ä¹‹è§„å®šï¼Œåˆ¤å†³å¦‚ä¸‹ï¼šè¢«å‘ŠææŸäºæœ¬åˆ¤å†³ç”Ÿæ•ˆä¹‹æ—¥èµ·åæ—¥å†…é…åˆåŸå‘Šå¼ æŸåŠç†æ¶‰æ¡ˆæˆ¿å±‹çš„è¿‡æˆ·ç™»è®°æ‰‹ç»­ã€‚"

**ä½ åº”è¯¥æå–ä¸ºï¼ˆé«˜è´¨é‡ç¤ºä¾‹ï¼‰**ï¼š
{
  "summary": "æœ¬é™¢è®¤å®šåŸè¢«å‘Šç­¾è®¢çš„æˆ¿å±‹ä¹°å–åˆåŒç³»åŒæ–¹çœŸå®æ„æ€è¡¨ç¤ºä¸”åˆæ³•æœ‰æ•ˆã€‚åŸå‘Šå·²å±¥è¡Œä»˜æ¬¾ä¹‰åŠ¡ï¼Œè¢«å‘Šåº”å±¥è¡Œè¿‡æˆ·ä¹‰åŠ¡ã€‚è¢«å‘Šä»¥æˆ¿ä»·ä¸Šæ¶¨æ‹’ç»å±¥è¡Œä¸æ„æˆå…è´£äº‹ç”±ã€‚ä¾æ®ã€Šæ°‘æ³•å…¸ã€‹ç¬¬509æ¡ï¼ˆå…¨é¢å±¥è¡Œä¹‰åŠ¡ï¼‰å’Œç¬¬577æ¡ï¼ˆè¿çº¦è´£ä»»ï¼‰ï¼Œåˆ¤å†³è¢«å‘Šæ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»ï¼Œé…åˆåŠç†è¿‡æˆ·ç™»è®°æ‰‹ç»­ã€‚",
  "legalBasis": [
    {
      "law": "ä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸",
      "article": "ç¬¬509æ¡",
      "content": "å½“äº‹äººåº”å½“æŒ‰ç…§çº¦å®šå…¨é¢å±¥è¡Œè‡ªå·±çš„ä¹‰åŠ¡ã€‚",
      "source": "AIè¡¥å……",
      "application": "åŸå‘Šå¼ æŸä¸è¢«å‘ŠææŸç­¾è®¢çš„ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ç³»åŒæ–¹çœŸå®æ„æ€è¡¨ç¤ºä¸”åˆæ³•æœ‰æ•ˆï¼ˆäº‹å®è®¤å®šï¼‰ï¼Œæ ¹æ®è¯¥æ¡è§„å®šï¼ŒåŒæ–¹åº”å½“æŒ‰ç…§åˆåŒçº¦å®šå…¨é¢å±¥è¡Œå„è‡ªçš„ä¹‰åŠ¡ï¼ˆæ³•å¾‹è¦ä»¶ï¼‰ï¼Œå³åŸå‘Šè´Ÿæœ‰ä»˜æ¬¾ä¹‰åŠ¡ï¼Œè¢«å‘Šè´Ÿæœ‰é…åˆåŠç†è¿‡æˆ·çš„ä¹‰åŠ¡ï¼ˆæ³•å¾‹æ•ˆæœï¼‰",
      "interpretation": "æ³•å®˜å¼ºè°ƒåˆåŒæœ‰æ•ˆå³åŒæ–¹å‡è´Ÿæœ‰å…¨é¢å±¥è¡Œä¹‰åŠ¡"
    },
    {
      "law": "ä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸",
      "article": "ç¬¬577æ¡",
      "content": "å½“äº‹äººä¸€æ–¹ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡æˆ–è€…å±¥è¡ŒåˆåŒä¹‰åŠ¡ä¸ç¬¦åˆçº¦å®šçš„ï¼Œåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œã€é‡‡å–è¡¥æ•‘æªæ–½æˆ–è€…èµ”å¿æŸå¤±ç­‰è¿çº¦è´£ä»»ã€‚",
      "source": "AIè¡¥å……",
      "application": "è¢«å‘ŠææŸåœ¨æ”¶åˆ°åŸå‘Šæ”¯ä»˜çš„é¦–ä»˜æ¬¾50ä¸‡å…ƒåï¼Œä»¥æˆ¿ä»·ä¸Šæ¶¨ä¸ºç”±æ‹’ç»é…åˆåŠç†æˆ¿å±‹è¿‡æˆ·ç™»è®°æ‰‹ç»­ï¼ˆäº‹å®ï¼‰ï¼Œè¯¥è¡Œä¸ºæ„æˆäº†'ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡'çš„æƒ…å½¢ï¼Œä¸”ä¸å±äºæ³•å®šå…è´£äº‹ç”±ï¼ˆç¬¦åˆæ³•æ¡è¦ä»¶ï¼‰ï¼Œæ ¹æ®è¯¥æ¡è§„å®šï¼Œè¢«å‘Šåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»ï¼Œå³åº”äºæœ¬åˆ¤å†³ç”Ÿæ•ˆä¹‹æ—¥èµ·åæ—¥å†…é…åˆåŸå‘ŠåŠç†æ¶‰æ¡ˆæˆ¿å±‹çš„è¿‡æˆ·ç™»è®°æ‰‹ç»­ï¼ˆæ³•å¾‹æ•ˆæœï¼‰"
    }
  ],
  "logicChain": [
    {
      "premise": "ã€Šä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸ã€‹ç¬¬509æ¡è§„å®šï¼šå½“äº‹äººåº”å½“æŒ‰ç…§çº¦å®šå…¨é¢å±¥è¡Œè‡ªå·±çš„ä¹‰åŠ¡",
      "inference": "åŸè¢«å‘Šç­¾è®¢çš„ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ç³»åŒæ–¹çœŸå®æ„æ€è¡¨ç¤ºï¼Œå†…å®¹ä¸è¿åæ³•å¾‹ã€è¡Œæ”¿æ³•è§„çš„å¼ºåˆ¶æ€§è§„å®šï¼Œåº”å±æœ‰æ•ˆã€‚æ—¢ç„¶åˆåŒæœ‰æ•ˆï¼ŒåŒæ–¹å°±åº”å½“æŒ‰ç…§åˆåŒçº¦å®šå…¨é¢å±¥è¡Œå„è‡ªçš„ä¹‰åŠ¡ã€‚æœ¬æ¡ˆä¸­ï¼ŒåŸå‘Šå·²æŒ‰çº¦å®šæ”¯ä»˜é¦–ä»˜æ¬¾50ä¸‡å…ƒï¼Œå±¥è¡Œäº†ä»˜æ¬¾ä¹‰åŠ¡ï¼›è¢«å‘Šåˆ™åº”å±¥è¡Œé…åˆåŠç†è¿‡æˆ·ç™»è®°çš„ä¹‰åŠ¡",
      "conclusion": "åˆåŒå…³ç³»æˆç«‹ä¸”æœ‰æ•ˆï¼ŒåŒæ–¹è´Ÿæœ‰å…¨é¢å±¥è¡ŒåˆåŒçº¦å®šä¹‰åŠ¡çš„æ³•å¾‹ä¹‰åŠ¡",
      "supportingEvidence": ["ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹", "é¦–ä»˜æ¬¾è½¬è´¦å‡­è¯"]
    },
    {
      "premise": "ã€Šä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸ã€‹ç¬¬577æ¡è§„å®šï¼šå½“äº‹äººä¸€æ–¹ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡æˆ–è€…å±¥è¡ŒåˆåŒä¹‰åŠ¡ä¸ç¬¦åˆçº¦å®šçš„ï¼Œåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œã€é‡‡å–è¡¥æ•‘æªæ–½æˆ–è€…èµ”å¿æŸå¤±ç­‰è¿çº¦è´£ä»»",
      "inference": "è¢«å‘ŠææŸåœ¨æ”¶åˆ°åŸå‘Šæ”¯ä»˜çš„é¦–ä»˜æ¬¾50ä¸‡å…ƒåï¼Œæ˜ç¡®è¡¨ç¤ºä»¥æˆ¿ä»·ä¸Šæ¶¨ä¸ºç”±æ‹’ç»é…åˆåŠç†æˆ¿å±‹è¿‡æˆ·ç™»è®°æ‰‹ç»­ã€‚è¯¥è¡Œä¸ºæ„æˆäº†'ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡'çš„æƒ…å½¢ï¼Œç¬¦åˆã€Šæ°‘æ³•å…¸ã€‹ç¬¬577æ¡è§„å®šçš„è¿çº¦æƒ…å½¢ã€‚è¢«å‘Šä¸»å¼ çš„æˆ¿ä»·ä¸Šæ¶¨å±äºæ­£å¸¸å¸‚åœºæ³¢åŠ¨ï¼Œå±äºå•†ä¸šé£é™©èŒƒç•´ï¼Œä¸æ„æˆæ³•å®šçš„å…è´£äº‹ç”±ã€‚å› æ­¤ï¼Œè¢«å‘Šåº”ä¾æ³•æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»",
      "conclusion": "è¢«å‘Šæ„æˆè¿çº¦ï¼Œåº”æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»ï¼Œå³åº”äºæœ¬åˆ¤å†³ç”Ÿæ•ˆä¹‹æ—¥èµ·åæ—¥å†…é…åˆåŸå‘ŠåŠç†æ¶‰æ¡ˆæˆ¿å±‹çš„è¿‡æˆ·ç™»è®°æ‰‹ç»­",
      "supportingEvidence": ["è¢«å‘Šæ‹’ç»è¿‡æˆ·çš„é™ˆè¿°", "æˆ¿ä»·å˜åŠ¨æƒ…å†µ", "ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹çº¦å®šçš„è¿‡æˆ·ä¹‰åŠ¡"]
    }
  ],
  "keyArguments": [
    "åˆåŒæœ‰æ•ˆæ€§è®¤å®šï¼šåŸè¢«å‘Šç­¾è®¢çš„ã€Šæˆ¿å±‹ä¹°å–åˆåŒã€‹ç³»åŒæ–¹çœŸå®æ„æ€è¡¨ç¤ºï¼Œå†…å®¹ä¸è¿åæ³•å¾‹ã€è¡Œæ”¿æ³•è§„çš„å¼ºåˆ¶æ€§è§„å®šï¼Œä¾æ³•åº”è®¤å®šä¸ºæœ‰æ•ˆåˆåŒ",
    "ä¹‰åŠ¡å±¥è¡Œè®¤å®šï¼šåŸå‘Šå·²æŒ‰çº¦å®šæ”¯ä»˜é¦–ä»˜æ¬¾50ä¸‡å…ƒï¼Œå±¥è¡Œäº†åˆåŒçº¦å®šçš„ä»˜æ¬¾ä¹‰åŠ¡ï¼›è¢«å‘Šåº”ç›¸åº”å±¥è¡Œé…åˆåŠç†è¿‡æˆ·ç™»è®°çš„å¯¹å¾…ç»™ä»˜ä¹‰åŠ¡",
    "è¿çº¦è´£ä»»è®¤å®šï¼šè¢«å‘Šä»¥æˆ¿ä»·ä¸Šæ¶¨ä¸ºç”±æ‹’ç»å±¥è¡ŒåˆåŒä¹‰åŠ¡ï¼Œä¸æ„æˆæ³•å®šçš„å…è´£äº‹ç”±ã€‚æˆ¿ä»·æ­£å¸¸å¸‚åœºæ³¢åŠ¨å±äºå•†ä¸šé£é™©èŒƒç•´ï¼Œä¸ç¬¦åˆã€Šæ°‘æ³•å…¸ã€‹ç¬¬533æ¡è§„å®šçš„æƒ…åŠ¿å˜æ›´æ„æˆè¦ä»¶ã€‚è¢«å‘Šæ‹’ç»å±¥è¡Œæ„æˆè¿çº¦ï¼Œåº”æ‰¿æ‹…ç»§ç»­å±¥è¡Œçš„è¿çº¦è´£ä»»"
  ],
  "judgment": "è¢«å‘ŠææŸäºæœ¬åˆ¤å†³ç”Ÿæ•ˆä¹‹æ—¥èµ·åæ—¥å†…é…åˆåŸå‘Šå¼ æŸåŠç†æ¶‰æ¡ˆæˆ¿å±‹çš„è¿‡æˆ·ç™»è®°æ‰‹ç»­"
}

# åˆ¤å†³ä¹¦"æœ¬é™¢è®¤ä¸º"éƒ¨åˆ†
${reasoningSection}`;

    try {
      const response = await this.callDeepSeekAPI(prompt);

      // ğŸ” å¢å¼ºæ—¥å¿—ï¼šè®°å½•AIåŸå§‹è¿”å›
      console.log('ğŸ” [extractReasoning] AIåŸå§‹è¿”å›:', {
        hasResponse: !!response,
        responseType: typeof response,
        hasLogicChain: Array.isArray(response?.logicChain),
        logicChainLength: response?.logicChain?.length || 0,
        hasKeyArguments: Array.isArray(response?.keyArguments),
        keyArgumentsLength: response?.keyArguments?.length || 0,
        hasLegalBasis: Array.isArray(response?.legalBasis),
        legalBasisLength: response?.legalBasis?.length || 0,
      });

      const reasoning = this.parseReasoningResponse(response);

      // ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
      const isComplete = reasoning.logicChain.length > 0 && reasoning.keyArguments.length > 0;
      if (!isComplete) {
        console.warn('âš ï¸ [extractReasoning] AIè¿”å›æ•°æ®ä¸å®Œæ•´ï¼', {
          logicChainCount: reasoning.logicChain.length,
          keyArgumentsCount: reasoning.keyArguments.length,
          legalBasisCount: reasoning.legalBasis.length,
        });
        console.warn('âš ï¸ å»ºè®®æ£€æŸ¥ï¼š1) AIæœåŠ¡æ˜¯å¦æ­£å¸¸ 2) æ–‡æ¡£è´¨é‡ 3) Promptæ˜¯å¦è¿‡äºå¤æ‚');
      } else {
        console.log('âœ… [extractReasoning] AIè¿”å›æ•°æ®å®Œæ•´', {
          logicChainCount: reasoning.logicChain.length,
          keyArgumentsCount: reasoning.keyArguments.length,
        });
      }

      return reasoning;
    } catch (error) {
      logger.error('æå–è£åˆ¤ç†ç”±å¤±è´¥', error);
      return this.createFailedReasoning('è°ƒç”¨ AI æœåŠ¡æå–è£åˆ¤ç†ç”±å¤±è´¥');
    }
  }

  /**
   * è°ƒç”¨DeepSeek API
   */
  private async callDeepSeekAPI(prompt: string): Promise<any> {
    try {
      logger.info('è°ƒç”¨DeepSeek API (é€šè¿‡DeeChatAIClient)...');

      // ğŸ”§ ä½¿ç”¨å·²ä¿®å¤çš„DeeChatAIClientï¼ˆå†…éƒ¨ä½¿ç”¨keepalive: falseçš„HttpClientï¼‰
      const response = await this.aiClient.sendCustomMessage([
        {
          role: 'system',
          content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¸­å›½æ³•å¾‹æ–‡ä¹¦åˆ†æä¸“å®¶ï¼Œç²¾é€šåˆ¤å†³ä¹¦åˆ†æã€‚è¯·å§‹ç»ˆä»¥JSONæ ¼å¼è¿”å›ç»“æœã€‚'
        },
        {
          role: 'user',
          content: prompt
        }
      ], {
        temperature: this.temperature,
        maxTokens: this.maxTokens
      });

      const content = response.content;

      if (!content) {
        throw new Error('DeepSeekè¿”å›å†…å®¹ä¸ºç©º');
      }

      // å¤„ç†DeepSeekè¿”å›çš„markdownä»£ç å—æ ¼å¼
      let jsonContent = content;
      if (content.includes('```json')) {
        const match = content.match(/```json\n([\s\S]*?)\n```/);
        if (match && match[1]) {
          jsonContent = match[1];
        }
      }

      return JSON.parse(jsonContent);

    } catch (error) {
      logger.error('è°ƒç”¨DeepSeek APIå¤±è´¥', error);
      throw error;
    }
  }

  /**
   * è§£æåŸºæœ¬ä¿¡æ¯å“åº”
   */
  private parseBasicInfoResponse(response: any): BasicInfo {
    if (!response || typeof response === 'string') {
      return this.getDefaultBasicInfo();
    }

    return {
      caseNumber: response.caseNumber || '',
      court: response.court || '',
      judgeDate: response.judgeDate || new Date().toISOString().split('T')[0],
      caseType: response.caseType as 'æ°‘äº‹' | 'åˆ‘äº‹' | 'è¡Œæ”¿' | 'æ‰§è¡Œ' | undefined,
      judge: Array.isArray(response.judge) ? response.judge : [],
      clerk: response.clerk,
      parties: {
        plaintiff: Array.isArray(response.parties?.plaintiff) ? response.parties.plaintiff.map((p: any) => ({
          name: p.name || '',
          type: p.type as 'è‡ªç„¶äºº' | 'æ³•äºº' | 'å…¶ä»–ç»„ç»‡' | undefined,
          legalRepresentative: p.legalRepresentative,
          attorney: Array.isArray(p.attorney) ? p.attorney : []
        })) : [],
        defendant: Array.isArray(response.parties?.defendant) ? response.parties.defendant.map((d: any) => ({
          name: d.name || '',
          type: d.type as 'è‡ªç„¶äºº' | 'æ³•äºº' | 'å…¶ä»–ç»„ç»‡' | undefined,
          legalRepresentative: d.legalRepresentative,
          attorney: Array.isArray(d.attorney) ? d.attorney : []
        })) : [],
        thirdParty: Array.isArray(response.parties?.thirdParty) ? response.parties.thirdParty : []
      }
    };
  }

  /**
   * è§£æäº‹å®å“åº”
   */
  private parseFactsResponse(response: any): Facts {
    logger.info('è§£æäº‹å®å“åº”', { type: typeof response });

    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æJSON
    if (typeof response === 'string') {
      try {
        response = JSON.parse(response);
      } catch (e) {
        logger.error('è§£æJSONå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        return this.createFailedFacts('AI è¿”å›å†…å®¹æ— æ³•è§£æä¸º JSON');
      }
    }

    if (!response) {
      logger.error('å“åº”ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼');
      return this.createFailedFacts('AI æœªè¿”å›äº‹å®å†…å®¹');
    }

    const summary =
      typeof response.summary === 'string' && response.summary.trim().length > 0
        ? response.summary.trim()
        : 'æå–å¤±è´¥ï¼šAI æœªèƒ½æä¾›äº‹å®æ‘˜è¦';

    const facts: Facts = {
      summary,
      timeline: Array.isArray(response.timeline) ? response.timeline.map((t: any) => ({
        date: t.date || '',
        event: t.event || '',
        importance: t.importance as 'critical' | 'important' | 'normal' || 'normal',
        actors: Array.isArray(t.actors) ? t.actors : [],
        location: t.location,
        relatedEvidence: Array.isArray(t.relatedEvidence) ? t.relatedEvidence : []
      })) : [],
      keyFacts: Array.isArray(response.keyFacts) ? response.keyFacts : [],
      disputedFacts: Array.isArray(response.disputedFacts) ? response.disputedFacts : [],
      undisputedFacts: Array.isArray(response.undisputedFacts) ? response.undisputedFacts : []
    };

    if (facts.timeline.length === 0) {
      logger.warn('AI æœªç”Ÿæˆäº‹å®æ—¶é—´çº¿');
    }

    logger.info('äº‹å®è§£æå®Œæˆ');
    return facts;
  }

  /**
   * è§£æè¯æ®å“åº”
   */
  private parseEvidenceResponse(response: any): Evidence {
    logger.info('è§£æè¯æ®å“åº”', { type: typeof response });

    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æJSON
    if (typeof response === 'string') {
      try {
        response = JSON.parse(response);
      } catch (e) {
        logger.error('è§£æJSONå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        return this.createFailedEvidence('AI è¿”å›å†…å®¹æ— æ³•è§£æä¸º JSON');
      }
    }

    if (!response) {
      logger.error('å“åº”ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼');
      return this.createFailedEvidence('AI æœªè¿”å›è¯æ®ä¿¡æ¯');
    }

    const summary =
      typeof response.summary === 'string' && response.summary.trim().length > 0
        ? response.summary.trim()
        : 'æå–å¤±è´¥ï¼šAI æœªèƒ½æä¾›è¯æ®æ‘˜è¦';

    const evidence: Evidence = {
      summary,
      items: Array.isArray(response.items) ? response.items.map((item: any) => ({
        id: item.id,
        name: item.name || 'æœªçŸ¥è¯æ®',
        type: item.type as any || 'ä¹¦è¯',
        submittedBy: item.submittedBy as any || 'åŸå‘Š',
        description: item.description,
        credibilityScore: item.credibilityScore || 50,
        relevanceScore: item.relevanceScore || 50,
        accepted: item.accepted !== false,
        courtOpinion: item.courtOpinion,
        relatedFacts: Array.isArray(item.relatedFacts) ? item.relatedFacts : []
      })) : [],
      chainAnalysis: {
        complete: response.chainAnalysis?.complete ?? false,
        missingLinks: Array.isArray(response.chainAnalysis?.missingLinks)
          ? response.chainAnalysis.missingLinks
          : ['AI æœªç»™å‡ºè¯æ®é“¾åˆ†æ'],
        strength: (response.chainAnalysis?.strength as any) || 'weak',
        analysis: response.chainAnalysis?.analysis
      },
      crossExamination: response.crossExamination
    };

    if (evidence.items.length === 0) {
      logger.warn('AI æœªç”Ÿæˆè¯æ®åˆ—è¡¨');
    }

    logger.info('è¯æ®è§£æå®Œæˆ');
    return evidence;
  }

  /**
   * è§£æè£åˆ¤ç†ç”±å“åº”
   */
  private parseReasoningResponse(response: any): Reasoning {
    logger.info('è§£æè£åˆ¤ç†ç”±å“åº”', { type: typeof response });

    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æJSON
    if (typeof response === 'string') {
      try {
        response = JSON.parse(response);
      } catch (e) {
        logger.error('è§£æJSONå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        return this.createFailedReasoning('AI è¿”å›å†…å®¹æ— æ³•è§£æä¸º JSON');
      }
    }

    if (!response) {
      logger.error('å“åº”ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼');
      return this.createFailedReasoning('AI æœªè¿”å›è£åˆ¤ç†ç”±');
    }

    const summary =
      typeof response.summary === 'string' && response.summary.trim().length > 0
        ? response.summary.trim()
        : 'æå–å¤±è´¥ï¼šAI æœªèƒ½æä¾›è£åˆ¤ç†ç”±æ‘˜è¦';

    const reasoning: Reasoning = {
      summary,
      legalBasis: Array.isArray(response.legalBasis) ? response.legalBasis.map((lb: any) => ({
        law: lb.law || '',
        article: lb.article || '',
        clause: lb.clause,
        application: lb.application || '',
        interpretation: lb.interpretation
      })) : [],
      logicChain: Array.isArray(response.logicChain) ? response.logicChain.map((lc: any) => ({
        premise: lc.premise || '',
        inference: lc.inference || '',
        conclusion: lc.conclusion || '',
        supportingEvidence: Array.isArray(lc.supportingEvidence) ? lc.supportingEvidence : []
      })) : [],
      keyArguments: Array.isArray(response.keyArguments) ? response.keyArguments : [],
      judgment: response.judgment || 'æå–å¤±è´¥ï¼šæœªè¯†åˆ«è£åˆ¤ä¸»æ–‡',
      dissenting: response.dissenting
    };

    logger.info('è£åˆ¤ç†ç”±è§£æå®Œæˆ');
    return reasoning;
  }

  /**
   * é»˜è®¤åŸºæœ¬ä¿¡æ¯ç»“æ„
   */
  private getDefaultBasicInfo(): BasicInfo {
    return {
      caseNumber: '',
      court: '',
      judgeDate: new Date().toISOString().split('T')[0] || '',
      parties: {
        plaintiff: [],
        defendant: []
      }
    };
  }

  /**
   * é»˜è®¤äº‹å®ç»“æ„
   */
  private createFailedFacts(reason: string): Facts {
    return {
      summary: `æå–å¤±è´¥ï¼š${reason}`,
      timeline: [],
      keyFacts: [],
      disputedFacts: [],
      undisputedFacts: []
    };
  }

  /**
   * é»˜è®¤è¯æ®ç»“æ„
   */
  private createFailedEvidence(reason: string): Evidence {
    return {
      summary: `æå–å¤±è´¥ï¼š${reason}`,
      items: [],
      chainAnalysis: {
        complete: false,
        missingLinks: [reason],
        strength: 'weak',
        analysis: undefined
      },
      crossExamination: undefined
    };
  }

  /**
   * é»˜è®¤è£åˆ¤ç†ç”±ç»“æ„
   */
  private createFailedReasoning(reason: string): Reasoning {
    return {
      summary: `æå–å¤±è´¥ï¼š${reason}`,
      legalBasis: [],
      logicChain: [],
      keyArguments: [],
      judgment: `æå–å¤±è´¥ï¼š${reason}`,
      dissenting: undefined
    };
  }

}

/**
 * å¯¼å‡ºé»˜è®¤å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
 */
let _judgmentExtractionService: JudgmentExtractionService;

export const judgmentExtractionService = {
  get instance() {
    if (!_judgmentExtractionService) {
      _judgmentExtractionService = new JudgmentExtractionService();
    }
    return _judgmentExtractionService;
  }
};
