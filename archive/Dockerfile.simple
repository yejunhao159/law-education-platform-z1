# =============================================================================
# æ³•å­¦æ•™è‚²å¹³å° - Docker æç®€éƒ¨ç½²é•œåƒï¼ˆæ–¹æ¡ˆCï¼‰
# =============================================================================
#
# æ¶æ„è®¾è®¡ï¼ˆæ–¹æ¡ˆC - æç®€æ¶æ„ï¼‰ï¼š
# - ç§»é™¤PM2ï¼Œä½¿ç”¨DockeråŸç”Ÿè¿›ç¨‹ç®¡ç†
# - Next.js + Socket.IO è¿è¡Œåœ¨åŒä¸€ä¸ªNode.jsè¿›ç¨‹ä¸­
# - ç¬¦åˆDockeræœ€ä½³å®è·µï¼š"ä¸€å®¹å™¨ä¸€è¿›ç¨‹"
#
# ä¼˜åŠ¿ï¼š
# - âœ… ç®€å•ï¼šæ²¡æœ‰PM2æƒé™é—®é¢˜
# - âœ… å¯é ï¼šDockerè´Ÿè´£è¿›ç¨‹ç›‘æ§å’Œé‡å¯
# - âœ… é«˜æ•ˆï¼šå‡å°‘ä¸€å±‚è¿›ç¨‹ç®¡ç†å¼€é”€
# - âœ… æ˜“ç»´æŠ¤ï¼šæ—¥å¿—ç»Ÿä¸€ï¼Œè°ƒè¯•ç®€å•
#
# =============================================================================

FROM node:20

WORKDIR /app

# =============================================================================
# æ¥æ”¶æ„å»ºå‚æ•°
# =============================================================================
ARG DEEPSEEK_API_KEY=""
ARG NEXT_PUBLIC_AI_302_API_KEY=""
ARG NEXT_PUBLIC_BASE_URL="http://localhost:3000"
ARG NEXT_PUBLIC_SOCKET_IO_URL="http://localhost:3000"

# =============================================================================
# æ„å»ºé˜¶æ®µ
# =============================================================================

# å®‰è£…ä¾èµ–
COPY package.json package-lock.json ./
RUN npm ci --legacy-peer-deps || npm ci --legacy-peer-deps --no-optional

# å¤åˆ¶æºä»£ç 
COPY . .

# è®¾ç½®ç¯å¢ƒå˜é‡å¹¶æ„å»º
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
ENV NEXT_PUBLIC_AI_302_API_KEY=${NEXT_PUBLIC_AI_302_API_KEY}
ENV NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL}
ENV NEXT_PUBLIC_SOCKET_IO_URL=${NEXT_PUBLIC_SOCKET_IO_URL}

# æ„å»º Next.js åº”ç”¨
RUN npm run build

# =============================================================================
# ç”Ÿäº§è¿è¡Œç¯å¢ƒå‡†å¤‡
# =============================================================================

# æ¸…ç†æ„å»ºä¾èµ–ï¼ˆä¿ç•™ç”Ÿäº§ä¾èµ–ï¼‰
# è·³è¿‡prepareè„šæœ¬ï¼ˆhusky installä¸éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼‰
RUN npm ci --only=production --legacy-peer-deps --omit=dev --ignore-scripts || \
    npm ci --only=production --legacy-peer-deps --omit=dev --no-optional --ignore-scripts

# åˆ›å»ºé root ç”¨æˆ·
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && addgroup --system --gid 1001 nodejs \
    && adduser --system --uid 1001 nextjs

# =============================================================================
# ç§»é™¤PM2 - ä½¿ç”¨ç»Ÿä¸€å¯åŠ¨è„šæœ¬
# =============================================================================
# ä¸å†éœ€è¦ï¼š
# - PM2å®‰è£…
# - PM2é…ç½®æ–‡ä»¶
# - PM2ç›®å½•åˆ›å»º
# - PM2æƒé™è®¾ç½®

# å¤åˆ¶ç¯å¢ƒå˜é‡è„šæœ¬
COPY scripts/generate-env.sh ./scripts/generate-env.sh
COPY scripts/check-env.sh ./scripts/check-env.sh
RUN chmod +x ./scripts/generate-env.sh ./scripts/check-env.sh

# å¤åˆ¶ç»Ÿä¸€å¯åŠ¨è„šæœ¬
COPY server/index.js ./server/index.js

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/logs /app/data && chown -R nextjs:nodejs /app

# ä¿®å¤æƒé™
RUN chown -R nextjs:nodejs /app

# ğŸ¯ æ¸¸å®¢æ¨¡å¼ï¼šè·³è¿‡ç™»å½•éªŒè¯ï¼ˆä¸´æ—¶è°ƒè¯•ç”¨ï¼‰
ENV GUEST_MODE=true

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nextjs

# =============================================================================
# æš´éœ²ç«¯å£å’Œå¥åº·æ£€æŸ¥
# =============================================================================
EXPOSE 3000 3001

HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })\" || exit 1

# =============================================================================
# å¯åŠ¨å‘½ä»¤ - æç®€å¯åŠ¨æµç¨‹
# =============================================================================
# æµç¨‹ï¼š
# 1. generate-env.sh   â†’ è¿è¡Œæ—¶ç”Ÿæˆ.env.production
# 2. check-env.sh      â†’ éªŒè¯å¿…è¦çš„APIå¯†é’¥
# 3. node server/index.js â†’ å¯åŠ¨Next.jsï¼ˆ3000ï¼‰+ Socket.IOï¼ˆ3001ï¼‰
#
# ä¼˜åŠ¿ï¼š
# - âœ… ç§»é™¤PM2ä¾èµ–ï¼Œå®Œå…¨ç®€åŒ–æ¶æ„
# - âœ… Dockerè‡ªå¸¦è¿›ç¨‹ç®¡ç†å’Œé‡å¯æœºåˆ¶
# - âœ… ç¬¦åˆNext.jså®˜æ–¹æœ€ä½³å®è·µ
# - âœ… ç»Ÿä¸€æ—¥å¿—è¾“å‡ºï¼ˆdocker logsï¼‰
# - âœ… æ˜“äºè°ƒè¯•å’Œç»´æŠ¤
# =============================================================================

CMD ./scripts/generate-env.sh && \
    ./scripts/check-env.sh && \
    node server/index.js
