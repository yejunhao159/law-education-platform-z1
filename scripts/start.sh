#!/bin/sh
# =============================================================================
# 法学教育平台 - 生产环境启动脚本（方案A：PM2管理Socket.IO）
# =============================================================================

set -e  # 遇到错误立即退出

echo "╔════════════════════════════════════════════════════════════╗"
echo "║  🚀 法学教育平台启动程序 (方案A)                         ║"
echo "╚════════════════════════════════════════════════════════════╝"

# =============================================================================
# Step 1: 生成运行时环境变量
# =============================================================================
echo ""
echo "📝 [1/4] 生成运行时环境变量..."
./scripts/generate-env.sh
echo "✓ 环境变量生成完成"

# =============================================================================
# Step 2: 验证环境变量
# =============================================================================
echo ""
echo "🔍 [2/4] 验证环境变量..."
./scripts/check-env.sh
echo "✓ 环境变量验证完成"

# =============================================================================
# Step 3: 启动Socket.IO服务（PM2管理）
# =============================================================================
echo ""
echo "📡 [3/4] 启动Socket.IO服务器（PM2守护进程）..."

# 启动PM2管理的Socket.IO服务
pm2 start ecosystem.config.js --no-daemon &
PM2_PID=$!

# 等待PM2和Socket.IO完全启动
echo "   等待Socket.IO服务启动..."
sleep 3

# 验证Socket.IO是否正常运行
pm2 list

echo "✓ Socket.IO已启动并由PM2守护（端口3001）"

# =============================================================================
# Step 4: 启动Next.js应用（标准方式）
# =============================================================================
echo ""
echo "🌐 [4/4] 启动Next.js应用（端口3000）..."
echo "----------------------------------------"
echo ""

# 使用Next.js官方推荐的生产启动方式
# exec确保Next.js成为PID 1，容器能正确响应信号
exec npm start

# =============================================================================
# 架构说明（方案A）：
#
# 进程管理职责分离：
# - PM2负责：Socket.IO的自动重启和日志管理
# - Docker负责：Next.js的进程监控和容器重启
#
# 启动流程：
# 1. 生成.env.production（运行时环境变量）
# 2. 验证API密钥
# 3. PM2启动Socket.IO（后台守护，自动重启）
# 4. npm start启动Next.js（前台运行，容器主进程）
#
# 故障恢复：
# - Socket.IO崩溃 → PM2自动重启
# - Next.js崩溃 → 容器退出 → Docker重启容器
# =============================================================================
