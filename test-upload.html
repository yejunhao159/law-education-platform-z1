<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOCXä¸Šä¼ æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 4px; }
        .log { font-family: monospace; background: #f5f5f5; padding: 10px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>DOCXä¸Šä¼ è°ƒè¯•æµ‹è¯•</h1>
    
    <div class="upload-area">
        <input type="file" id="fileInput" accept=".docx,.pdf,.txt,.md" />
        <p>é€‰æ‹©DOCXã€PDFã€TXTæˆ–MDæ–‡ä»¶è¿›è¡Œæµ‹è¯•</p>
    </div>
    
    <div id="result"></div>
    <div id="log" class="log"></div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }

        // æ¨¡æ‹ŸFileParser.canParse
        function canParse(file) {
            const supportedTypes = ['txt', 'md', 'docx', 'pdf'];
            const fileType = file.name.split('.').pop()?.toLowerCase();
            return supportedTypes.includes(fileType || '');
        }

        // æµ‹è¯•mammothåº“åŠ è½½
        async function testMammoth() {
            try {
                log('æµ‹è¯•mammothåº“åŠ è½½...');
                // åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨CDNç‰ˆæœ¬
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js';
                document.head.appendChild(script);
                
                script.onload = () => {
                    log('âœ… mammothåº“åŠ è½½æˆåŠŸ');
                    if (window.mammoth) {
                        log('âœ… window.mammothå¯ç”¨');
                    }
                };
                
                script.onerror = () => {
                    log('âŒ mammothåº“åŠ è½½å¤±è´¥');
                };
            } catch (error) {
                log(`âŒ mammothåº“æµ‹è¯•é”™è¯¯: ${error.message}`);
            }
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            log(`ğŸ“„ é€‰æ‹©æ–‡ä»¶: ${file.name} (${file.size} bytes)`);
            
            // Step 1: æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const supported = canParse(file);
            log(`ğŸ” æ–‡ä»¶ç±»å‹æ£€æŸ¥: ${supported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`);
            
            if (!supported) {
                showResult('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼', true);
                return;
            }

            // Step 2: æ£€æŸ¥æ–‡ä»¶å¤§å°
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                log(`âŒ æ–‡ä»¶è¿‡å¤§: ${(file.size / 1024 / 1024).toFixed(1)}MB > 10MB`);
                showResult('æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä½¿ç”¨å°äº10MBçš„æ–‡ä»¶', true);
                return;
            }

            log(`âœ… æ–‡ä»¶å¤§å°æ£€æŸ¥é€šè¿‡: ${(file.size / 1024 / 1024).toFixed(1)}MB`);

            // Step 3: å°è¯•è§£ææ–‡ä»¶
            try {
                if (file.name.toLowerCase().endsWith('.docx')) {
                    log('ğŸ”„ å¼€å§‹è§£æDOCXæ–‡ä»¶...');
                    await parseDocxFile(file);
                } else if (file.name.toLowerCase().endsWith('.txt')) {
                    log('ğŸ”„ å¼€å§‹è§£æTXTæ–‡ä»¶...');
                    const text = await file.text();
                    log(`âœ… TXTè§£ææˆåŠŸï¼Œå†…å®¹é•¿åº¦: ${text.length}`);
                    showResult(`TXTæ–‡ä»¶è§£ææˆåŠŸï¼å†…å®¹é•¿åº¦: ${text.length} å­—ç¬¦`);
                } else {
                    log('â„¹ï¸ å…¶ä»–æ ¼å¼æ–‡ä»¶ï¼Œè·³è¿‡è§£ææµ‹è¯•');
                    showResult('æ–‡ä»¶æ ¼å¼æ”¯æŒï¼Œä½†æ­¤æµ‹è¯•é¡µé¢ä»…æµ‹è¯•DOCXå’ŒTXTè§£æ');
                }
            } catch (error) {
                log(`âŒ æ–‡ä»¶è§£æå¤±è´¥: ${error.message}`);
                showResult(`æ–‡ä»¶è§£æå¤±è´¥: ${error.message}`, true);
            }
        });

        async function parseDocxFile(file) {
            return new Promise((resolve, reject) => {
                if (!window.mammoth) {
                    reject(new Error('mammothåº“æœªåŠ è½½'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    log('ğŸ“– æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¼€å§‹æå–æ–‡æœ¬...');
                    
                    window.mammoth.extractRawText({arrayBuffer})
                        .then(function(result) {
                            const text = result.value.trim();
                            log(`âœ… DOCXè§£ææˆåŠŸï¼Œæ–‡æœ¬é•¿åº¦: ${text.length}`);
                            log(`ğŸ“ æ–‡æœ¬é¢„è§ˆ: ${text.substring(0, 100)}...`);
                            
                            if (result.messages && result.messages.length > 0) {
                                log(`âš ï¸ è§£æè­¦å‘Š: ${result.messages.length} æ¡æ¶ˆæ¯`);
                                result.messages.forEach(msg => log(`   - ${msg.message}`));
                            }
                            
                            showResult(`DOCXæ–‡ä»¶è§£ææˆåŠŸï¼æ–‡æœ¬é•¿åº¦: ${text.length} å­—ç¬¦`);
                            resolve(text);
                        })
                        .catch(function(error) {
                            log(`âŒ mammothè§£æå¤±è´¥: ${error.message}`);
                            reject(error);
                        });
                };
                
                reader.onerror = function() {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // é¡µé¢åŠ è½½æ—¶æµ‹è¯•mammoth
        testMammoth();
        log('ğŸš€ DOCXä¸Šä¼ è°ƒè¯•æµ‹è¯•å·²å¯åŠ¨');
    </script>
</body>
</html>